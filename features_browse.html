<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CHAYNUPZINE — Feature</title>
<style>
  :root{
  --ink:#222; --muted:#666; --brand:#111; --chip:#eef1f5;
  /* ▼ 透過カード用の変数（records_browse.html と同値） */
  --panel:rgba(255,255,255,.6);
  --line:#e5e7eb; --link:#2E66CC;
}

/* 背景は透過にして、下の .bg を透かす */
html,body{
  margin:0; background:transparent; color:var(--ink);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  font-size:18px;
}

/* records_browse.html と同じ構成にする（背景色＋背景画像＋明るさ調整） */
.bg{
  position:fixed; inset:0;
  background-color:#f3f5f7;
  /* ここは既存の JS で上書きしているならそのままで OK */
  background-size:cover; background-position:center;
  filter:brightness(.88); z-index:0;
}

/* パネルは半透明＋ブラー。背景の上に重ねるため z-index を 1 に */
.panel{
  position:relative; z-index:1;
  background:var(--panel);
  -webkit-backdrop-filter:saturate(120%) blur(10px);
  backdrop-filter:saturate(120%) blur(10px);
  border-radius:16px;
  /* records と同じ強めの影（透過カードらしく見える） */
  box-shadow:0 10px 28px rgba(0,0,0,.6);
  padding:20px;
}
  .top{display:flex; justify-content:space-between; align-items:center; gap:12px}
  .brand{display:inline-block; background:var(--brand); color:#fff; border-radius:8px; padding:7px 12px; font-weight:800; letter-spacing:.4px}
  /* ▼ 追加：言語ボタンを右上に固定・上下並び */
  .lang{position:fixed; top:10px; right:10px; display:flex; flex-direction:column; gap:8px; z-index:10}
  .lang button{border:1px solid #ddd; background:#fff; color:#111; border-radius:12px; padding:8px 12px; cursor:pointer; font-weight:800}
  .lang button.active{background:#111; color:#fff; border-color:#111}

  .title{font-size:26px; font-weight:800; margin:14px 0 6px}
  .meta{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:12px}
  .chip{background:var(--chip); border-radius:999px; padding:8px 12px; font-weight:700; font-size:14px}
  .author{color:var(--muted); font-size:14px}
  .divider{height:1px; background:var(--line); margin:14px 0}
  .para{padding:10px 0}
  .ptext{white-space:pre-wrap; line-height:1.7}
  .thumbs{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:8px}
  .thumbs img{width:100%; height:180px; object-fit:cover; border-radius:10px; background:#fff}
  @media (max-width:780px){ .thumbs img{height:120px} }
  .yt{position:relative; width:100%; aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden; margin-top:10px}
  .yt iframe{position:absolute; inset:0; width:100%; height:100%; border:0}
  .tools{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:8px}
  .back a{color:var(--link); text-decoration:none; font-weight:700}
  .id{color:#999; font-size:12px}
  .alert{margin:12px 0; padding:12px; border-radius:14px; background:#ffe9e9; color:#a33; border:1px solid #f6bcbc; font-size:16px; display:none}
  .alert.show{display:block}
  .skeleton{animation: pulse 1.1s infinite ease-in-out; background:linear-gradient(90deg,#eee,#f7f7f7,#eee); border-radius:10px}
  @keyframes pulse{0%{background-position:0% 50%}100%{background-position:100% 50%}}
  .sk-title{height:28px; margin:16px 0}
  .sk-line{height:14px; margin:8px 0}

  /* ▼ 追加：本文エリアを単一カラム運用（段落ごとに並べる） */
  .content{display:grid; grid-template-columns:1fr; gap:16px}
  @media(max-width:780px){ .content{grid-template-columns:1fr} }
</style>
</head>
<body>
<div id="bg" class="bg"></div>

<div class="wrap">
  <div class="panel">
    <div class="top">
      <div>
        <span class="brand">CHAYNUPZINE</span>
      </div>
      <!-- ▼ 変更：上下2ボタン -->
      <div class="lang">
        <button id="lang-ja" type="button">JP</button>
        <button id="lang-en" type="button">EN</button>
      </div>
    </div>

    <!-- ▼ 追加：トップへ戻る -->
    <div class="tools" style="margin-top:6px">
      <div class="back"><a id="btn-top" href="https://etramone7-coder.github.io/chaynupzine/">← トップへ戻る</a></div>
      <div></div>
    </div>

    <div id="alert" class="alert"></div>

    <!-- ヘッダー -->
    <div id="head">
      <div class="skeleton sk-title"></div>
      <div class="meta">
        <span class="chip skeleton" style="width:84px;height:30px"></span>
        <span class="chip skeleton" style="width:80px;height:30px"></span>
        <span class="chip skeleton" style="width:100px;height:30px"></span>
        <span class="author skeleton" style="width:160px;height:20px"></span>
      </div>
    </div>

    <div class="divider"></div>

    <!-- ▼ 段落ごとに本文＋メディアを縦に並べる -->
    <div class="content">
      <!-- 使わない左カラムの器は残すが、中身はbodyのみで描画 -->
      <div id="media" style="display:none"></div>
      <div id="body">
        <div class="sk-line skeleton"></div>
        <div class="sk-line skeleton"></div>
        <div class="sk-line skeleton"></div>
      </div>
    </div>

    <div class="divider"></div>

    <div class="tools">
      <div class="back"><a id="backlink" href="#">← Back to Features</a></div>
      <div class="id" id="idhint"></div>
    </div>
  </div>
</div>

<script>
/* ===== 背景：GitHub 配下の固定画像（ご指定の画像） ===== */
document.getElementById('bg').style.backgroundImage =
  'url(https://etramone7-coder.github.io/chaynupzine/assets/feature_browse.webp)';

/* ===== 言語 ===== */
function qs(k){
  var m = location.search.match(new RegExp('[?&]'+k+'=([^&]+)'));
  return m ? decodeURIComponent(m[1]) : '';
}
var _qlang = (function(){
  var q = qs('lang');
  if(q==='en' || q==='ja'){ localStorage.setItem('chay_lang', q); return q; }
  var saved = localStorage.getItem('chay_lang');
  if(saved!=='en' && saved!=='ja'){ localStorage.setItem('chay_lang','ja'); return 'ja'; }
  return saved;
})();
var curLang = _qlang; // ★既定を必ずJPに（初回）

var I18N = {
  ja:{
    by:'by', back:'← 特集一覧へ戻る', notFound:'対象の特集が見つかりません。',
    hidden:'この特集は非公開です。', genre:'ジャンル', era:'年代', region:'地域', top:'← トップへ戻る'
  },
  en:{
    by:'by', back:'← Back to Features', notFound:'Feature not found.',
    hidden:'This feature is not public.', genre:'Genre', era:'Era', region:'Region', top:'← Back to Top'
  }
};

function esc(s){
  return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}

/* http→https 昇格と安全な外部URL判定（混在コンテンツ防止） */
function normalizeHttps(u){
  try{
    if(!u) return '';
    if(/^https:\/\//i.test(u)) return u;
    if(/^http:\/\//i.test(u)) return u.replace(/^http:/i,'https:');
    return u;
  }catch(_){ return String(u||''); }
}
function safeExternalUrl(u){
  try{
    var url = new URL(normalizeHttps(u));
    return url.protocol === 'https:' ? url.href : '';
  }catch(_){ return ''; }
}

/* 画像フォールバック（Drive/Unsplash対応・https限定） */
function extractDriveId(u){
  try{
    var s=String(u||'');
    var m=s.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if(m) return m[1];
    m=s.match(/[?&]id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
    m=s.match(/uc\?export=view&id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
  }catch(_){}
  return '';
}
function buildImageSources(url){
  url = normalizeHttps(url);
  var arr=[]; if(!url) return arr;
  if(url.indexOf('images.unsplash.com')>=0){
    arr.push(url + (url.indexOf('?')>=0 ? '&w=1200' : '?w=1200'));
    return arr;
  }
  var id=extractDriveId(url);
  if(id){
    /* 先に軽いサムネ、失敗時に実体 */
    arr.push('https://drive.google.com/thumbnail?id='+id+'&sz=w1200');
    arr.push('https://drive.google.com/uc?export=view&id='+id);
  }
  if(/^https:\/\//i.test(url)) arr.push(url); // httpは除外
  return arr;
}

/* YouTube ID 抽出（https限定） */
function ytId(u){
  try{
    var s = String(u||'').trim(); if(!s) return '';
    var url = new URL(normalizeHttps(s));
    var host = url.hostname.replace(/^www\./,'');
    if(host==='youtu.be'){
      var p = url.pathname.slice(1);
      return (/^[A-Za-z0-9_-]{6,}$/.test(p)?p:'');
    }
    if(host==='youtube.com' || host==='m.youtube.com'){
      var v = url.searchParams.get('v');
      if(v && /^[A-Za-z0-9_-]{6,}$/.test(v)) return v;
      var m = url.pathname.match(/\/embed\/([A-Za-z0-9_-]{6,})/);
      if(m) return m[1];
    }
  }catch(_){}
  var m2 = String(u||'').match(/(?:youtu\.be\/|v=|embed\/)([A-Za-z0-9_-]{6,})/);
  return m2 ? m2[1] : '';
}

function chip(text){ var s=document.createElement('span'); s.className='chip'; s.textContent=text; return s; }

/* ▼▼▼ 追加：ENモード用の簡易翻訳（キャッシュ付き） ▼▼▼ */
const _enCache=new Map();
async function ja2en(s){
  const key=(s||'').trim(); if(!key) return '';
  if(_enCache.has(key)) return _enCache.get(key);
  try{
    const r=await fetch('https://translate.googleapis.com/translate_a/single?client=gtx&sl=ja&tl=en&dt=t&q='+encodeURIComponent(key),{cache:'no-store'});
    const j=await r.json();
    const out=(j&&j[0])? j[0].map(x=>x[0]).join('') : key;
    _enCache.set(key,out); return out;
  }catch(_){ _enCache.set(key,key); return key; }
}
/* ▲▲▲ ここまで追加 ▲▲▲ */

/* 言語適用 */
function applyLang(){
  var t = (curLang==='ja'?I18N.ja:I18N.en);
  document.getElementById('backlink').textContent = t.back;
  document.getElementById('btn-top').textContent = t.top;
  document.getElementById('lang-ja').classList.toggle('active', curLang==='ja');
  document.getElementById('lang-en').classList.toggle('active', curLang==='en');
}

/* EXEC_URL 解決（GitHubでも動くように） */
(function resolveExecUrl(){
  try{
    var injected = (window.EXEC_URL||'<?= EXEC_URL ?>'||'').trim();
    if (!injected || injected.indexOf('<?=')===0) injected = '';
    var fallback='https://script.google.com/macros/s/AKfycbznOw5AqZl9NqA1JvCgZqVI5HmmlIXTWG59CTuRO81s47lwzijy7XDAFOk7SpTQl76HZw/exec';
    window.EXEC_URL = injected || fallback;
  }catch(_){
    window.EXEC_URL='https://script.google.com/macros/s/AKfycbznOw5AqZl9NqA1JvCgZqVI5HmmlIXTWG59CTuRO81s47lwzijy7XDAFOk7SpTQl76HZw/exec';
  }
})();

/* GAS/外部 両対応の getFeatureById 呼び出しラッパ */
async function callGetFeatureById(arg, onOK, onNG){
  try{
    if(window.google && google.script && google.script.run){
      google.script.run.withSuccessHandler(onOK).withFailureHandler(onNG).getFeatureById(arg);
      return;
    }
  }catch(_){}
  try{
    const url1 = window.EXEC_URL + (window.EXEC_URL.indexOf('?')>=0?'&':'?')
      + 'fn=getFeatureById&payload=' + encodeURIComponent(JSON.stringify(arg))
      + '&v=' + Date.now();
    const r1 = await fetch(url1,{method:'GET',mode:'cors',cache:'no-store'});
    const ct = r1.headers.get('content-type')||'';
    if(r1.ok && ct.indexOf('application/json')>=0){ onOK(await r1.json()); return; }
  }catch(_){}
  try{
    const url2 = window.EXEC_URL + (window.EXEC_URL.indexOf('?')>=0?'&':'?') + 'v=' + Date.now();
    const r2 = await fetch(url2,{
      method:'POST',mode:'cors',cache:'no-store',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({fn:'getFeatureById',payload:arg,csrf:(window.__CZ_CSRF||'')})
    });
    if(!r2.ok){ throw new Error('HTTP '+r2.status); }
    onOK(await r2.json());
  }catch(err){ onNG(err); }
}

/* ===== 描画 ===== */
async function renderHeader(data){  /* ← 非同期に変更（翻訳のため） */
  var head = document.getElementById('head');
  head.innerHTML = '';
  var title = document.createElement('div');
  title.className='title';
  var titleText = data.title || '(No title)';
  if(curLang==='en' && titleText){ titleText = await ja2en(titleText); } /* ★追加：EN時は翻訳 */
  title.innerHTML = esc(titleText);
  head.appendChild(title);

  var meta = document.createElement('div'); meta.className='meta';
  if(data.genre){ meta.appendChild(chip(String(data.genre))); }
  if(data.era){   meta.appendChild(chip(String(data.era))); }
  if(data.region){meta.appendChild(chip(String(data.region))); }
  var author = document.createElement('span');
  author.className='author';
  author.textContent = (I18N[curLang].by + ' ' + (data.author||''));
  meta.appendChild(author);
  head.appendChild(meta);
}

/* ▼ 段落ごとに本文→画像→YouTube をまとめて描画（高速化：lazy/async） */
async function renderBody(data){   /* ← 非同期に変更（翻訳のため） */
  var body = document.getElementById('body'); body.innerHTML='';

  var any=false;
  for(var i=1;i<=5;i++){
    var text = data['para'+i+'_text'] || '';
    var yt   = data['youtube'+i] || '';
    var imgs = [];
    for(var j=1;j<=3;j++){
      var u = data['p'+i+'_img'+j+'_url']; if(u) imgs.push(u);
    }
    if(!text && !imgs.length && !yt) continue;
    any=true;

    var sec = document.createElement('div'); sec.className='para';

    if(text){
      if(curLang==='en'){ text = await ja2en(text); }  /* ★追加：EN時は翻訳 */
      var p = document.createElement('div'); p.className='ptext'; p.textContent = text;
      sec.appendChild(p);
    }

    if(imgs.length){
      var t = document.createElement('div'); t.className='thumbs';
      imgs.forEach(function(u){
        var srcs = buildImageSources(u||'');
        if(srcs.length){
          var img = document.createElement('img');
          img.loading='lazy'; img.decoding='async'; img.alt='image';
          var k=0; function next(){ if(k>=srcs.length){ return; } img.src=srcs[k++]; }
          img.onerror=next; next();
          t.appendChild(img);
        }
      });
      sec.appendChild(t);
    }

    if(yt){
      var id = ytId(yt);
      if(id){
        var y = document.createElement('div'); y.className='yt';
        var ifr = document.createElement('iframe');
        ifr.loading='lazy';
        ifr.src='https://www.youtube.com/embed/'+id;
        ifr.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
        ifr.setAttribute('allowfullscreen','');
        y.appendChild(ifr);
        sec.appendChild(y);
      }
    }

    body.appendChild(sec);
  }

  if(!any){ body.innerHTML = '<div class="ptext" style="color:#888">—</div>'; }
}

/* ===== ロード処理 ===== */
function showError(msgKey){
  var a = document.getElementById('alert');
  a.textContent = I18N[curLang][msgKey] || 'Error';
  a.className='alert show';
}
function backUrl(){
  /* ▼ GitHub 側の一覧へ戻す */
  return './search_features.html';
}

/* ===== 初期化 ===== */
(function init(){
  // 言語
  applyLang();
  document.getElementById('lang-ja').onclick = function(){ curLang='ja'; localStorage.setItem('chay_lang','ja'); applyLang(); };
  document.getElementById('lang-en').onclick = function(){ curLang='en'; localStorage.setItem('chay_lang','en'); applyLang(); };
  document.getElementById('backlink').href = backUrl();

  // クエリ
  var row = qs('row');
  var slug = qs('slug');

  // データ取得（GAS/外部両対応）
  callGetFeatureById(
    row ? { rowIndex:Number(row)||0 } : (slug ? { slug:String(slug) } : { rowIndex:0 }),
    function(res){
      try{
        if(!res || !res.ok || !res.data){
          showError('notFound'); return;
        }
        var d = res.data || {};
        var st = String(d.status||'').toLowerCase();
        if(st && st!=='published'){ showError('hidden'); }
        (async ()=>{ await renderHeader(d); await renderBody(d); })();  /* ★変更：非同期で呼ぶ */
        var idhint = document.getElementById('idhint');
        idhint.textContent = d.slug ? ('slug: '+d.slug+' / row: '+(res.rowIndex||'')) : ('row: '+(res.rowIndex||''));
      }catch(_){ showError('notFound'); }
    },
    function(){ showError('notFound'); }
  );
})();
</script>
</body>
</html>
