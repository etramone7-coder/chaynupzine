<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CHAYNUPZINE — Feature</title>
<style>
  :root{
    --ink:#222; --muted:#666; --brand:#111; --chip:#eef1f5;
    --card:rgba(255,255,255,.92); --line:#e5e7eb; --link:#2E66CC;
  }
  html,body{margin:0;background:#f3f5f7;color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; font-size:18px;}
  .bg{position:fixed; inset:0; background-size:cover; background-position:center;
    filter:brightness(.88); z-index:-1}
  .wrap{max-width:980px; margin:28px auto; padding:0 16px}
  .panel{background:var(--card); backdrop-filter:saturate(120%) blur(10px);
    border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.16); padding:20px}
  .top{display:flex; justify-content:space-between; align-items:center; gap:12px}
  .brand{display:inline-block; background:var(--brand); color:#fff; border-radius:8px; padding:7px 12px; font-weight:800; letter-spacing:.4px}
  .lang button{border:1px solid #ddd; background:#fff; color:#111; border-radius:12px; padding:8px 12px; cursor:pointer; font-weight:800}
  .title{font-size:26px; font-weight:800; margin:14px 0 6px}
  .meta{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:12px}
  .chip{background:var(--chip); border-radius:999px; padding:8px 12px; font-weight:700; font-size:14px}
  .author{color:var(--muted); font-size:14px}
  .divider{height:1px; background:var(--line); margin:14px 0}
  .para{padding:10px 0}
  .ptext{white-space:pre-wrap; line-height:1.7}
  .thumbs{display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-top:8px}
  .thumbs img{width:100%; height:180px; object-fit:cover; border-radius:10px; background:#fff}
  @media (max-width:780px){ .thumbs img{height:120px} }
  .yt{position:relative; width:100%; aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden; margin-top:10px}
  .yt iframe{position:absolute; inset:0; width:100%; height:100%; border:0}
  .tools{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:8px}
  .back a{color:var(--link); text-decoration:none; font-weight:700}
  .id{color:#999; font-size:12px}
  .alert{margin:12px 0; padding:12px; border-radius:14px; background:#ffe9e9; color:#a33; border:1px solid #f6bcbc; font-size:16px; display:none}
  .alert.show{display:block}
  .skeleton{animation: pulse 1.1s infinite ease-in-out; background:linear-gradient(90deg,#eee,#f7f7f7,#eee); border-radius:10px}
  @keyframes pulse{0%{background-position:0% 50%}100%{background-position:100% 50%}}
  .sk-title{height:28px; margin:16px 0}
  .sk-line{height:14px; margin:8px 0}
</style>
</head>
<body>
<div id="bg" class="bg"></div>

<div class="wrap">
  <div class="panel">
    <div class="top">
      <div>
        <span class="brand">CHAYNUPZINE</span>
      </div>
      <div class="lang"><button id="btn-lang" type="button">EN / 日本語</button></div>
    </div>

    <div id="alert" class="alert"></div>

    <!-- ヘッダー -->
    <div id="head">
      <div class="skeleton sk-title"></div>
      <div class="meta">
        <span class="chip skeleton" style="width:84px;height:30px"></span>
        <span class="chip skeleton" style="width:80px;height:30px"></span>
        <span class="chip skeleton" style="width:100px;height:30px"></span>
        <span class="author skeleton" style="width:160px;height:20px"></span>
      </div>
    </div>

    <div class="divider"></div>

    <!-- 本文 -->
    <div id="body">
      <div class="sk-line skeleton"></div>
      <div class="sk-line skeleton"></div>
      <div class="sk-line skeleton"></div>
    </div>

    <div class="divider"></div>

    <div class="tools">
      <div class="back"><a id="backlink" href="#">← Back to Features</a></div>
      <div class="id" id="idhint"></div>
    </div>
  </div>
</div>

<script>
/* ===== 背景：GitHub 配下の固定画像 ===== */
document.getElementById('bg').style.backgroundImage = 'url(./assets/bg/bg_features.webp)';

/* ===== 言語 ===== */
var curLang = (localStorage.getItem('cz_lang') || 'ja');
var I18N = {
  ja:{
    by:'by', back:'← 特集一覧へ戻る', notFound:'対象の特集が見つかりません。',
    hidden:'この特集は非公開です。', genre:'ジャンル', era:'年代', region:'地域'
  },
  en:{
    by:'by', back:'← Back to Features', notFound:'Feature not found.',
    hidden:'This feature is not public.', genre:'Genre', era:'Era', region:'Region'
  }
};

/* ===== utils ===== */
function qs(k){
  var m = location.search.match(new RegExp('[?&]'+k+'=([^&]+)'));
  return m ? decodeURIComponent(m[1]) : '';
}
function esc(s){
  return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
}
function ytId(u){
  if(!u) return '';
  var m = u.match(/youtu\.be\/([\w-]{6,})/); if(m) return m[1];
  m = u.match(/[?&]v=([\w-]{6,})/); if(m) return m[1];
  return '';
}
function chip(text){ var s=document.createElement('span'); s.className='chip'; s.textContent=text; return s; }

/* ===== 言語適用 ===== */
function applyLang(){
  var t = (curLang==='ja'?I18N.ja:I18N.en);
  document.getElementById('backlink').textContent = t.back;
}

/* ===== 描画 ===== */
function renderHeader(data){
  var head = document.getElementById('head');
  head.innerHTML = '';
  var title = document.createElement('div');
  title.className='title';
  title.innerHTML = esc(data.title || '(No title)');
  head.appendChild(title);

  var meta = document.createElement('div'); meta.className='meta';
  if(data.genre){ meta.appendChild(chip(String(data.genre))); }
  if(data.era){   meta.appendChild(chip(String(data.era))); }
  if(data.region){meta.appendChild(chip(String(data.region))); }
  var author = document.createElement('span');
  author.className='author';
  author.textContent = (I18N[curLang].by + ' ' + (data.author||''));
  meta.appendChild(author);
  head.appendChild(meta);
}

function renderBody(data){
  var body = document.getElementById('body'); body.innerHTML='';
  // 段落は 1..5 をサポート（.gs と一致）
  for(var i=1;i<=5;i++){
    var text = data['para'+i+'_text'] || '';
    var hasImg = (data['p'+i+'_img1_url'] || data['p'+i+'_img2_url'] || data['p'+i+'_img3_url']);
    var yt = data['youtube'+i] || '';
    if(!text && !hasImg && !yt) continue;

    var sec = document.createElement('div'); sec.className='para';

    if(text){
      var p = document.createElement('div'); p.className='ptext'; p.textContent = text;
      sec.appendChild(p);
    }

    if(hasImg){
      var t = document.createElement('div'); t.className='thumbs';
      for(var j=1;j<=3;j++){
        var u = data['p'+i+'_img'+j+'_url'];
        if(u){ var img = document.createElement('img'); img.src = u; img.alt='image'; t.appendChild(img); }
      }
      sec.appendChild(t);
    }

    if(yt){
      var id = ytId(yt);
      if(id){
        var y = document.createElement('div'); y.className='yt';
        var ifr = document.createElement('iframe');
        ifr.src='https://www.youtube.com/embed/'+id;
        ifr.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
        ifr.setAttribute('allowfullscreen','');
        y.appendChild(ifr);
        sec.appendChild(y);
      }
    }
    body.appendChild(sec);
  }

  if(!body.children.length){
    body.innerHTML = '<div class="ptext" style="color:#888">—</div>';
  }
}

/* ===== ロード処理 ===== */
function showError(msgKey){
  var a = document.getElementById('alert');
  a.textContent = I18N[curLang][msgKey] || 'Error';
  a.className='alert show';
}
function backUrl(){
  // /exec にそろえて features_search を指す（同じGASデプロイ内）
  var base = location.href.replace(/\/(?:dev|userCodeAppPanel)(?:\?.*)?$/,'/exec');
  var m = base.match(/^(.*\/exec)/); base = (m?m[1]:base);
  return base + '?page=search_features';
}

/* ===== 初期化 ===== */
(function init(){
  // 言語
  applyLang();
  document.getElementById('btn-lang').onclick = function(){
    curLang = (curLang==='ja'?'en':'ja');
    localStorage.setItem('cz_lang', curLang);
    applyLang();
  };
  document.getElementById('backlink').href = backUrl();

  // クエリ
  var row = qs('row');
  var slug = qs('slug');

  // GAS 呼び出し
  try{
    google.script.run
      .withSuccessHandler(function(res){
        try{
          if(!res || !res.ok || !res.data){
            showError('notFound');
            return;
          }
          var d = res.data || {};
          // 非公開の扱い
          var st = String(d.status||'').toLowerCase();
          if(st && st!=='published'){
            showError('hidden');
            // 以降も描画はする（運営確認用）
          }
          renderHeader(d);
          renderBody(d);
          // IDヒント
          var idhint = document.getElementById('idhint');
          idhint.textContent = d.slug ? ('slug: '+d.slug+' / row: '+(res.rowIndex||'')) : ('row: '+(res.rowIndex||''));
        }catch(e){
          showError('notFound');
        }
      })
      .withFailureHandler(function(err){
        showError('notFound');
      })
      .getFeatureById(row ? { rowIndex:Number(row)||0 } : (slug ? { slug:String(slug) } : { rowIndex:0 }));
  }catch(e){
    // Apps Script 外で開いた場合のフォールバック
    showError('notFound');
  }
})();
</script>
</body>
</html>
