<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CHAYNUPZINE — Lives browse</title>
<style>
  :root{
    --bg:#0f1115; --panel:#151922; --ink:#e7e9ee; --muted:#9aa3af;
    --line:#2b3240; --accent:#1e90ff; --danger:#e25555;
    --chip:#2a3142; --chip-ink:#cfd6e6;
  }
  html,body{margin:0;height:100%;background:#0f1115;color:var(--ink);
    font:16px/1.6 -apple-system,BlinkMacSystemFont,"Helvetica Neue","Hiragino Kaku Gothic ProN",Meiryo,system-ui,sans-serif}
  .bg{position:fixed; inset:0; background:#0f1115 url("https://raw.githubusercontent.com/etramone7-coder/chaynupzine/main/assets/bg_lives.webp?raw=1") center/cover no-repeat;
      opacity:.25; filter:contrast(1) brightness(.9); z-index:-1}
  .wrap{max-width:1100px;margin:28px auto;padding:0 14px}
  .title{font-weight:800;letter-spacing:.3px;color:#fff;font-size:22px;margin:0 0 12px}
  .panel{background:rgba(18,22,30,.82);border:1px solid var(--line);border-radius:14px;padding:14px 14px 8px;backdrop-filter:saturate(120%) blur(8px)}
  .filters{display:flex;flex-wrap:wrap;gap:10px;margin:8px 0 6px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--chip-ink);font-size:12px;border:1px solid #3a4254}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:14px}
  @media (max-width:980px){.grid{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:640px){.grid{grid-template-columns:1fr}}
  .card{background:#0e121a;border:1px solid #273045;border-radius:12px;overflow:hidden}
  .ph{aspect-ratio:16/9;background:#0b0e14;color:#2c3343;display:flex;align-items:center;justify-content:center}
  .cover{width:100%;height:auto;display:block;object-fit:cover}
  .pad{padding:10px 12px}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .artist{font-weight:800}
  .titleLive{opacity:.92}
  .meta,.price,.desc{font-size:13px;color:#b8c0d1}
  .badge{font-size:11px;padding:2px 8px;border:1px solid #3a4254;border-radius:999px;color:#c6d0e1}
  .badge.st{border-color:#2b6cb0}
  .badge.er{border-color:#a33;color:#ffb3b3}
  .actions{display:flex;justify-content:center;margin:16px 0 6px}
  .btn{border:0;border-radius:10px;padding:10px 14px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:default}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0 0}
  .in{background:#0e121a;border:1px solid var(--line);border-radius:8px;color:#fff;padding:8px 10px}
  .small{font-size:12px;color:#9aa3af}
  .yt{position:relative;width:100%;aspect-ratio:16/9;background:#000;border-top:1px solid #273045}
  .yt iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
  .msg{margin:6px 0 0;font-size:12px}
  .ok{color:#5dd39e}.err{color:var(--danger)}
</style>
</head>
<body>
<div class="bg"></div>

<div class="wrap">
  <h1 class="title">CHAYNUPZINE — Lives browse</h1>

  <!-- 条件の概要（クエリ反映） -->
  <div class="panel">
    <div id="chips" class="filters"></div>
    <div class="small" id="summary"></div>

    <!-- 編集/削除ツール（行番号＋編集キー）-->
    <div class="toolbar">
      <span class="small">投稿を編集/削除</span>
      <input id="rowInput" class="in" type="number" min="2" placeholder="行番号 (例: 12)" style="width:140px">
      <input id="editKey" class="in" type="text" placeholder="編集キー" style="width:160px" inputmode="latin" pattern="[A-Za-z0-9]+">
      <button id="btnHide" class="btn" type="button" title="非表示（delete）">非表示</button>
      <button id="btnUnhide" class="btn" type="button" title="再表示（unhide）" style="background:#3949ab">再表示</button>
      <span id="editMsg" class="msg"></span>
    </div>
  </div>

  <!-- 結果 -->
  <div id="results" class="grid"></div>
  <div class="actions"><button id="moreBtn" class="btn" type="button" style="display:none">もっと見る</button></div>
  <div id="foot" class="small"></div>
</div>

<script>
(function(){
  // ===== util =====
  function $(q){ return document.querySelector(q); }
  function el(tag, attrs){ var e=document.createElement(tag); if(attrs) Object.assign(e, attrs); return e; }
  function qs(key){ return new URLSearchParams(location.search).getAll(key); } // 複数キーにも対応
  function q1(key){ var p=new URLSearchParams(location.search); return p.get(key)||''; }
  function toJPStatus(v){ return v==='canceled'?'中止':(v==='done'?'終了':'開催予定'); }

  // ★追加: http→https 昇格 & 外部URL制限（画像/リンク混在コンテンツ対策）
  function normalizeHttps(u){
    try{
      if(!u) return '';
      if(/^https:\/\//i.test(u)) return u;
      if(/^http:\/\//i.test(u)) return u.replace(/^http:/i,'https:');
      return u;
    }catch(_){ return String(u||''); }
  }
  function safeExternalUrl(u){
    try{
      var url = new URL(normalizeHttps(u));
      return url.protocol === 'https:' ? url.href : '';
    }catch(_){ return ''; }
  }

  // ★追加: Drive/Unsplash の画像フォールバック（http禁止）
  function extractDriveId(u){
    try{
      var s=String(u||'');
      var m=s.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if(m) return m[1];
      m=s.match(/[?&]id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
      m=s.match(/uc\?export=view&id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
    }catch(_){}
    return '';
  }
  function buildImageSources(url){
    url = normalizeHttps(url);
    var arr=[]; if(!url) return arr;
    if(url.indexOf('images.unsplash.com')>=0){
      arr.push(url + (url.indexOf('?')>=0 ? '&w=1200' : '?w=1200'));
      return arr;
    }
    var id = extractDriveId(url);
    if(id){
      arr.push('https://drive.google.com/uc?export=view&id='+id);
      arr.push('https://drive.google.com/thumbnail?id='+id+'&sz=w1200');
    }
    if(/^https:\/\//i.test(url)) arr.push(url); // httpは混在防止で除外
    return arr;
  }

  // ===== query -> params =====
  // search_lives 側から genre, region, prefectures[], months[], initial, artist などが来る想定
  var months = (function(){
    var m = qs('months'); // months=1&months=2...
    if (!m.length) {
      var mCsv=q1('months'); if (mCsv) m = mCsv.split(',').map(function(s){return s.trim();});
    }
    return m.map(function(s){return Number(s)||''}).filter(Boolean);
  })();

  var params = {
    region     : q1('region'),
    prefecture : q1('prefecture'),               // 単一県（複数の場合は最初の1つを使う。複数は region で代替）
    initial    : q1('initial'),
    status     : q1('status'),
    date_from  : q1('date_from'),
    date_to    : q1('date_to'),
    artist     : q1('artist') || q1('artist_kw') || '',
    genre      : q1('genre') || '',              // Lives に genre 追加済みの場合に備え保留（.gs側は現状未使用でも無害）
    months     : months
  };

  // 県が配列で来た場合（prefectures[]=東京…）の先頭を拾う
  var prefArr = qs('prefectures[]'); if (!params.prefecture && prefArr.length) params.prefecture = prefArr[0];

  // 画面要素
  var results = $('#results');
  var chips = $('#chips');
  var moreBtn = $('#moreBtn');
  var foot = $('#foot');

  // ページング
  var limit = 24, offset = 0, total = 0;

  function chip(txt){ var c=el('span',{className:'chip',textContent:txt}); return c; }

  function drawSummary(){
    chips.innerHTML='';
    if(params.genre) chips.appendChild(chip('Genre: '+params.genre));
    if(params.region) chips.appendChild(chip('Region: '+params.region));
    if(params.prefecture) chips.appendChild(chip('Pref: '+params.prefecture));
    if(params.initial) chips.appendChild(chip('Initial: '+params.initial));
    if(params.status) chips.appendChild(chip('Status: '+params.status));
    if(params.artist) chips.appendChild(chip('Artist: '+params.artist));
    if(params.date_from || params.date_to) chips.appendChild(chip('Date: '+(params.date_from||'..')+'〜'+(params.date_to||'..')));
    if(params.months && params.months.length) chips.appendChild(chip('Month: '+params.months.join('/')));
    $('#summary').textContent = '条件に合致するライブを表示します。';
  }

  function fmtMeta(it){
    var a=[];
    if(it.date) a.push(it.date);
    if(it.open_time) a.push('OPEN '+it.open_time);
    if(it.start_time) a.push('START '+it.start_time);
    if(it.venue) a.push('@ '+it.venue);
    return a.join('  ');
  }

  function card(it){
    var c = el('div',{className:'card'});

    // ★修正: 画像は https のみ読み込み + Drive/Unsplash フォールバック
    (function appendCover(){
      var srcs = buildImageSources(it.image_url || '');
      if(!srcs.length){
        c.appendChild(el('div',{className:'ph',textContent:'no image'}));
        return;
      }
      var img = el('img',{className:'cover',alt:'cover'});
      var i=0; function next(){ if(i>=srcs.length){ c.appendChild(el('div',{className:'ph',textContent:'no image'})); return; } img.src=srcs[i++]; }
      img.onerror=next; next(); c.appendChild(img);
    })();

    var pad = el('div',{className:'pad'}); c.appendChild(pad);

    var row1 = el('div',{className:'row'}); pad.appendChild(row1);
    row1.appendChild(el('span',{className:'badge st',textContent:toJPStatus((it.status||'').toLowerCase())}));
    if(it.region) row1.appendChild(el('span',{className:'badge',textContent:it.region}));
    if(it.prefecture) row1.appendChild(el('span',{className:'badge',textContent:it.prefecture}));

    pad.appendChild(el('div',{className:'artist',textContent:it.artist||'—'}));
    if(it.title) pad.appendChild(el('div',{className:'titleLive',textContent:it.title}));

    pad.appendChild(el('div',{className:'meta',textContent:fmtMeta(it)}));
    if(it.price) pad.appendChild(el('div',{className:'price',textContent:it.price}));
    if(it.description) pad.appendChild(el('div',{className:'desc',textContent:it.description}));

    // ★修正: 参考URLは https のみ許可 + rel=noopener
    if(it.reference_url){
      var safe = safeExternalUrl(it.reference_url);
      if(safe){
        var a=el('a',{href:safe,target:'_blank',rel:'noopener',textContent:'公式/イベントページ',style:'display:inline-block;margin-top:6px;color:#8ab4ff;text-decoration:none'});
        pad.appendChild(a);
      }
    }

    // 通報＆行番号表示
    var tools = el('div',{className:'row',style:'margin-top:8px;justify-content:space-between'});
    var left = el('div',{className:'small',textContent:'Row: '+it.rowIndex});
    var report = el('button',{className:'btn',textContent:'通報',style:'background:#8b0000'});
    report.onclick=function(){
      var reason = prompt('通報理由（例：スパム/不正確など）'); if(!reason) return;
      var clientId = getClientId();
      google.script.run.withSuccessHandler(function(res){
        alert(res && res.autoHidden ? '通報が多数のため自動的に非表示になりました。' : '通報を受け付けました。');
      }).withFailureHandler(function(err){
        alert('エラー: '+(err && err.message ? err.message : String(err)));
      }).submitReport({sheetName:'Lives',rowIndex:it.rowIndex,reason:reason,client_id:clientId});
    };
    tools.appendChild(left); tools.appendChild(report);
    pad.appendChild(tools);

    // ★修正: YouTube は https かつ公式ドメインのみ埋め込み
    if(it.youtube_url){
      var id = (function(u){
        try{
          var url = new URL(normalizeHttps(String(u||'')));
          var host = url.hostname.replace(/^www\./,'');
          if(host==='youtu.be'){
            var p = url.pathname.slice(1);
            return (/^[A-Za-z0-9_-]{6,}$/.test(p)?p:'');
          }
          if(host==='youtube.com' || host==='m.youtube.com'){
            var v = url.searchParams.get('v');
            if(v && /^[A-Za-z0-9_-]{6,}$/.test(v)) return v;
            var m = url.pathname.match(/\/embed\/([A-Za-z0-9_-]{6,})/);
            if(m) return m[1];
          }
        }catch(_){}
        var m2 = String(u||'').match(/(?:youtu\.be\/|v=|embed\/)([A-Za-z0-9_-]{6,})/);
        return m2 ? m2[1] : '';
      })(it.youtube_url);
      if(id){
        var yt = el('div',{className:'yt'});
        yt.innerHTML = '<iframe src="https://www.youtube.com/embed/'+id+'" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>';
        c.appendChild(yt);
      }
    }

    return c;
  }

  function getClientId(){
    try{
      var k='chaynupzine_cid';
      var id=localStorage.getItem(k);
      if(!id){ id='cid_'+Math.random().toString(36).slice(2)+Date.now().toString(36); localStorage.setItem(k,id); }
      return id;
    }catch(_){ return ''; }
  }

  function fetchLives(append){
    var p = Object.assign({}, params, { limit: limit, offset: offset });
    // months が指定されている場合：date_from/date_to を補助的に計算（当年想定）
    if ((params.months||[]).length && !params.date_from && !params.date_to){
      try{
        var y = new Date().getFullYear();
        var minM = Math.min.apply(null, params.months);
        var maxM = Math.max.apply(null, params.months);
        p.date_from = y + '-' + String(minM).padStart(2,'0') + '-01';
        // 月末
        var lastDay = new Date(y, maxM, 0).getDate();
        p.date_to   = y + '-' + String(maxM).padStart(2,'0') + '-' + String(lastDay).padStart(2,'0');
      }catch(_){}
    }

    google.script.run
      .withSuccessHandler(function(res){
        if(!res || !res.ok){ foot.textContent='読み込みに失敗しました'; return; }
        total = Number(res.total||0);
        if(!append) results.innerHTML='';
        (res.items||[]).forEach(function(it){ results.appendChild(card(it)); });

        offset += (res.items||[]).length;
        moreBtn.style.display = (offset < total) ? '' : 'none';
        foot.textContent = (total ? ('表示 '+offset+' / '+total) : '該当なし');
      })
      .withFailureHandler(function(err){
        foot.textContent='エラー: '+(err && err.message ? err.message : String(err));
      })
      .listLives(p);
  }

  // 編集/削除（hide/unhide）
  $('#btnHide').onclick = function(){
    var row = Number($('#rowInput').value||0);
    var key = String($('#editKey').value||'').trim();
    if(!(row>=2) || !key){ $('#editMsg').textContent='行番号と編集キーを入力してください'; $('#editMsg').className='msg err'; return; }
    google.script.run.withSuccessHandler(function(res){
      $('#editMsg').textContent = res && res.ok ? '非表示にしました' : '失敗しました';
      $('#editMsg').className = res && res.ok ? 'msg ok' : 'msg err';
    }).withFailureHandler(function(err){
      $('#editMsg').textContent='エラー: '+(err && err.message ? err.message : String(err));
      $('#editMsg').className='msg err';
    }).editEntry({sheetName:'Lives',rowIndex:row,edit_key:key,action:'delete'});
  };
  $('#btnUnhide').onclick = function(){
    var row = Number($('#rowInput').value||0);
    var key = String($('#editKey').value||'').trim();
    if(!(row>=2) || !key){ $('#editMsg').textContent='行番号と編集キーを入力してください'; $('#editMsg').className='msg err'; return; }
    google.script.run.withSuccessHandler(function(res){
      $('#editMsg').textContent = res && res.ok ? '再表示しました' : '失敗しました';
      $('#editMsg').className = res && res.ok ? 'msg ok' : 'msg err';
    }).withFailureHandler(function(err){
      $('#editMsg').textContent='エラー: '+(err && err.message ? err.message : String(err));
      $('#editMsg').className='msg err';
    }).editEntry({sheetName:'Lives',rowIndex:row,edit_key:key,action:'unhide'});
  };

  // 初回描画
  drawSummary();
  fetchLives(false);
  moreBtn.onclick = function(){ fetchLives(true); };
})();
</script>
</body>
</html>
