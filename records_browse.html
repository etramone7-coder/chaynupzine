<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CHAYNUPZINE — Record View</title>
<style>
  :root{ --ink:#222; --panel:rgba(255,255,255,.92); }
  html,body{
    margin:0; background:#f3f5f7; color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    font-size:20px; line-height:1.5;
  }
  .bg{position:fixed; inset:0; background-size:cover; background-position:center; filter:brightness(.88); z-index:-1}

  .wrap{max-width:1080px; margin:28px auto; padding:0 16px}
  .panel{
    background:var(--panel); backdrop-filter:saturate(120%) blur(10px);
    border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.16);
    padding:20px; min-height:720px;
  }

  .topbar{display:flex; justify-content:space-between; gap:12px; align-items:center}
  h1{margin:0; display:flex; gap:12px; align-items:center; font-size:24px}
  .brand{background:#111; color:#fff; border-radius:8px; padding:7px 12px; font-weight:800}

  .btn{border:0; border-radius:14px; padding:10px 14px; font-size:18px; font-weight:800; cursor:pointer}
  .btn.ghost{background:#fff; color:#111; border:1px solid #ddd}
  .btn.warn{background:#fff0f0; color:#a33; border:1px solid #f3b9b9}

  .grid{display:grid; gap:18px; margin-top:16px}
  @media(min-width:980px){ .grid{grid-template-columns:420px 1fr} }

  /* 左カラム */
  .leftbox{display:flex; flex-direction:column; gap:14px}
  .jacket{
    width:100%; aspect-ratio:1/1; border-radius:14px; background:#f5f5f5;
    display:flex; align-items:center; justify-content:center; overflow:hidden; color:#888
  }
  .jacket img{width:100%; height:100%; object-fit:cover; display:block}

  .ytwrap{position:relative; width:100%; padding-top:56.25%; border-radius:14px; overflow:hidden; background:#000}
  .ytwrap iframe{position:absolute; inset:0; width:100%; height:100%; border:0}

  /* 右カラム */
  .head{display:flex; flex-wrap:wrap; gap:10px; align-items:flex-start}
  .title{min-width:0}
  .band{font-size:26px; font-weight:900; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .track{font-size:20px; color:#444; margin:4px 0 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .badge{padding:8px 12px; border-radius:999px; font-size:16px; font-weight:800; align-self:flex-start}

  .meta{display:grid; gap:8px; margin:10px 0 0}
  .kv{display:flex; gap:10px; align-items:center}
  .k{font-weight:800; color:#555; min-width:7em}
  .v{color:#222}

  .desc{margin-top:14px; white-space:pre-wrap}
  .author{margin-top:10px; color:#555}
  .actions{display:flex; gap:10px; margin-top:16px; flex-wrap:wrap}

  .alert{margin-top:14px; padding:12px; border-radius:12px; border:1px solid #e6e6e6; background:#fff; font-size:16px; display:none}
  .alert.show{display:block}
</style>
</head>
<body>
<div id="bg" class="bg"></div>

<div class="wrap">
  <div class="panel">
    <div class="topbar">
      <h1>
        <span class="brand">CHAYNUPZINE</span>
        <span style="font-size:16px;color:#555">Record — view</span>
      </h1>
      <div class="actions">
        <!-- 戻るはアンダースコア版の検索ページへ -->
        <button class="btn ghost" onclick="location.href=(function(){var u=location.href.replace(/\/(?:dev|userCodeAppPanel)(?:\?.*)?$/,'/exec');var m=u.match(/^(.*\/exec)/);return (m?m[1]:u);}()) + '?page=search_records'">検索へ戻る</button>
      </div>
    </div>

    <div class="grid">
      <!-- 左 -->
      <div class="leftbox">
        <div class="jacket" id="jacketBox">No image</div>
        <!-- 既存の埋め込み枠は触らず常に非表示（案①） -->
        <div class="ytwrap" id="ytWrap" style="display:none">
          <iframe id="ytFrame"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen></iframe>
        </div>
      </div>

      <!-- 右 -->
      <div>
        <div class="head">
          <div class="title">
            <h2 class="band" id="band">(Band)</h2>
            <div class="track" id="track">(Track)</div>
          </div>
          <div class="badge" id="genreBadge">GENRE</div>
        </div>

        <div class="meta">
          <div class="kv"><div class="k">ジャンル</div><div class="v" id="genre">-</div></div>
          <div class="kv"><div class="k">年代</div><div class="v" id="era">-</div></div>
          <div class="kv"><div class="k">型番</div><div class="v" id="catalog">-</div></div>
          <div class="kv"><div class="k">フォーマット</div><div class="v" id="format">-</div></div>
        </div>

        <div class="desc" id="description"></div>
        <div class="author" id="author"></div>

        <div class="actions">
          <button class="btn warn" id="reportBtn" type="button">通報する</button>
        </div>
        <div id="msg" class="alert"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* 背景（軽量ランダム） */
(function(){
  var backs=[
    'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=60&w=1200',
    'https://images.unsplash.com/photo-1515879218367-8466d910aaa4?q=60&w=1200',
    'https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=60&w=1200',
    'https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?q=60&w=1200'
  ];
  document.getElementById('bg').style.backgroundImage =
    'url('+backs[Math.floor(Math.random()*backs.length)]+')';
})();

/* ジャンルごとの色（バッジ） */
var GENRE_STYLES = {
  Punk:{bg:'#111',fg:'#fff'},
  Hardcore:{bg:'#b00020',fg:'#fff'},
  PowerPop:{bg:'#ffd54f',fg:'#111'},
  Indie:{bg:'#4fc3f7',fg:'#111'},
  Garage:{bg:'#8d6e63',fg:'#fff'},
  Mods:{bg:'#607d8b',fg:'#fff'},
  NeoMods:{bg:'#26a69a',fg:'#fff'},
  Metal:{bg:'#424242',fg:'#fff'},
  HardRock:{bg:'#6d4c41',fg:'#fff'},
  Reggae:{bg:'#2e7d32',fg:'#fff'},
  Rock:{bg:'#3949ab',fg:'#fff'},
  Pop:{bg:'#f06292',fg:'#fff'},
  Melodicore:{bg:'#ef6c00',fg:'#fff'},
  Rockabilly:{bg:'#7e57c2',fg:'#fff'},
  Other:{bg:'#9e9e9e',fg:'#fff'}
};

/* 画像フォールバック（Drive/Unsplash対応） */
function extractDriveId(u){
  try{
    var s=String(u||'');
    var m=s.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if(m) return m[1];
    m=s.match(/[?&]id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
    m=s.match(/uc\?export=view&id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
  }catch(e){}
  return '';
}
function buildImageSources(url){
  var arr=[]; if(!url) return arr;
  if(String(url).indexOf('images.unsplash.com')>=0){
    arr.push(url + (url.indexOf('?')>=0 ? '&w=900' : '?w=900'));
    return arr;
  }
  var id=extractDriveId(url);
  if(id){
    arr.push('https://drive.google.com/uc?export=view&id='+id);
    arr.push('https://drive.google.com/thumbnail?id='+id+'&sz=w900');
  }
  arr.push(url);
  return arr;
}
function setJacket(url){
  var box=document.getElementById('jacketBox'); box.innerHTML='';
  var srcs=buildImageSources(url);
  if(!srcs.length){ box.textContent='No image'; return; }
  var img=new Image(); var i=0; img.loading='lazy';
  function next(){ if(i>=srcs.length){ box.textContent='No image'; return; } img.src=srcs[i++]; }
  img.onerror=next; next(); box.appendChild(img);
}

/* YouTube（案①：URLがあればボタン表示。なければ何も出さない） */
function setYouTube(u){
  // 既存の埋め込み枠は使わず非表示のまま
  var wrap=document.getElementById('ytWrap');
  if(wrap) wrap.style.display='none';

  // 以前のボタンがあれば除去（差し戻し用）
  var oldBtn=document.getElementById('ytBtn');
  if(oldBtn) oldBtn.remove();

  var yt=(u||'').trim();
  if(!yt) return;

  var btn=document.createElement('a');
  btn.id='ytBtn';
  btn.href=yt;
  btn.target='_blank';
  btn.rel='noopener';
  btn.className='btn ghost';
  btn.textContent='Open YouTube';

  // 画像の直下に挿入
  var jacket=document.getElementById('jacketBox');
  jacket.insertAdjacentElement('afterend', btn);
}

/* クエリ取得 */
function q(name){
  return new URL(location.href).searchParams.get(name)||'';
}

/* レンダリング */
function render(rec){
  document.getElementById('band').textContent  = rec.band || '(Band)';
  document.getElementById('track').textContent = rec.track|| '(Track)';

  var g = rec.genre || 'Other';
  document.getElementById('genre').textContent = g;
  var style = GENRE_STYLES[g] || GENRE_STYLES.Other;
  var badge = document.getElementById('genreBadge');
  badge.textContent = g;
  badge.style.background = style.bg;
  badge.style.color = style.fg;

  // 年代（release_year から 1970s のように算出）
  var era = '';
  var yr = String(rec.release_year||'').match(/(\d{4})/);
  if(yr){ var y=parseInt(yr[1],10); if(!isNaN(y)) era = (Math.floor(y/10)*10) + 's'; }
  document.getElementById('era').textContent = era || '-';

  document.getElementById('catalog').textContent = rec.catalog_no || '-';
  document.getElementById('format').textContent  = rec.format || '-';
  document.getElementById('description').textContent = rec.description || '';
  document.getElementById('author').textContent = rec.author ? ('投稿者：' + rec.author) : '';

  setJacket(rec.image_url||'');
  setYouTube(rec.youtube_url||'');
}

/* 通報 */
function ensureClientId(){
  try{
    var k='chaynup_cid';
    var v=localStorage.getItem(k);
    if(!v){ v = 'cid_' + Math.random().toString(36).slice(2); localStorage.setItem(k,v); }
    return v;
  }catch(_){ return ''; }
}
function reportThis(rowIndex){
  var reason = prompt('通報理由を入力してください（例：権利侵害、スパム等）');
  if(!reason) return;
  var msg=document.getElementById('msg');
  msg.className='alert'; msg.textContent='通報送信中…'; msg.classList.add('show');
  google.script.run
    .withSuccessHandler(function(res){
      if(res && res.ok){
        if(res.autoHidden){ msg.textContent='通報を受け付けました（累計閾値に達したため自動的に非表示になりました）。'; }
        else{ msg.textContent='通報を受け付けました。ご協力ありがとうございます。'; }
      }else{
        msg.textContent='通報に失敗しました：' + (res && res.error || 'unknown');
      }
    })
    .withFailureHandler(function(err){
      msg.textContent='通報に失敗しました：' + (err && err.message ? err.message : String(err));
    })
    .submitReport({ sheetName:'Records', rowIndex: Number(rowIndex), reason: reason, client_id: ensureClientId() });
}

/* 起動 */
(function(){

  function rowFromHref(){
    var m = (location.search || location.href).match(/[?&]row=(\d+)/);
    return m ? Number(m[1]) : 0;
  }

  function start(row){
    if(!row){
      var m=document.getElementById('msg');
      m.textContent='レコードID（row）が指定されていません。';
      m.classList.add('show');
      return;
    }
    // ここから先は元の処理と同じ（google.script.run ... render(...)）
    google.script.run
      .withSuccessHandler(function(res){
        if(!res || !res.ok){
          var m=document.getElementById('msg');
          m.textContent='読み込みに失敗しました。';
          m.classList.add('show');
          return;
        }
        render(res.data || {});
        document.getElementById('reportBtn').onclick = function(){ reportThis(row); };
      })
      .withFailureHandler(function(err){
        var m=document.getElementById('msg');
        m.textContent = '読み込みに失敗しました：' + (err && err.message ? err.message : String(err));
        m.classList.add('show');
      })
      .getRecordByRow(Number(row));
  }

  // 1) 公式APIで取得（iframeやリダイレクトでも確実）
  if (google && google.script && google.script.url && google.script.url.getLocation){
    google.script.url.getLocation(function(loc){
      var r = (loc && loc.parameter && loc.parameter.row) ||
              (loc && loc.parameters && loc.parameters.row && loc.parameters.row[0]);
      start(Number(r) || rowFromHref());
    });
  } else {
    // 2) 直接URLから
    start(rowFromHref());
  }

})();
</script>
</body>
</html>
