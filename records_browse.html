<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CHAYNUPZINE — Record View</title>
<link rel="preload" as="image" href="https://etramone7-coder.github.io/chaynupzine/assets/bg_records.webp">
<style>
  :root{ --ink:#222; --panel:rgba(255,255,255,.92); }
  html,body{
    margin:0; background:#f3f5f7; color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    font-size:20px; line-height:1.5;
  }
  .bg{
    position:fixed; inset:0;
    background-image:url("https://etramone7-coder.github.io/chaynupzine/assets/bg_records.webp");
    background-size:cover; background-position:center;
    filter:brightness(.88);
    z-index:0;
  }

  .wrap{max-width:1080px; margin:28px auto; padding:0 16px}
  .panel{
    background:var(--panel); backdrop-filter:saturate(120%) blur(10px);
    border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.16);
    padding:20px; min-height:720px;
    position:relative; z-index:1;
  }

  .topbar{display:flex; justify-content:space-between; gap:12px; align-items:center}
  h1{margin:0; display:flex; gap:12px; align-items:center; font-size:24px}
  .brand{background:#111; color:#fff; border-radius:8px; padding:7px 12px; font-weight:800}

  .btn{border:0; border-radius:14px; padding:10px 14px; font-size:18px; font-weight:800; cursor:pointer}
  .btn.ghost{background:#fff; color:#111; border:1px solid #ddd}
  .btn.warn{background:#fff0f0; color:#a33; border:1px solid #f3b9b9}

  /* 言語トグル（search_records と同じレイアウト） */
  .lang{margin-left:auto; display:flex; flex-direction:column; align-items:flex-end; gap:8px}
  .lang button{border:1px solid #ddd; background:#fff; color:#111; padding:6px 10px; border-radius:10px; font-size:15px; cursor:pointer}
  .lang button.active{background:#111; color:#fff; border-color:#111}

  .grid{display:grid; gap:18px; margin-top:16px}
  @media(min-width:980px){ .grid{grid-template-columns:420px 1fr} }

  /* 左カラム */
  .leftbox{display:flex; flex-direction:column; gap:14px}
  .jacket{
    width:100%; aspect-ratio:1/1; border-radius:14px; background:#f5f5f5;
    display:flex; align-items:center; justify-content:center; overflow:hidden; color:#888
  }
  .jacket img{width:100%; height:100%; object-fit:cover; display:block}

  .ytwrap{position:relative; width:100%; padding-top:56.25%; border-radius:14px; overflow:hidden; background:#000}
  .ytwrap iframe{position:absolute; inset:0; width:100%; height:100%; border:0}

  /* 右カラム */
  .head{display:flex; flex-wrap:wrap; gap:10px; align-items:flex-start}
  .title{min-width:0}
  .band{font-size:26px; font-weight:900; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .track{font-size:20px; color:#444; margin:4px 0 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .badge{padding:8px 12px; border-radius:999px; font-size:16px; font-weight:800; align-self:flex-start}

  .meta{display:grid; gap:8px; margin:10px 0 0}
  .kv{display:flex; gap:10px; align-items:center}
  .k{font-weight:800; color:#555; min-width:7em}
  .v{color:#222}

  .desc{margin-top:14px; white-space:pre-wrap}
  .author{margin-top:10px; color:#555}
  .actions{display:flex; gap:10px; margin-top:16px; flex-wrap:wrap}

  .alert{margin-top:14px; padding:12px; border-radius:12px; border:1px solid #e6e6e6; background:#fff; font-size:16px; display:none}
  .alert.show{display:block}
</style>
</head>
<body>
<div id="bg" class="bg"></div>

<div class="wrap">
  <div class="panel">
    <div class="topbar">
      <h1>
        <span class="brand">CHAYNUPZINE</span>
        <span id="titleSub" style="font-size:16px;color:#555">Record — view</span>
      </h1>
      <div class="actions" style="display:flex;gap:12px;align-items:center">
        <!-- ▼ 上下2ボタンで言語切替（search_records と同様） -->
        <div class="lang">
          <button id="lang-ja" type="button">JP</button>
          <button id="lang-en" type="button">EN</button>
        </div>
        <button class="btn ghost" id="btnBack" type="button"
          onclick="location.href=(function(){var u=location.href.replace(/\/(?:dev|userCodeAppPanel)(?:\?.*)?$/,'/exec');var m=u.match(/^(.*\/exec)/);return (m?m[1]:u);}()) + '?page=search_records'">検索へ戻る</button>
      </div>
    </div>

    <div class="grid">
      <!-- 左 -->
      <div class="leftbox">
        <div class="jacket" id="jacketBox">No image</div>
        <div class="ytwrap" id="ytWrap" style="display:none">
          <iframe id="ytFrame"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen></iframe>
        </div>
      </div>

      <!-- 右 -->
      <div>
        <div class="head">
          <div class="title">
            <h2 class="band" id="band">(Band)</h2>
            <div class="track" id="track">(Track)</div>
          </div>
          <div class="badge" id="genreBadge">GENRE</div>
        </div>

        <div class="meta">
          <div class="kv"><div class="k" id="k-genre">ジャンル</div><div class="v" id="genre">-</div></div>
          <div class="kv"><div class="k" id="k-era">年代</div><div class="v" id="era">-</div></div>
          <div class="kv"><div class="k" id="k-catalog">型番</div><div class="v" id="catalog">-</div></div>
          <div class="kv"><div class="k" id="k-format">フォーマット</div><div class="v" id="format">-</div></div>
        </div>

        <div class="desc" id="description"></div>
        <div class="author" id="author"></div>

        <div class="actions">
          <button class="btn warn" id="reportBtn" type="button">通報する</button>
        </div>
        <div id="msg" class="alert"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* i18n */
var lang = (localStorage.getItem('chay_lang') || ((navigator.language||'ja').toLowerCase().startsWith('en')?'en':'ja'));
var I18N = {
  ja:{
    titleSub:'Record — view',
    back:'検索へ戻る',
    kGenre:'ジャンル', kEra:'年代', kCatalog:'型番', kFormat:'フォーマット',
    authorPrefix:'投稿者：',
    report:'通報する',
    msgNoRow:'レコードID（row）が指定されていません。',
    msgLoadFail:'読み込みに失敗しました。',
    reportPrompt:'通報理由を入力してください（例：権利侵害、スパム等）',
    reportSend:'通報送信中…',
    reportOkAuto:'通報を受け付けました（累計閾値に達したため自動的に非表示になりました）。',
    reportOk:'通報を受け付けました。ご協力ありがとうございます。',
    reportNg:'通報に失敗しました：'
  },
  en:{
    titleSub:'Record — view',
    back:'Back to Search',
    kGenre:'Genre', kEra:'Era', kCatalog:'Catalog No.', kFormat:'Format',
    authorPrefix:'by ',
    report:'Report',
    msgNoRow:'Record ID (row) is not specified.',
    msgLoadFail:'Failed to load.',
    reportPrompt:'Enter a reason for reporting (e.g., copyright infringement, spam).',
    reportSend:'Sending report…',
    reportOkAuto:'Report received (auto-hidden after reaching the threshold).',
    reportOk:'Report received. Thank you.',
    reportNg:'Failed to submit report: '
  }
};
function applyLang(){
  var t = I18N[lang] || I18N.ja;
  document.getElementById('titleSub').textContent = t.titleSub;
  document.getElementById('btnBack').textContent  = t.back;
  document.getElementById('k-genre').textContent  = t.kGenre;
  document.getElementById('k-era').textContent    = t.kEra;
  document.getElementById('k-catalog').textContent= t.kCatalog;
  document.getElementById('k-format').textContent = t.kFormat;
  document.getElementById('reportBtn').textContent= t.report;

  // ボタン状態
  document.getElementById('lang-ja').classList.toggle('active', lang==='ja');
  document.getElementById('lang-en').classList.toggle('active', lang==='en');

  // 説明文・投稿者は render 後に言語反映される（render内でI18N参照）
}
document.getElementById('lang-ja').onclick=function(){
  lang='ja'; localStorage.setItem('chay_lang',lang); applyLang();
  // 説明や投稿者の表記は render 済みデータがあれば即再適用
  if(window.__currentRecord) reapplyTextLang();
};
document.getElementById('lang-en').onclick=function(){
  lang='en'; localStorage.setItem('chay_lang',lang); applyLang();
  if(window.__currentRecord) reapplyTextLang();
};

/* ジャンルごとの色（バッジ） */
var GENRE_STYLES = {
  Punk:{bg:'#111',fg:'#fff'},
  Hardcore:{bg:'#b00020',fg:'#fff'},
  PowerPop:{bg:'#ffd54f',fg:'#111'},
  Indie:{bg:'#4fc3f7',fg:'#111'},
  Garage:{bg:'#8d6e63',fg:'#fff'},
  Mods:{bg:'#607d8b',fg:'#fff'},
  NeoMods:{bg:'#26a69a',fg:'#fff'},
  Metal:{bg:'#424242',fg:'#fff'},
  HardRock:{bg:'#6d4c41',fg:'#fff'},
  Reggae:{bg:'#2e7d32',fg:'#fff'},
  Rock:{bg:'#3949ab',fg:'#fff'},
  Pop:{bg:'#f06292',fg:'#fff'},
  Melodicore:{bg:'#ef6c00',fg:'#fff'},
  Rockabilly:{bg:'#7e57c2',fg:'#fff'},
  Other:{bg:'#9e9e9e',fg:'#fff'}
};

/* 画像 */
function extractDriveId(u){
  try{
    var s=String(u||'');
    var m=s.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if(m) return m[1];
    m=s.match(/[?&]id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
    m=s.match(/uc\?export=view&id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
  }catch(e){}
  return '';
}
function buildImageSources(url){
  var arr=[]; if(!url) return arr;
  if(String(url).indexOf('images.unsplash.com')>=0){
    arr.push(url + (url.indexOf('?')>=0 ? '&w=900' : '?w=900'));
    return arr;
  }
  var id=extractDriveId(url);
  if(id){
    arr.push('https://drive.google.com/uc?export=view&id='+id);
    arr.push('https://drive.google.com/thumbnail?id='+id+'&sz=w900');
  }
  arr.push(url);
  return arr;
}
function setJacket(url){
  var box=document.getElementById('jacketBox'); box.innerHTML='';
  var srcs=buildImageSources(url);
  if(!srcs.length){ box.textContent='No image'; return; }
  var img=new Image(); var i=0; img.loading='lazy';
  function next(){ if(i>=srcs.length){ box.textContent='No image'; return; } img.src=srcs[i++]; }
  img.onerror=next; next(); box.appendChild(img);
}

/* YouTube 埋め込み（URLがあれば iframe で埋め込み表示） */
function setYouTube(u){
  var wrap=document.getElementById('ytWrap');
  var frame=document.getElementById('ytFrame');
  var yt=(u||'').trim();
  if(!yt){ wrap.style.display='none'; frame.src=''; return; }
  var m=yt.match(/(?:youtu\.be\/|v=|embed\/)([A-Za-z0-9_-]{6,})/);
  if(m){
    frame.src='https://www.youtube.com/embed/'+m[1]+'?rel=0&modestbranding=1';
    wrap.style.display='';
  }else{
    wrap.style.display='none';
    frame.src='';
  }
}

/* クエリ */
function q(name){
  return new URL(location.href).searchParams.get(name)||'';
}

/* 言語切替時に本文と投稿者だけ再適用（render後の再描画用） */
function reapplyTextLang(){
  var t = I18N[lang] || I18N.ja;
  var rec = window.__currentRecord || {};
  document.getElementById('description').textContent = rec.description || '';
  document.getElementById('author').textContent = rec.author ? (t.authorPrefix + rec.author) : '';
}

/* レンダリング */
function render(rec){
  window.__currentRecord = rec; // 言語切替で再利用

  var t = I18N[lang] || I18N.ja;

  document.getElementById('band').textContent  = rec.band || '(Band)';
  document.getElementById('track').textContent = rec.track|| '(Track)';

  var g = rec.genre || 'Other';
  document.getElementById('genre').textContent = g;
  var style = GENRE_STYLES[g] || GENRE_STYLES.Other;
  var badge = document.getElementById('genreBadge');
  badge.textContent = g;
  badge.style.background = style.bg;
  badge.style.color = style.fg;

  // 年代
  var era = '';
  var yr = String(rec.release_year||'').match(/(\d{4})/);
  if(yr){ var y=parseInt(yr[1],10); if(!isNaN(y)) era = (Math.floor(y/10)*10) + 's'; }
  document.getElementById('era').textContent = era || '-';

  document.getElementById('catalog').textContent = rec.catalog_no || '-';
  document.getElementById('format').textContent  = rec.format || '-';

  // 説明/投稿者（※多言語本文を用意していないため、現状 description は共通）
  document.getElementById('description').textContent = rec.description || '';
  document.getElementById('author').textContent = rec.author ? (t.authorPrefix + rec.author) : '';

  setJacket(rec.image_url||'');
  setYouTube(rec.youtube_url||'');
}

/* 通報 */
function ensureClientId(){
  try{
    var k='chaynup_cid';
    var v=localStorage.getItem(k);
    if(!v){ v = 'cid_' + Math.random().toString(36).slice(2); localStorage.setItem(k,v); }
    return v;
  }catch(_){ return ''; }
}
function reportThis(rowIndex){
  var t = I18N[lang] || I18N.ja;
  var reason = prompt(t.reportPrompt);
  if(!reason) return;
  var msg=document.getElementById('msg');
  msg.className='alert'; msg.textContent=t.reportSend; msg.classList.add('show');
  google.script.run
    .withSuccessHandler(function(res){
      if(res && res.ok){
        if(res.autoHidden){ msg.textContent=t.reportOkAuto; }
        else{ msg.textContent=t.reportOk; }
      }else{
        msg.textContent=t.reportNg + (res && res.error || 'unknown');
      }
    })
    .withFailureHandler(function(err){
      msg.textContent=t.reportNg + (err && err.message ? err.message : String(err));
    })
    .submitReport({ sheetName:'Records', rowIndex: Number(rowIndex), reason: reason, client_id: ensureClientId() });
}

/* ===== EXEC_URL解決 ＆ GETフォールバック ===== */
(function resolveExecUrl(){
  try{
    var viaQuery = new URL(location.href).searchParams.get('exec') || '';
    var fallback = 'https://script.google.com/macros/s/AKfycbznOw5AqZl9NqA1JvCgZqVI5HmmlIXTWG59CTuRO81s47lwzijy7XDAFOk7SpTQl76HZw/exec';
    window.EXEC_URL = (viaQuery || fallback);
  }catch(_){
    window.EXEC_URL = 'https://script.google.com/macros/s/AKfycbznOw5AqZl9NqA1JvCgZqVI5HmmlIXTWG59CTuRO81s47lwzijy7XDAFOk7SpTQl76HZw/exec';
  }
})();
async function fetchRecordByRowFallback(row){
  if(!window.EXEC_URL) throw new Error('EXEC_URL missing');
  var url = window.EXEC_URL
          + (window.EXEC_URL.indexOf('?')>=0?'&':'?')
          + 'fn=getRecordByRow&payload=' + encodeURIComponent(JSON.stringify({rowIndex:Number(row)}))
          + '&v=' + Date.now();
  var r = await fetch(url, {method:'GET', mode:'cors', cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return r.json();
}

/* 起動 */
(function(){
  applyLang();

  function rowFromHref(){
    var m = (location.search || location.href).match(/[?&]row=(\d+)/);
    return m ? Number(m[1]) : 0;
  }
  function showError(msg){
    var m=document.getElementById('msg');
    m.textContent = msg;
    m.classList.add('show');
  }

  function startWithGoogleRun(row){
    var t = I18N[lang] || I18N.ja;
    google.script.run
      .withSuccessHandler(function(res){
        if(!res || !res.ok){
          showError(t.msgLoadFail);
          return;
        }
        render(res.data || {});
        document.getElementById('reportBtn').onclick = function(){ reportThis(row); };
      })
      .withFailureHandler(function(err){
        showError((I18N[lang]||I18N.ja).msgLoadFail + '：' + (err && err.message ? err.message : String(err)));
      })
      .getRecordByRow(Number(row));
  }

  async function start(row){
    var t = I18N[lang] || I18N.ja;
    if(!row){ showError(t.msgNoRow); return; }

    // 1) WebApp 内なら google.script.run を使用
    try{
      if (window.google && google.script && google.script.run){
        startWithGoogleRun(row);
        return;
      }
    }catch(_){}

    // 2) それ以外（Pages直開き等）は GET フォールバック
    try{
      var res = await fetchRecordByRowFallback(row);
      if(!res || !res.ok){ showError(t.msgLoadFail); return; }
      render(res.data || {});
      document.getElementById('reportBtn').onclick = function(){ reportThis(row); };
    }catch(err){
      showError(t.msgLoadFail + '：' + (err && err.message ? err.message : String(err)));
    }
  }

  start(rowFromHref());
})();
</script>
</body>
</html>
