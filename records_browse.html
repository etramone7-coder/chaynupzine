<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CHAYNUPZINE — Record View</title>
<style>
  :root{ --ink:#222; --panel:rgba(255,255,255,.6); }
  html,body{
    margin:0; background:transparent; color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    font-size:20px; line-height:1.5;
  }
  .bg{
    position:fixed; inset:0;
    background-color:#f3f5f7;
    background-image:url("https://etramone7-coder.github.io/chaynupzine/assets/bg_records.webp");
    background-size:cover; background-position:center;
    filter:brightness(.88); z-index:0;
  }

  .wrap{max-width:1080px; margin:28px auto; padding:0 16px}
  .panel{
    position:relative; z-index:1;
    background:var(--panel); backdrop-filter:saturate(120%) blur(10px);
    border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.6);
    padding:20px; min-height:720px;

    /* ★ 追加：初期描画を軽くする */
    content-visibility:auto;
    contain-intrinsic-size: 1000px;
  }

  /* ▼▼ 修正：ヘッダーを2カラムにして右上に言語ボタン ▼▼ */
  .topbar{
    display:grid;
    grid-template-columns: 1fr auto; /* 左=ロゴ＆戻る / 右=言語トグル */
    align-items:start;
    gap:12px;
    position:relative;
  }
  .top-left{display:flex; flex-direction:column; gap:8px; align-items:flex-start;}
  /* ▲▲ ここまで ▲▲ */

  .brand{background:#111; color:#fff; border-radius:8px; padding:7px 12px; font-weight:800}

  .btn{border:0; border-radius:14px; padding:10px 14px; font-size:18px; font-weight:800; cursor:pointer}
  .btn.ghost{background:#fff; color:#111; border:1px solid #ddd}
  .btn.warn{background:#fff0f0; color:#a33; border:1px solid #f3b9b9}

  .grid{display:grid; gap:18px; margin-top:16px}
  @media(min-width:980px){ .grid{grid-template-columns:420px 1fr} }

  /* 左カラム */
  .leftbox{display:flex; flex-direction:column; gap:14px}
  .jacket{
    width:100%; aspect-ratio:1/1; border-radius:14px; background:#f5f5f5;
    display:flex; align-items:center; justify-content:center; overflow:hidden; color:#888
  }
  .jacket img{width:100%; height:100%; object-fit:cover; display:block}

  .ytwrap{position:relative; width:100%; padding-top:56.25%; border-radius:14px; overflow:hidden; background:#000}
  /* ★ 追加：軽量サムネのプレイボタン */
  #ytPlaceholder{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; cursor:pointer}
  #ytPlaceholder img{width:100%; height:100%; object-fit:cover; display:block}
  #ytPlaceholder .playbtn{
    position:absolute; width:68px; height:48px; border-radius:12px;
    background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center;
    font-weight:800; color:#fff; font-size:18px;
  }

  /* 右カラム */
  .head{display:flex; flex-wrap:wrap; gap:10px; align-items:flex-start}
  .title{min-width:0}
  .band{font-size:26px; font-weight:900; margin:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .track{font-size:20px; color:#444; margin:4px 0 0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .badge{padding:8px 12px; border-radius:999px; font-size:16px; font-weight:800; align-self:flex-start}

  .meta{display:grid; gap:8px; margin:10px 0 0}
  .kv{display:flex; gap:10px; align-items:center}
  .k{font-weight:800; color:#555; min-width:7em}
  .v{color:#222}

  .desc{margin-top:14px; white-space:pre-wrap}
  .author{margin-top:10px; color:#555}
  .actions{display:flex; gap:10px; margin-top:16px; flex-wrap:wrap}

  .alert{margin-top:14px; padding:12px; border-radius:12px; border:1px solid #e6e6e6; background:#fff; font-size:16px; display:none}
  .alert.show{display:block}

  /* 言語トグル（既存） */
  .lang{
    display:flex;
    flex-direction:column;
    gap:6px;
    align-items:flex-start;
  }
  .lang button{
    border:1px solid #ddd;
    background:#fff;
    color:#111;
    padding:6px 10px;
    border-radius:10px;
    font-size:15px;
    cursor:pointer
  }
  .lang button.active{
    background:#111;
    color:#fff;
    border-color:#111
  }

  /* ── 追加の見た目調整（右カラムの言語トグルを右寄せ） ── */
  .topbar .actions{
    display:flex !important;
    flex-direction:column !important;
    align-items:flex-end !important;
    gap:8px !important;
  }
  .topbar .lang{ align-items:flex-end; }
  .topbar .lang button{ min-width:52px; }

  /* 戻るボタンは左寄せのまま */
  #btn-back{ white-space:nowrap; align-self:flex-start; }

  /* 横スクロール抑止とロゴ/見出しの自動縮小 */
  html,body{ max-width:100%; overflow-x:hidden; }
  .brand{ font-size:clamp(16px,5.2vw,22px); padding:6px 10px; }
  h1{ font-size:clamp(18px,4.6vw,24px); }
  #subtitle{ white-space:nowrap; }

  /* ★★★ 追加：編集ツールバー（Livesと同等の最小スタイル） ★★★ */
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
  .in{background:#fff;border:1px solid #ddd;border-radius:10px;padding:8px 10px;font-size:16px}
  .btn.secondary{background:#3949ab;color:#fff}

  /* ★★★ 追加：編集パネル（遅延生成） ★★★ */
  #editPanel{display:none;margin-top:10px;border:1px dashed #ddd;background:#fff;padding:10px;border-radius:12px}
  .row2{display:grid;gap:10px}
  @media(min-width:720px){ .row2{grid-template-columns:1fr 1fr} }
  .lab{font-size:14px;color:#555;font-weight:800;margin-top:6px}
  .ta{min-height:120px;white-space:pre-wrap}
</style>
</head>
<body>
<div id="bg" class="bg"></div>

<div class="wrap">
  <div class="panel">
    <div class="topbar">
      <!-- 左：ロゴ＋サブタイトル＋戻る -->
      <div class="top-left">
        <h1>
          <span class="brand">CHAYNUPZINE</span>
          <span id="subtitle" style="font-size:16px;color:#555">Record view</span>
        </h1>
        <!-- ★ 修正：戻るは履歴→フォールバックで search_records.html?lang=.. -->
        <button id="btn-back" class="btn ghost" aria-label="検索へ戻る">検索へ戻る</button>
        <!-- ★ 追加：トップページへ戻る（i18nに連動） -->
        <a class="btn ghost" id="btn-home" href="https://etramone7-coder.github.io/chaynupzine/" target="_top" rel="noopener noreferrer" aria-label="トップへ戻る">トップへ戻る</a>
      </div>

      <!-- 右：言語トグル（右上固定） -->
      <div class="actions" style="display:flex;gap:10px;align-items:center">
        <div class="lang">
          <button id="lang-ja" type="button" aria-label="日本語表示">JP</button>
          <button id="lang-en" type="button" aria-label="英語表示">EN</button>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- 左 -->
      <div class="leftbox">
        <div class="jacket" id="jacketBox">No image</div>
        <!-- 既存の埋め込み枠（このページで使います） -->
        <div class="ytwrap" id="ytWrap" style="display:none">
          <!-- ★ 変更：初期は軽量なサムネ（クリックでiframeを生成） -->
          <div id="ytPlaceholder" aria-label="Play YouTube"></div>
        </div>
      </div>

      <!-- 右 -->
      <div>
        <div class="head">
          <div class="title">
            <h2 class="band" id="band">(Band)</h2>
            <div class="track" id="track">(Track)</div>
          </div>
          <div class="badge" id="genreBadge">GENRE</div>
        </div>

        <div class="meta">
          <div class="kv"><div class="k" id="label-genre">ジャンル</div><div class="v" id="genre">-</div></div>
          <div class="kv"><div class="k" id="label-era">年代</div><div class="v" id="era">-</div></div>
          <div class="kv"><div class="k" id="label-catalog">型番</div><div class="v" id="catalog">-</div></div>
          <div class="kv"><div class="k" id="label-format">フォーマット</div><div class="v" id="format">-</div></div>
        </div>

        <div class="desc" id="description"></div>
        <div class="author" id="author"></div>

        <div class="actions">
          <button class="btn warn" id="reportBtn" type="button" aria-label="この投稿を通報">通報する</button>
        </div>
        <div id="msg" class="alert"></div>

        <!-- ★★★ 追加：編集キー入力＋編集（非表示/再表示/更新） ★★★ -->
        <div class="toolbar">
          <span id="tool-cap">投稿を編集/削除</span>
          <button id="btnEdit" class="btn" type="button">編集</button>
          <span id="editControls" style="display:none;align-items:center;gap:8px">
            <input id="editKey" class="in" type="text" placeholder="編集キー">
            <button id="btnHide" class="btn" type="button">非表示</button>
            <button id="btnUnhide" class="btn secondary" type="button">再表示</button>
          </span>
          <span id="editMsg" class="alert"></span>
        </div>

        <!-- ★★★ 追加：編集パネル（初回クリックで生成） ★★★ -->
        <div id="editPanel"></div>
        <!-- ★★★ ここまで追加 ★★★ -->
      </div>
    </div>
  </div>
</div>
<script>
/* 背景：JS も CSS と同じ URL で統一（相対パスでの上書きを防ぐ） */
(function(){
  document.getElementById('bg').style.backgroundImage =
    'url(https://etramone7-coder.github.io/chaynupzine/assets/bg_records.webp)';
})();

/* ジャンルごとの色（バッジ） */
var GENRE_STYLES = {
  Punk:{bg:'#111',fg:'#fff'},
  Hardcore:{bg:'#b00020',fg:'#fff'},
  PowerPop:{bg:'#ffd54f',fg:'#111'},
  Indie:{bg:'#4fc3f7',fg:'#111'},
  Garage:{bg:'#8d6e63',fg:'#fff'},
  Mods:{bg:'#607d8b',fg:'#fff'},
  NeoMods:{bg:'#26a69a',fg:'#fff'},
  Metal:{bg:'#424242',fg:'#fff'},
  HardRock:{bg:'#6d4c41',fg:'#fff'},
  Reggae:{bg:'#2e7d32',fg:'#fff'},
  Rock:{bg:'#3949ab',fg:'#fff'},
  Glam:{bg:'#9c27b0',fg:'#fff'}, /* ★ 追加：Glam */
  Pop:{bg:'#f06292',fg:'#fff'},
  Melodicore:{bg:'#ef6c00',fg:'#fff'},
  Rockabilly:{bg:'#7e57c2',fg:'#fff'},
  Other:{bg:'#9e9e9e',fg:'#fff'}
};

/* ===== i18n（JP/EN 切替） ===== */
var I18N = {
  ja:{
    subtitle:'Record view',
    labels:{ genre:'ジャンル', era:'年代', catalog:'型番', format:'フォーマット',
             report:'通報する', back:'検索へ戻る', home:'トップへ戻る', by:'投稿者：',
             editCap:'投稿を編集/削除', edit:'編集', hide:'非表示', unhide:'再表示', keyPh:'編集キー',
             ok:'完了しました', fail:'失敗しました', needKey:'編集キーを入力してください',
             editGuide:'※どれか一項目でも編集可能。片方の言語だけ埋めてもOK（サーバ側で相互補完）。',
             save:'保存' }
  },
  en:{
    subtitle:'Record view',
    labels:{ genre:'Genre', era:'Era', catalog:'Catalog No.', format:'Format',
             report:'Report', back:'Back to Search', home:'Back to Top', by:'by ',
             editCap:'Edit/Delete this post', edit:'Edit', hide:'Hide', unhide:'Unhide', keyPh:'Edit key',
             ok:'Done', fail:'Failed', needKey:'Please enter your edit key',
             editGuide:'* You can edit any field. Filling only one language is OK (server will backfill the other).',
             save:'Save' }
  }
};
/* ★ デフォルトは常に日本語（localStorage 未設定時） */
var lang = (function(){ var s=localStorage.getItem('chay_lang'); return s?s:'ja'; })();
var currentRecord = null;

function setLangUI(){
  var t = I18N[lang];
  document.getElementById('subtitle').textContent = t.subtitle;
  document.getElementById('label-genre').textContent   = t.labels.genre;
  document.getElementById('label-era').textContent     = t.labels.era;
  document.getElementById('label-catalog').textContent = t.labels.catalog;
  document.getElementById('label-format').textContent  = t.labels.format;
  document.getElementById('reportBtn').textContent     = t.labels.report;
  document.getElementById('btn-back').textContent      = t.labels.back;
  document.getElementById('btn-home').textContent      = t.labels.home;
  document.getElementById('tool-cap').textContent      = t.labels.editCap;
  document.getElementById('btnEdit').textContent       = t.labels.edit;
  document.getElementById('btnHide').textContent       = t.labels.hide;
  document.getElementById('btnUnhide').textContent     = t.labels.unhide;
  var ek = document.getElementById('editKey'); if (ek) ek.placeholder = t.labels.keyPh;

  document.getElementById('lang-ja').classList.toggle('active', lang==='ja');
  document.getElementById('lang-en').classList.toggle('active', lang==='en');

  // データ取得済みなら本文も切替
  if(currentRecord){
    document.getElementById('description').textContent =
      (lang==='en' && currentRecord.description_en) ? currentRecord.description_en : (currentRecord.description||'');
    document.getElementById('author').textContent =
      currentRecord.author ? (t.labels.by + currentRecord.author) : '';
  }
}
document.getElementById('lang-ja').onclick = function(){ lang='ja'; localStorage.setItem('chay_lang',lang); setLangUI(); };
document.getElementById('lang-en').onclick = function(){ lang='en'; localStorage.setItem('chay_lang',lang); setLangUI(); };

/* ★ 追加：戻るボタン（履歴が無い/他ページからの直開きでも確実に戻る） */
(function setupBackButton(){
  function getLangParam(){
    var u=new URL(location.href);
    return u.searchParams.get('lang') || localStorage.getItem('chay_lang') || 'ja';
    }
  document.getElementById('btn-back').addEventListener('click', function(){
    var cameFromSearch = document.referrer && /search_records\.html(\?|$)/.test(document.referrer);
    if (cameFromSearch && history.length > 1){
      history.back();
    } else {
      location.href = 'search_records.html?lang=' + encodeURIComponent(getLangParam());
    }
  });
})();

/* 画像フォールバック（Drive/HTTPS） */
function normalizeHttps(u){
  try{
    if(!u) return '';
    if(/^https:\/\//i.test(u)) return u;
    if(/^http:\/\//i.test(u))  return u.replace(/^http:/i,'https:');
    return u;
  }catch(_){ return String(u||''); }
}
function extractDriveId(u){
  try{
    var s=String(u||'');
    var m=s.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if(m) return m[1];
    m=s.match(/[?&]id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
    m=s.match(/uc\?export=view&id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
  }catch(e){}
  return '';
}
function buildImageSources(url){
  url = normalizeHttps(url);
  var arr=[]; if(!url) return arr;
  var id=extractDriveId(url);
  if(id){
    arr.push('https://drive.google.com/uc?export=view&id='+id);
    arr.push('https://drive.google.com/thumbnail?id='+id+'&sz=w900');
  }
  if(/^https:\/\//i.test(url)) arr.push(url);
  return arr;
}
function setJacket(url){
  var box=document.getElementById('jacketBox'); box.innerHTML='';
  var srcs=buildImageSources(url);
  if(!srcs.length){ box.textContent='No image'; return; }
  var img=new Image(); var i=0; img.loading='lazy';
  function next(){ if(i>=srcs.length){ box.textContent='No image'; return; } img.src=srcs[i++]; }
  img.onerror=next; next(); box.appendChild(img);
}

/* YouTube 埋め込み（安全なID抽出＆サムネ→クリックでiframe） */
function extractYouTubeId(u){
  u = String(u || '');
  if(!u) return '';
  var m = u.match(/(?:youtu\.be\/|v=|embed\/)([A-Za-z0-9_-]{6,})/);
  return m ? m[1] : '';
}
function setYouTube(u){
  var wrap  = document.getElementById('ytWrap');
  var ph    = document.getElementById('ytPlaceholder');
  wrap.style.display = 'none';
  ph.innerHTML = '';
  var id = extractYouTubeId(u||'');
  if(!id){ return; }
  wrap.style.display = '';
  var doThumb = function(){
    var thumb = 'https://img.youtube.com/vi/'+id+'/hqdefault.jpg';
    ph.innerHTML = '<img src="'+thumb+'" alt="YouTube thumbnail"><div class="playbtn">▶</div>';
  };
  if ('requestIdleCallback' in window){ requestIdleCallback(doThumb, {timeout:500}); } else { doThumb(); }
  ph.onclick = function(){
    ph.remove();
    var ifr = document.createElement('iframe');
    ifr.src = 'https://www.youtube.com/embed/'+id+'?rel=0&modestbranding=1&autoplay=1';
    ifr.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
    ifr.setAttribute('allowfullscreen','');
    ifr.style.position='absolute'; ifr.style.inset='0'; ifr.style.width='100%'; ifr.style.height='100%'; ifr.style.border='0';
    wrap.appendChild(ifr);
  };
}

/* レンダリング */
function render(rec){
  currentRecord = rec;

  document.getElementById('band').textContent  = rec.band || '(Band)';
  document.getElementById('track').textContent = rec.track|| '(Track)';

  var g = rec.genre || 'Other';
  document.getElementById('genre').textContent = g;
  var style = GENRE_STYLES[g] || GENRE_STYLES.Other;
  var badge = document.getElementById('genreBadge');
  badge.textContent = g;
  badge.style.background = style.bg;
  badge.style.color = style.fg;

  // 年代（release_year → 1970s 形式）
  var era = '';
  var yr = String(rec.release_year||'').match(/(\d{4})/);
  if(yr){ var y=parseInt(yr[1],10); if(!isNaN(y)) era = (Math.floor(y/10)*10) + 's'; }
  document.getElementById('era').textContent = era || '-';

  document.getElementById('catalog').textContent = rec.catalog_no || '-';
  document.getElementById('format').textContent  = rec.format || '-';

  document.getElementById('description').textContent =
    (lang==='en' && rec.description_en) ? rec.description_en : (rec.description || '');
  document.getElementById('author').textContent =
    rec.author ? ((I18N[lang].labels.by) + rec.author) : '';

  setJacket(rec.image_url||'');
  setYouTube(rec.youtube_url||'');
}

/* 通報（GAS外でも動くフォールバック付き） */
function ensureClientId(){
  try{
    var k='chaynup_cid';
    var v=localStorage.getItem(k);
    if(!v){ v = 'cid_' + Math.random().toString(36).slice(2); localStorage.setItem(k,v); }
    return v;
  }catch(_){ return ''; }
}
async function postReportFallback(payload){
  var url = window.EXEC_URL + (window.EXEC_URL.indexOf('?')>=0?'&':'?') + 'v=' + Date.now();
  var r = await fetch(url, {
    method:'POST', mode:'cors', cache:'no-store',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify({ fn:'submitReport', payload, csrf:(window.__CZ_CSRF||'') })
  });
  if(!r.ok){ throw new Error('HTTP '+r.status); }
  return await r.json();
}
function reportThis(rowIndex){
  var reason = prompt('通報理由を入力してください（例：権利侵害、スパム等）');
  if(!reason) return;
  var msg=document.getElementById('msg');
  msg.className='alert'; msg.textContent='通報送信中…'; msg.classList.add('show');

  function done(res){
    if(res && res.ok){
      if(res.autoHidden){ msg.textContent='通報を受け付けました（累計閾値に達したため自動的に非表示になりました）。'; }
      else{ msg.textContent='通報を受け付けました。ご協力ありがとうございます。'; }
    }else{
      msg.textContent='通報に失敗しました：' + (res && res.error || 'unknown');
    }
  }
  function fail(err){
    msg.textContent='通報に失敗しました：' + (err && err.message ? err.message : String(err));
  }

  try{
    if (window.google && google.script && google.script.run){
      google.script.run
        .withSuccessHandler(done)
        .withFailureHandler(fail)
        .submitReport({ sheetName:'Records', rowIndex: Number(rowIndex), reason: reason, client_id: ensureClientId() });
    }else{
      postReportFallback({ sheetName:'Records', rowIndex: Number(rowIndex), reason: reason, client_id: ensureClientId() })
        .then(done).catch(fail);
    }
  }catch(e){ fail(e); }
}

/* ===== 追加：EXEC_URL解決 ＆ GET→POST フォールバック ===== */
(function resolveExecUrl(){
  try{
    var viaQuery = new URL(location.href).searchParams.get('exec') || '';
    var fallback = 'https://script.google.com/macros/s/AKfycbznOw5AqZl9NqA1JvCgZqVI5HmmlIXTWG59CTuRO81s47lwzijy7XDAFOk7SpTQl76HZw/exec';
    window.EXEC_URL = (viaQuery || fallback);
  }catch(_){
    window.EXEC_URL = 'https://script.google.com/macros/s/AKfycbznOw5AqZl9NqA1JvCgZqVI5HmmlIXTWG59CTuRO81s47lwzijy7XDAFOk7SpTQl76HZw/exec';
  }
})();
async function fetchRecordByRow(row){
  if(!window.EXEC_URL) throw new Error('EXEC_URL missing');

  // 1) GET を試す
  try{
    var url1 = window.EXEC_URL
      + (window.EXEC_URL.indexOf('?')>=0?'&':'?')
      + 'fn=getRecordByRow&payload=' + encodeURIComponent(JSON.stringify({rowIndex:Number(row)}))
      + '&v=' + Date.now();
    var r1 = await fetch(url1, {method:'GET', mode:'cors', cache:'no-store'});
    var ctype = (r1.headers && r1.headers.get && r1.headers.get('content-type')) || '';
    if (r1.ok && ctype.indexOf('application/json') >= 0){
      return await r1.json();
    }
  }catch(_){}

  // 2) 失敗時は POST フォールバック
  var url2 = window.EXEC_URL + (window.EXEC_URL.indexOf('?')>=0?'&':'?') + 'v=' + Date.now();
  var r2 = await fetch(url2, {
    method:'POST', mode:'cors', cache:'no-store',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body: JSON.stringify({ fn:'getRecordByRow', payload:{rowIndex:Number(row)}, csrf:(window.__CZ_CSRF||'') })
  });
  if(!r2.ok){ throw new Error('HTTP '+r2.status); }
  return await r2.json();
}

/* ★★★ 追加：編集（update / hide / unhide） GAS呼び出しラッパー ★★★ */
async function callEditEntry(action, rowIndex, editKey, patch){
  function done(res){
    var m=document.getElementById('editMsg'); m.className='alert show';
    m.textContent = (res && res.ok) ? I18N[lang].labels.ok : (I18N[lang].labels.fail + (res && res.error ? ' : ' + res.error : ''));
    if(res && res.ok && action==='update'){
      // 極力即時反映（体感高速化）
      try{
        Object.assign(currentRecord, patch||{});
        render(currentRecord);
      }catch(_){}
    }
  }
  function fail(err){
    var m=document.getElementById('editMsg'); m.className='alert show';
    m.textContent = I18N[lang].labels.fail + ' : ' + (err && err.message ? err.message : String(err));
  }

  var payload = { sheetName:'Records', rowIndex:Number(rowIndex), edit_key:String(editKey||''), action:String(action||'') };
  if (action==='update'){ payload.patch = patch || {}; }

  try{
    if (window.google && google.script && google.script.run){
      google.script.run.withSuccessHandler(done).withFailureHandler(fail).editEntry(payload);
    }else{
      var url = window.EXEC_URL + (window.EXEC_URL.indexOf('?')>=0?'&':'?') + 'v=' + Date.now();
      var r = await fetch(url, {
        method:'POST', mode:'cors', cache:'no-store',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify({ fn:'editEntry', payload, csrf:(window.__CZ_CSRF||'') })
      });
      if(!r.ok){ throw new Error('HTTP '+r.status); }
      done(await r.json());
    }
  }catch(e){ fail(e); }
}
/* ★★★ 追加：編集パネル（初回クリック時に動的生成） ★★★ */
function ensureEditPanel(){
  var host = document.getElementById('editPanel');
  if (!host || host.__ready) return;
  var t = I18N[lang].labels;

  host.innerHTML = ''
    + '<div class="lab">'+t.editGuide+'</div>'
    + '<div class="row2">'
    + '  <div><div class="lab">BAND</div><input id="e_band" class="in" type="text"></div>'
    + '  <div><div class="lab">TRACK</div><input id="e_track" class="in" type="text"></div>'
    + '</div>'
    + '<div class="row2">'
    + '  <div><div class="lab">'+t.genre+'</div><input id="e_genre" class="in" type="text" placeholder="Punk / Glam / ..."></div>'
    + '  <div><div class="lab">COUNTRY</div><input id="e_country" class="in" type="text" placeholder="Japan / USA / ..."></div>'
    + '</div>'
    + '<div class="row2">'
    + '  <div><div class="lab">'+t.era+'</div><input id="e_release_year" class="in" type="text" placeholder="YYYY"></div>'
    + '  <div><div class="lab">'+t.catalog+'</div><input id="e_catalog_no" class="in" type="text"></div>'
    + '</div>'
    + '<div><div class="lab">'+t.format+'</div><input id="e_format" class="in" type="text" placeholder="7&quot;EP / LP / CD / ..."></div>'
    + '<div class="row2">'
    + '  <div><div class="lab">DESCRIPTION (JA)</div><textarea id="e_description" class="in ta" maxlength="500"></textarea></div>'
    + '  <div><div class="lab">DESCRIPTION (EN)</div><textarea id="e_description_en" class="in ta" maxlength="500"></textarea></div>'
    + '</div>'
    + '<div class="row2">'
    + '  <div><div class="lab">IMAGE URL</div><input id="e_image_url" class="in" type="url" placeholder="https://..."></div>'
    + '  <div><div class="lab">YOUTUBE URL</div><input id="e_youtube_url" class="in" type="url" placeholder="https://youtu.be/..."></div>'
    + '</div>'
    + '<div><div class="lab">'+I18N[lang].labels.by+'</div><input id="e_author" class="in" type="text"></div>'
    + '<div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">'
    + '  <button id="btnSave" class="btn secondary" type="button">'+t.save+'</button>'
    + '</div>';

  // 現在の値を反映
  var r = currentRecord || {};
  function S(id, v){ var el=document.getElementById(id); if(el){ el.value = String(v||''); } }
  S('e_band', r.band);
  S('e_track', r.track);
  S('e_genre', r.genre);
  S('e_country', r.country);
  S('e_release_year', r.release_year);
  S('e_catalog_no', r.catalog_no);
  S('e_format', r.format);
  S('e_description', r.description);
  S('e_description_en', r.description_en);
  S('e_image_url', r.image_url);
  S('e_youtube_url', r.youtube_url);
  S('e_author', r.author);

  // 保存
  document.getElementById('btnSave').onclick = function(){
    var ek = (document.getElementById('editKey')||{}).value || '';
    if(!ek){ alert(I18N[lang].labels.needKey); return; }

    // パッチ（Code.gs の Records 許可キーに合わせる）
    var patch={};
    function P(key, id){ var v=(document.getElementById(id)||{}).value; if(v!=null && v!==currentRecord[key]) patch[key]=v; }
    P('band','e_band'); P('track','e_track'); P('genre','e_genre'); P('country','e_country');
    P('release_year','e_release_year'); P('catalog_no','e_catalog_no'); P('format','e_format');
    P('description','e_description'); P('description_en','e_description_en');
    P('image_url','e_image_url'); P('youtube_url','e_youtube_url'); P('author','e_author');

    if(Object.keys(patch).length===0){
      var m=document.getElementById('editMsg'); m.className='alert show'; m.textContent=I18N[lang].labels.ok; return;
    }

    callEditEntry('update', window.__rowIndex, ek, patch);
  };

  host.__ready = true;
}

/* ★★★ ここまで追加 ★★★ */

/* 起動 */
(function(){
  // 言語UI初期化
  setLangUI();

  function rowFromHref(){
    var m = (location.search || location.href).match(/[?&]row=(\d+)/);
    var n = m ? Number(m[1]) : 0;
    return (Number.isInteger(n) && n>=2) ? n : 0; // row はシート2行目以降のみ許可
  }
  function showError(msg){
    var m=document.getElementById('msg');
    m.textContent = msg;
    m.classList.add('show');
  }

  async function start(row){
    window.__rowIndex = row; /* ★ 追加：編集API用に保持 */

    var t = I18N[lang] || I18N.ja;
    if(!row){ showError(t.subtitle + '：' + 'レコードID（row）が指定されていません。'); return; }

    /* ★ 追加：まずは検索画面から渡されたキャッシュで即時描画 */
    try{
      var cached = sessionStorage.getItem('cz_selected_record');
      if (cached){
        var rec = JSON.parse(cached);
        if (rec && String(rec.__row||rec.rowIndex||rec.id) === String(row)){
          render(rec); // 先に表示して体感を短縮
        }
      }
    }catch(_){}

    // WebApp 内なら google.script.run、そうでなければ fetch フォールバック
    try{
      if (window.google && google.script && google.script.run){
        google.script.run
          .withSuccessHandler(function(res){
            if(!res || !res.ok){ showError(t.subtitle + '：読み込みに失敗しました。'); return; }
            render(res.data || {});
            document.getElementById('reportBtn').onclick = function(){ reportThis(row); };

            /* ★ 編集UIの動作 */
            document.getElementById('btnEdit').onclick = function(){
              var ec=document.getElementById('editControls'); ec.style.display='';
              var ep=document.getElementById('editPanel'); ep.style.display='';
              ensureEditPanel();
            };
            document.getElementById('btnHide').onclick = function(){
              var ek=document.getElementById('editKey').value.trim();
              if(!ek){ alert(I18N[lang].labels.needKey); return; }
              callEditEntry('delete', row, ek);
            };
            document.getElementById('btnUnhide').onclick = function(){
              var ek=document.getElementById('editKey').value.trim();
              if(!ek){ alert(I18N[lang].labels.needKey); return; }
              callEditEntry('unhide', row, ek);
            };

            try{ sessionStorage.setItem('cz_selected_record', JSON.stringify(Object.assign({__row:row}, res.data||{}))); }catch(_){}
          })
          .withFailureHandler(function(err){
            showError('読み込みに失敗しました：' + (err && err.message ? err.message : String(err)));
          })
          .getRecordByRow(Number(row));
        return;
      }
    }catch(_){}

    try{
      var res = await fetchRecordByRow(row);
      if(!res || !res.ok){ showError('読み込みに失敗しました。'); return; }
      render(res.data || {});
      document.getElementById('reportBtn').onclick = function(){ reportThis(row); };

      /* ★ 編集UIの動作（フォールバック時も同様） */
      document.getElementById('btnEdit').onclick = function(){
        var ec=document.getElementById('editControls'); ec.style.display='';
        var ep=document.getElementById('editPanel'); ep.style.display='';
        ensureEditPanel();
      };
      document.getElementById('btnHide').onclick = function(){
        var ek=document.getElementById('editKey').value.trim();
        if(!ek){ alert(I18N[lang].labels.needKey); return; }
        callEditEntry('delete', row, ek);
      };
      document.getElementById('btnUnhide').onclick = function(){
        var ek=document.getElementById('editKey').value.trim();
        if(!ek){ alert(I18N[lang].labels.needKey); return; }
        callEditEntry('unhide', row, ek);
      };

      try{ sessionStorage.setItem('cz_selected_record', JSON.stringify(Object.assign({__row:row}, res.data||{}))); }catch(_){}
    }catch(err){
      showError('読み込みに失敗しました。：' + (err && err.message ? err.message : 'Load failed'));
    }
  }

  // URL の ?row= を見て開始
  start(rowFromHref());
})();
</script>
</body>
</html>
