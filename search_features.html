<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CHAYNUPZINE — Features search</title>
<style>
  :root{
    --ink:#222;
    --card-bg:rgba(255,255,255,.60); /* 透過 0.6 */
    --chip:#eef1f5; --muted:#666; --accent:#111;
  }
  /* ▼ lives と同じ：背景は透明にして下の .bg を見せる */
  html,body{
    height:100%; margin:0; background:transparent; color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; font-size:20px;
  }
  /* ▼ lives と同じ：固定背景（GitHub Pages の画像） */
  .bg{
    position:fixed; inset:0;
    background-color:#f3f5f7;
    background-image:url("https://etramone7-coder.github.io/chaynupzine/assets/bg_features_search.webp");
    background-size:cover; background-position:center;
    filter:brightness(.88);
    z-index:0;
  }
  .wrap{max-width:980px; margin:28px auto; padding:0 16px; position:relative; z-index:1}
  .panel{
    background:var(--card-bg); backdrop-filter:saturate(120%) blur(10px);
    border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.16); padding:20px 20px 12px; min-height:720px;
  }

  .topbar{display:flex; justify-content:space-between; align-items:flex-start; gap:12px}
  h1{font-size:24px; margin:0; display:flex; align-items:center; gap:12px}
  .brand{display:inline-block; background:#111; color:#fff; border-radius:8px; padding:7px 12px; font-weight:800; letter-spacing:.4px}
  .sub{font-size:16px; color:var(--muted)}
  /* ▼ JP/EN を上下に（他ページと統一） */
  .lang{display:flex; flex-direction:column; gap:8px; align-items:flex-end}
  .lang button{border:1px solid #ddd; background:#fff; color:#111; border-radius:12px; padding:8px 12px; cursor:pointer; font-weight:800}
  .lang button.active{background:#111; color:#fff; border-color:#111}

  .row{margin:14px 0 18px; border-top:1px dashed #ddd; padding-top:12px}
  .chips{display:flex; flex-wrap:wrap; gap:12px}
  .chip{padding:12px 16px; border-radius:999px; background:var(--chip); cursor:pointer; font-size:18px; font-weight:700; user-select:none; line-height:1}
  .chip.active{background:var(--accent); color:#fff}
  .sel{font-size:15px; color:var(--muted); margin-top:6px}
  .otherbox{display:inline-flex; gap:8px; align-items:center; margin-top:8px}
  .otherbox input{font-size:16px; padding:10px 12px; border-radius:12px; border:1px solid #ddd; background:#fff; color:#111; min-width:220px}

  .actions{display:flex; justify-content:flex-end; gap:12px; margin:14px 0}
  .btn{border:0; border-radius:14px; padding:12px 16px; background:#111; color:#fff; font-weight:800; cursor:pointer; font-size:18px}
  .btn.ghost{background:#fff; color:#111; border:1px solid #ddd}
  .btn[disabled]{opacity:.5; cursor:not-allowed}

  .grid{display:grid; grid-template-columns:1fr; gap:14px; margin-top:12px}
  @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
  /* ▼ 一覧カードも 0.6 透過（lives の resultbox 相当） */
  .card{padding:14px; background:rgba(255,255,255,.60); border:1px solid #eee; border-radius:12px; color:#333; display:flex; flex-direction:column; gap:6px}
  .title{font-weight:800; font-size:18px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .meta{font-size:13px; color:#666}
  .desc{font-size:14px; color:#444; overflow:hidden; display:-webkit-box; -webkit-line-clamp:3; -webkit-box-orient:vertical}
  .more{margin-top:auto; text-align:right}
  .more a{font-size:13px; color:#2E66CC; text-decoration:none}

  .alert{margin:12px 0; padding:12px; border-radius:14px; background:#ffe9e9; color:#a33; border:1px solid #f6bcbc; font-size:16px; display:none}
  .alert.show{display:block}
</style>
</head>
<body>
<div id="bg" class="bg"></div>

<div class="wrap">
  <div class="panel">
    <div class="topbar">
      <h1>
        <span class="brand">CHAYNUPZINE</span>
        <span class="sub" id="i-sub">Features — search & listing</span>
      </h1>
      <div class="lang">
        <button id="lang-ja" type="button">JP</button>
        <button id="lang-en" type="button">EN</button>
      </div>
    </div>
    <p class="sub" id="i-help">ジャンル / 年代 / 地域 で絞り込みできます（複数可）。どれか1つ選べば検索できます。</p>

    <!-- トップへ戻る -->
    <div class="actions" style="justify-content:flex-start">
      <a class="btn ghost" id="btn-top" href="https://etramone7-coder.github.io/chaynupzine/">トップへ戻る</a>
    </div>

    <!-- ジャンル -->
    <div class="row">
      <div class="chips" id="chips-genre"></div>
      <div class="sel" id="sel-genre"></div>
    </div>

    <!-- 年代 -->
    <div class="row">
      <div class="chips" id="chips-era"></div>
      <div class="sel" id="sel-era"></div>
    </div>

    <!-- 地域 -->
    <div class="row">
      <div class="chips" id="chips-region"></div>
      <div class="otherbox" id="otherbox" style="display:none">
        <span id="i-otherlabel">Other:</span>
        <input id="region-other" type="text" placeholder="Type region">
      </div>
      <div class="sel" id="sel-region"></div>
    </div>

    <div class="actions">
      <button class="btn ghost" id="btn-reset" type="button">リセット</button>
      <button class="btn" id="btn-search" type="button" disabled>検索</button>
    </div>

    <div id="alert" class="alert"></div>
    <div id="results" class="grid"></div>
  </div>
</div>

<script>
/* 背景：保険の再設定（他ページと同じやり方） */
(function(){
  try{
    document.getElementById('bg').style.backgroundImage =
      'url(https://etramone7-coder.github.io/chaynupzine/assets/bg_features_search.webp)';
  }catch(_){}
})();

/* 実行URL：テンプレから注入 or フォールバック */
(function resolveExecUrl(){
  try{
    var injected = (window.EXEC_URL||'<?= EXEC_URL ?>'||'').trim();
    if (!injected || injected.indexOf('<?=')===0) injected = '';
    var fallback='https://script.google.com/macros/s/AKfycbznOw5AqZl9NqA1JvCgZqVI5HmmlIXTWG59CTuRO81s47lwzijy7XDAFOk7SpTQl76HZw/exec';
    window.EXEC_URL = injected || fallback;
  }catch(_){
    window.EXEC_URL='https://script.google.com/macros/s/AKfycbznOw5AqZl9NqA1JvCgZqVI5HmmlIXTWG59CTuRO81s47lwzijy7XDAFOk7SpTQl76HZw/exec';
  }
})();

/* GAS/外部 両対応の listFeatures 呼び出しラッパ（GET→POST(text/plain) フォールバック） */
async function callListFeatures(payload, onOK, onNG){
  try{
    if (window.google && google.script && google.script.run){
      google.script.run.withSuccessHandler(onOK).withFailureHandler(onNG).listFeatures(payload);
      return;
    }
  }catch(_){}

  try{
    const url1 = window.EXEC_URL
      + (window.EXEC_URL.indexOf('?')>=0 ? '&' : '?')
      + 'fn=listFeatures&payload=' + encodeURIComponent(JSON.stringify(payload))
      + '&v=' + Date.now();
    const r1 = await fetch(url1, { method:'GET', mode:'cors', cache:'no-store' });
    const ct = (r1.headers.get('content-type') || '');
    if (r1.ok && ct.indexOf('application/json') >= 0){
      onOK(await r1.json());
      return;
    }
  }catch(_){}

  try{
    const url2 = window.EXEC_URL + (window.EXEC_URL.indexOf('?')>=0 ? '&' : '?') + 'v=' + Date.now();
    const r2 = await fetch(url2, {
      method:'POST',
      mode:'cors',
      cache:'no-store',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify({ fn:'listFeatures', payload, csrf:(window.__CZ_CSRF||'') })
    });
    if(!r2.ok){
      const t = await r2.text().catch(()=> '');
      throw new Error('HTTP '+r2.status+' '+t);
    }
    onOK(await r2.json());
  }catch(err){
    onNG(err || new Error('Load failed'));
  }
}

/* ===== ラベル（多言語） ===== */
var I18N = {
  ja: {
    sub: '特集 — 検索 & 一覧',
    help: 'ジャンル / 年代 / 地域 で絞り込みできます（複数可）。どれか1つ選べば検索できます。',
    genre: 'ジャンル', era: '年代', region: '地域',
    other: 'その他', otherPh: '地域名を入力',
    reset: 'リセット', search: '検索',
    none: '該当する特集がありません。', by: 'by', read: '続きを読む →',
    top:'トップへ戻る'
  },
  en: {
    sub: 'Features — search & listing',
    help: 'Filter by Genre / Era / Region (multi-select). Search is enabled if any condition is selected.',
    genre: 'Genre', era: 'Era', region: 'Region',
    other: 'Other', otherPh: 'Type region',
    reset: 'Reset', search: 'Search',
    none: 'No features match.', by: 'by', read: 'Read more →',
    top:'Back to Top'
  }
};
var curLang = (localStorage.getItem('chay_lang') || 'ja');

/* ===== データ（チップ候補） ===== */
var GENRES = [
  {code:'band',    ja:'BAND（バンド）',        en:'BAND'},
  {code:'label',   ja:'LABEL（レーベル）',      en:'LABEL'},
  {code:'region',  ja:'REGION（国・地域）',     en:'REGION'},
  /* ③ Designer の表記 */
  {code:'designer',ja:'DESIGNER（デザイナー）', en:'DESIGNER'},
  {code:'person',  ja:'PERSON（有名人）',       en:'PERSON'},
  {code:'venue',   ja:'VENUE（ライブ会場）',    en:'VENUE'},
  {code:'movie',   ja:'MOVIE（映画）',          en:'MOVIE'},
  {code:'fanzine', ja:'FANZINE（ファンジン）',  en:'FANZINE'},
  {code:'other',   ja:'OTHER（その他）',        en:'OTHER'}
];
var ERAS = ['1950s','1960s','1970s','1980s','1990s','2000s','2010s','2020s'];
var REGIONS = [
  'Japan','UK','US','Germany','France','Italy','Spain','Australia','Canada',
  'Sweden','Norway','Finland','Netherlands','Belgium','Ireland',
  'New Zealand','Korea','China','Taiwan','Hong Kong','Brazil','Mexico','Other…'
];

/* ===== 状態 ===== */
var state = { genres:[], eras:[], regions:[], regionOtherActive:false, regionOtherText:'' };

/* ===== 共通ユーティリティ ===== */
function chip(label, active, onClick){
  var el = document.createElement('div');
  el.className = 'chip' + (active ? ' active' : '');
  el.textContent = label;
  el.onclick = onClick;
  return el;
}
function hasAny(){
  return state.genres.length>0 || state.eras.length>0 || state.regions.length>0 || (state.regionOtherActive && state.regionOtherText.trim());
}
function updateButtons(){ document.getElementById('btn-search').disabled = !hasAny(); }

/* ===== 描画（ジャンル） ===== */
function drawGenres(){
  var wrap = document.getElementById('chips-genre'); wrap.innerHTML='';
  GENRES.forEach(function(g){
    var label = (curLang==='ja' ? g.ja : g.en);
    var active = state.genres.indexOf(g.code)>=0;
    wrap.appendChild(chip(label, active, function(){
      var i = state.genres.indexOf(g.code);
      if(i>=0) state.genres.splice(i,1); else state.genres.push(g.code);
      drawGenres(); updateSummary(); updateButtons();
    }));
  });
  document.getElementById('sel-genre').textContent =
    (curLang==='ja'?I18N.ja.genre:I18N.en.genre) + ': ' + (state.genres.length? state.genres.join(', ') : (curLang==='ja'?'指定なし':'All'));
}

/* ===== 描画（年代） ===== */
function drawEras(){
  var wrap = document.getElementById('chips-era'); wrap.innerHTML='';
  ERAS.forEach(function(e){
    var active = state.eras.indexOf(e)>=0;
    wrap.appendChild(chip(e, active, function(){
      var i = state.eras.indexOf(e);
      if(i>=0) state.eras.splice(i,1); else state.eras.push(e);
      drawEras(); updateSummary(); updateButtons();
    }));
  });
  document.getElementById('sel-era').textContent =
    (curLang==='ja'?I18N.ja.era:I18N.en.era) + ': ' + (state.eras.length? state.eras.join(', ') : (curLang==='ja'?'指定なし':'All'));
}

/* ===== 描画（地域＋Other） ===== */
function drawRegions(){
  var wrap = document.getElementById('chips-region'); wrap.innerHTML='';
  REGIONS.forEach(function(r){
    var isOther = (r==='Other…');
    var label = isOther ? (curLang==='ja'?I18N.ja.other:I18N.en.other) : r;
    var active = isOther ? state.regionOtherActive : (state.regions.indexOf(r)>=0);
    wrap.appendChild(chip(label, active, function(){
      if(isOther){
        state.regionOtherActive = !state.regionOtherActive;
        document.getElementById('otherbox').style.display = state.regionOtherActive ? '' : 'none';
        if(!state.regionOtherActive){ state.regionOtherText=''; document.getElementById('region-other').value=''; }
      }else{
        var i = state.regions.indexOf(r);
        if(i>=0) state.regions.splice(i,1); else state.regions.push(r);
      }
      drawRegions(); updateSummary(); updateButtons();
    }));
  });
  document.getElementById('sel-region').textContent =
    (curLang==='ja'?I18N.ja.region:I18N.en.region) + ': ' + (
      (state.regions.length? state.regions.join(', ') : '') +
      (state.regionOtherActive && state.regionOtherText.trim() ? (state.regions.length?', ':'')+state.regionOtherText.trim() : '')
      || (curLang==='ja'?'指定なし':'All')
    );
  document.getElementById('i-otherlabel').textContent = (curLang==='ja'?I18N.ja.other:I18N.en.other)+':';
  document.getElementById('region-other').placeholder = (curLang==='ja'?I18N.ja.otherPh:I18N.en.otherPh);
  document.getElementById('otherbox').style.display = state.regionOtherActive ? '' : 'none';
}

/* 入力監視（Otherのテキスト） */
document.addEventListener('input', function(ev){
  if(ev.target && ev.target.id==='region-other'){
    state.regionOtherText = ev.target.value || '';
    updateSummary(); updateButtons();
  }
});

/* ===== サマリー ===== */
function updateSummary(){ updateButtons(); }

/* ===== リセット ===== */
document.getElementById('btn-reset').onclick = function(){
  state = { genres:[], eras:[], regions:[], regionOtherActive:false, regionOtherText:'' };
  document.getElementById('region-other').value='';
  drawGenres(); drawEras(); drawRegions(); updateSummary();
  document.getElementById('results').innerHTML='';
  document.getElementById('alert').className='alert';
  document.getElementById('alert').textContent='';
};

/* ===== 言語切替（縦ボタン） ===== */
function applyLang(){
  var dict = (curLang==='ja'?I18N.ja:I18N.en);
  document.getElementById('i-sub').textContent   = dict.sub;
  document.getElementById('i-help').textContent  = dict.help;
  document.getElementById('btn-reset').textContent = dict.reset;
  document.getElementById('btn-search').textContent = dict.search;
  document.getElementById('btn-top').textContent = dict.top;
  document.getElementById('lang-ja').classList.toggle('active', curLang==='ja');
  document.getElementById('lang-en').classList.toggle('active', curLang==='en');
  drawGenres(); drawEras(); drawRegions(); updateSummary();
}
document.getElementById('lang-ja').onclick = function(){ curLang='ja'; localStorage.setItem('chay_lang','ja'); applyLang(); };
document.getElementById('lang-en').onclick = function(){ curLang='en'; localStorage.setItem('chay_lang','en'); applyLang(); };

/* ★追加：ENプレビュー用の簡易翻訳（キャッシュ付き） */
const _enCache=new Map();
async function ja2en(s){
  const key=(s||'').trim(); if(!key) return '';
  if(_enCache.has(key)) return _enCache.get(key);
  try{
    const r=await fetch('https://translate.googleapis.com/translate_a/single?client=gtx&sl=ja&tl=en&dt=t&q='+encodeURIComponent(key),{cache:'no-store'});
    const j=await r.json(); const out=(j&&j[0])? j[0].map(x=>x[0]).join('') : key;
    _enCache.set(key,out); return out;
  }catch(_){ _enCache.set(key,key); return key; }
}

/* ===== 検索 ===== */
document.getElementById('btn-search').onclick = function(){
  var alertBox = document.getElementById('alert');
  var resultBox = document.getElementById('results');
  alertBox.className='alert'; alertBox.textContent='';
  resultBox.innerHTML = 'Loading…';

  var cond = {
    genres: state.genres.slice(),
    eras: state.eras.slice(),
    regions: (state.regions.slice()).concat(state.regionOtherActive && state.regionOtherText.trim() ? [state.regionOtherText.trim()] : [])
  };

  callListFeatures({ limit: 500, offset: 0 }, async function(res){
    try{
      if(!res || !res.ok){ throw new Error('listFeatures failed'); }
      var items = res.items || [];

      var out = items.filter(function(it){
        if(cond.genres.length){ if(!it.genre || cond.genres.indexOf(String(it.genre))<0) return false; }
        if(cond.eras.length){   if(!it.era   || cond.eras.indexOf(String(it.era))<0)   return false; }
        if(cond.regions.length){
          var R = String(it.region || '').toLowerCase();
          var hit = cond.regions.some(function(r){ return r && R.indexOf(String(r).toLowerCase())>=0; });
          if(!hit) return false;
        }
        return true;
      });

      resultBox.innerHTML='';
      if(!out.length){
        var msg = (curLang==='ja'?I18N.ja.none:I18N.en.none);
        resultBox.innerHTML = '<div class="card">'+msg+'</div>';
        return;
      }

      for (const it of out){
        var card = document.createElement('div');
        card.className='card';
        var by = (curLang==='ja'?I18N.ja.by:I18N.en.by);
        var read = (curLang==='ja'?I18N.ja.read:I18N.en.read);
        var title = String(it.title || '(No title)');
        var author = String(it.author || '');
        var g = String(it.genre || '');
        var e = String(it.era || '');
        var r = String(it.region || '');
        var blurb = String(it.para1_text || it.para2_text || it.para3_text || '').slice(0,160);

        /* ▼ ここだけ追加：ENモードならタイトル＆本文を翻訳してから表示 */
        if (curLang==='en'){
          title = await ja2en(title);
          if (blurb) blurb = await ja2en(blurb);
        }

        var viewUrl = './features_browse.html?row=' + encodeURIComponent(String(it.rowIndex || ''));

        card.innerHTML =
          '<div class="title">'+escapeHtml(title)+'</div>'+
          '<div class="meta">'+escapeHtml([g,e,r].filter(Boolean).join(' • '))+' '+by+' '+escapeHtml(author)+'</div>'+
          '<div class="desc">'+escapeHtml(blurb)+'</div>'+
          '<div class="more"><a href="'+viewUrl+'" target="_top" rel="noopener">'+read+'</a></div>';
        resultBox.appendChild(card);
      }

    }catch(e){
      alertBox.className='alert show';
      alertBox.textContent = 'Error: ' + e.message;
      resultBox.innerHTML='';
    }
  }, function(err){
    alertBox.className='alert show';
    alertBox.textContent = 'Error: ' + (err && err.message ? err.message : String(err));
    resultBox.innerHTML='';
  });
};

/* HTMLエスケープ */
function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g,function(c){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);});
}

/* 初期描画 */
(function init(){
  applyLang();
  drawGenres(); drawEras(); drawRegions(); updateButtons();
})();
</script>
</body>
</html>
