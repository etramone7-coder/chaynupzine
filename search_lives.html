<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CHAYNUPZINE — Lives search</title>
<style>
  :root{ --card-bg: rgba(255,255,255,.92); --chip:#eef1f5; --txt:#222; }
  html,body{
    height:100%; margin:0; background:transparent; color:var(--txt);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; font-size:20px;
  }
  .bg{
    position:fixed; inset:0;
    background-color:#f3f5f7;
    background-image:url("https://etramone7-coder.github.io/chaynupzine/assets/bg_lives_search.webp");
    background-size:cover; background-position:center;
    filter:brightness(.88);
    z-index:0;
  }
  .wrap{max-width:980px; margin:28px auto; padding:0 16px; position:relative; z-index:1}
  .panel{
    background:rgba(255,255,255,0.6); backdrop-filter:saturate(120%) blur(10px);
    border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.16);
    padding:20px 20px 12px; min-height:860px; position:relative
  }
  h1{font-size:24px; margin:0 0 10px; display:flex; align-items:center; gap:12px}
  .brand{display:inline-block; background:#111; color:#fff; border-radius:8px; padding:7px 12px; font-weight:800; letter-spacing:.4px}
  .sub{font-size:16px; color:#555}
  .lang{margin-left:auto; display:flex; flex-direction:column; align-items:flex-end; gap:8px}
  .lang button{padding:6px 12px; font-size:14px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer}
  .lang button.active{background:#111; color:#fff; border-color:#111}
  .chips{display:flex; flex-wrap:wrap; gap:12px; margin:12px 0 8px}
  .chip{padding:12px 16px; border-radius:999px; background:var(--chip); cursor:pointer; font-size:18px; font-weight:700; user-select:none; line-height:1}
  .chip.active{background:#111; color:#fff}
  .row{margin:14px 0 20px; border-top:1px dashed #ddd; padding-top:12px}
  .sel{font-size:15px; color:#666; margin-top:7px}
  .actions{display:flex; justify-content:flex-end; gap:12px; margin:12px 0; align-items:center; flex-wrap:wrap}
  .btn{border:0; border-radius:14px; padding:12px 16px; background:#111; color:#fff; font-weight:800; cursor:pointer; font-size:18px}
  .btn.ghost{background:#fff; color:#111; border:1px solid #ddd}
  .btn[disabled]{opacity:.5; cursor:not-allowed}
  .btn-link{display:inline-block; text-decoration:none}
  .list-compact{display:grid; grid-template-columns:repeat(1,1fr); gap:14px; margin-top:12px}
  .resultbox{padding:12px; background:rgba(255,255,255,0.6); border:1px solid #eee; border-radius:12px; color:#333}
  .alert{margin:12px 0; padding:12px; border-radius:14px; background:#ffe9e9; color:#a33; border:1px solid #f6bcbc; font-size:16px}
  .hidden{display:none!important}
</style>
</head>
<body>
<div id="bg" class="bg"></div>
<div class="wrap">
  <div class="panel">
    <h1>
      <span class="brand">CHAYNUPZINE</span>
      <span class="sub" id="title-sub">Lives — search & listing</span>
      <span class="lang">
        <button id="lang-ja" type="button">JP</button>
        <button id="lang-en" type="button">EN</button>
      </span>
    </h1>
    <p class="sub" id="subtitle">ジャンル / 地方・県 / 月 / バンド頭文字 で絞り込みできます（複数可）。</p>

    <!-- 各フィルタ -->
    <div class="row"><div class="chips" id="chips-genre"></div><div class="sel" id="sel-genre"></div></div>
    <div class="row"><div class="chips" id="chips-region"></div><div class="sel" id="sel-region"></div></div>
    <div class="row" id="pref-row" style="display:none"><div class="chips" id="chips-pref"></div><div class="sel" id="sel-pref"></div></div>
    <div class="row"><div class="chips" id="chips-month"></div><div class="sel" id="sel-month"></div></div>
    <div class="row"><div class="chips" id="chips-initial"></div><div class="sel" id="sel-initial"></div></div>

    <!-- アクション -->
    <div class="actions">
      <a class="btn ghost btn-link" href="https://etramone7-coder.github.io/chaynupzine/" target="_top">トップへ戻る</a>
      <a class="btn ghost btn-link" href="https://etramone7-coder.github.io/chaynupzine/submit_live.html" target="_top">ライブ投稿フォームへ</a>
      <button class="btn ghost" id="btn-reset" type="button">条件リセット</button>
      <button class="btn" id="btn-search" type="button" disabled>検索</button>
    </div>

    <div id="result-alert" class="alert hidden"></div>
    <div id="results" class="list-compact"></div>
    <div class="sel" id="foot-sel"></div>
  </div>
</div>

<script>
(function(){
  var lang = 'ja'; // 初期は必ず日本語

  var TEXTS = {
    ja:{titleSub:"Lives — search & listing",subtitle:"ジャンル / 地方・県 / 月 / バンド頭文字 で絞り込みできます（複数可）。",genre:"ジャンル",region:"地方",pref:"県",month:"月",initial:"バンド頭文字",reset:"条件リセット",search:"検索",none:"指定なし",reading:"読み込み中…",nohit:"該当データがありません。条件を変えて試してください。",fail:"読み込みに失敗しました。",backTop:"トップへ戻る",toForm:"ライブ投稿フォームへ",offi:"公式/イベントページ",status:{scheduled:"開催予定",canceled:"中止",done:"終了"}},
    en:{titleSub:"Lives — search & listing",subtitle:"Filter by Genre / Region-Prefecture / Month / Band Initial (multiple selections allowed).",genre:"Genre",region:"Region",pref:"Prefecture",month:"Month",initial:"Band Initial",reset:"Reset",search:"Search",none:"None",reading:"Loading…",nohit:"No results. Please try different filters.",fail:"Failed to load.",backTop:"Back to Top",toForm:"Go to Live Post Form",offi:"Official/Event page",status:{scheduled:"Scheduled",canceled:"Canceled",done:"Done"}}
  };

  var REGION_MAP = {
    ja:{
      '北海道・東北':['北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県'],
      '関東':['茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県'],
      '中部':['新潟県','富山県','石川県','福井県','山梨県','長野県','岐阜県','静岡県','愛知県'],
      '近畿':['三重県','滋賀県','京都府','大阪府','兵庫県','奈良県','和歌山県'],
      '中国':['鳥取県','島根県','岡山県','広島県','山口県'],
      '四国':['徳島県','香川県','愛媛県','高知県'],
      '九州・沖縄':['福岡県','佐賀県','長崎県','熊本県','大分県','宮崎県','鹿児島県','沖縄県']
    },
    en:{
      'Hokkaido/Tohoku':['Hokkaido','Aomori','Iwate','Miyagi','Akita','Yamagata','Fukushima'],
      'Kanto':['Ibaraki','Tochigi','Gunma','Saitama','Chiba','Tokyo','Kanagawa'],
      'Chubu':['Niigata','Toyama','Ishikawa','Fukui','Yamanashi','Nagano','Gifu','Shizuoka','Aichi'],
      'Kinki':['Mie','Shiga','Kyoto','Osaka','Hyogo','Nara','Wakayama'],
      'Chugoku':['Tottori','Shimane','Okayama','Hiroshima','Yamaguchi'],
      'Shikoku':['Tokushima','Kagawa','Ehime','Kochi'],
      'Kyushu/Okinawa':['Fukuoka','Saga','Nagasaki','Kumamoto','Oita','Miyazaki','Kagoshima','Okinawa']
    }
  };
  var MONTHS = Array.from({length:12}, (_,i)=> (i+1));
  var INITIALS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split('');
  var state = {genre:'', region:'', prefectures:[], months:[], initial:''};

  /* 翻訳キャッシュ（速度改善用） */
  var transCache = {};

  /* ▼ 修正1: 多言語対応した toStatus */
  function toStatus(v){
    var key=String(v||'').toLowerCase();
    return (TEXTS[lang].status[key]||v);
  }

  /* ▼ 修正3: ja2en 関数（キャッシュ対応） */
  async function ja2en(text){
    if(!text) return '';
    if(transCache[text]) return transCache[text];
    try{
      const url="https://script.google.com/macros/s/AKfycbznOw5AqZl9NqA1JvCgZqVI5HmmlIXTWG59CTuRO81s47lwzijy7XDAFOk7SpTQl76HZw/exec";
      const r=await fetch(url+"?fn=ja2en&text="+encodeURIComponent(text));
      if(r.ok){
        const tx=await r.text();
        transCache[text]=tx;
        return tx;
      }
    }catch(_){}
    return text;
  }

  function chipEl(label, active, onClick){
    var el=document.createElement('div');
    el.className='chip'+(active?' active':'');
    el.textContent=label;
    el.onclick=onClick;
    return el;
  }

  function drawGenre(){
    var wrap=document.getElementById('chips-genre');
    wrap.innerHTML='';
    var GENRES = [
      {code:"Punk",label:"Punk"},{code:"Hardcore",label:"Hardcore"},{code:"PowerPop",label:"PowerPop"},
      {code:"Indie",label:"Indie"},{code:"Garage",label:"Garage"},{code:"Mods",label:"Mods"},
      {code:"NeoMods",label:"NeoMods"},{code:"Metal",label:"Metal"},{code:"HardRock",label:"HardRock"},
      {code:"Reggae",label:"Reggae"},{code:"Rock",label:"Rock"},{code:"Pop",label:"Pop"},
      {code:"Melodicore",label:"Melodicore"},{code:"Rockabilly",label:"Rockabilly"},{code:"Other",label:"Other"}
    ];
    GENRES.forEach(function(g){
      wrap.appendChild(chipEl(g.label, state.genre===g.code, function(){
        state.genre=(state.genre===g.code)?'':g.code;
        drawGenre(); updateSels(); updateSearchEnabled();
      }));
    });
    document.getElementById('sel-genre').textContent = TEXTS[lang].genre+': '+(state.genre||TEXTS[lang].none);
  }

  function drawRegion(){
    var wrap=document.getElementById('chips-region');
    wrap.innerHTML='';
    Object.keys(REGION_MAP[lang]).forEach(function(r){
      wrap.appendChild(chipEl(r, state.region===r, function(){
        state.region=(state.region===r)?'':r;
        state.prefectures=[];
        drawRegion(); drawPref(); updateSels(); updateSearchEnabled();
      }));
    });
    document.getElementById('sel-region').textContent=TEXTS[lang].region+': '+(state.region||TEXTS[lang].none);
  }

  function drawPref(){
    var row=document.getElementById('pref-row');
    var wrap=document.getElementById('chips-pref');
    var sel=document.getElementById('sel-pref');
    wrap.innerHTML='';
    if(!state.region){ row.style.display='none'; sel.textContent=''; return; }
    row.style.display='';
    (REGION_MAP[lang][state.region]||[]).forEach(function(p){
      var active=state.prefectures.includes(p);
      wrap.appendChild(chipEl(p,active,function(){
        var i=state.prefectures.indexOf(p);
        if(i>=0) state.prefectures.splice(i,1); else state.prefectures.push(p);
        drawPref(); updateSels(); updateSearchEnabled();
      }));
    });
    sel.textContent=TEXTS[lang].pref+': '+(state.prefectures.length?state.prefectures.join('/'):(TEXTS[lang].none+(lang==='ja'?'（地方のみで検索可）':'')));
  }

  function drawMonth(){
    var wrap=document.getElementById('chips-month');
    wrap.innerHTML='';
    MONTHS.forEach(function(m){
      var active=state.months.includes(m);
      wrap.appendChild(chipEl(m+(lang==='ja'?'月':''), active, function(){
        var i=state.months.indexOf(m);
        if(i>=0) state.months.splice(i,1); else state.months.push(m);
        drawMonth(); updateSels(); updateSearchEnabled();
      }));
    });
    document.getElementById('sel-month').textContent=TEXTS[lang].month+': '+(state.months.length?state.months.join('/') : TEXTS[lang].none);
  }

  function drawInitial(){
    var wrap=document.getElementById('chips-initial');
    wrap.innerHTML='';
    INITIALS.forEach(function(ch){
      wrap.appendChild(chipEl(ch, state.initial===ch, function(){
        state.initial=(state.initial===ch)?'':ch;
        drawInitial(); updateSels(); updateSearchEnabled();
      }));
    });
    document.getElementById('sel-initial').textContent=TEXTS[lang].initial+': '+(state.initial||TEXTS[lang].none);
  }

  /* ▼ カード描画 */
  async function card(it){
    var box = document.createElement('div');
    box.className = 'resultbox';
    box.style.cursor = 'pointer';

    var line1 = document.createElement('div');
    var st = document.createElement('span'); st.textContent = '［'+toStatus(it.status)+'］ ';
    var rp = document.createElement('span'); rp.textContent = [it.region||'', it.prefecture||''].filter(Boolean).join(' / ');
    line1.appendChild(st); line1.appendChild(rp);
    box.appendChild(line1);

    var art = document.createElement('div');
    art.style.fontWeight = '800';
    art.textContent = it.artist || '—';
    box.appendChild(art);

    if(it.title){
      var t = document.createElement('div');
      t.style.opacity = '.9';
      if(lang==='en'){ ja2en(it.title).then(tx=>{t.textContent=tx;}); } else { t.textContent = it.title; }
      box.appendChild(t);
    }

    var meta = document.createElement('div');
    meta.style.opacity = '.85';
    var parts=[];
    if(it.date) parts.push(it.date);
    if(it.open_time) parts.push('OPEN '+it.open_time);
    if(it.start_time) parts.push('START '+it.start_time);
    if(it.venue) parts.push('@ '+it.venue);
    meta.textContent = parts.join('  ');
    box.appendChild(meta);

    if(it.price){
      var pr = document.createElement('div');
      pr.style.opacity = '.85';
      pr.textContent = it.price;
      box.appendChild(pr);
    }

    if(it.description){
      var de = document.createElement('div');
      de.style.marginTop = '6px';
      if(lang==='en'){ ja2en(it.description).then(tx=>{de.textContent=tx;}); } else { de.textContent = it.description; }
      box.appendChild(de);
    }

    var ref = (it.reference_url||'').trim();
    if(ref && ref.startsWith('https://')){
      var a = document.createElement('a');
      a.href = ref; a.target = '_blank'; a.rel='noopener nofollow';
      a.textContent = TEXTS[lang].offi;
      a.style.display='inline-block'; a.style.marginTop='6px'; a.style.color='#1e90ff'; a.style.textDecoration='none';
      box.appendChild(a);
    }

    box.addEventListener('click', function(ev){
      if (ev.target && ev.target.tagName === 'A') return;
      try{ sessionStorage.setItem('cz_selected_live', JSON.stringify(it)); }catch(_){}
      var row = String(it.rowIndex || '');
      var l = localStorage.getItem('cz_lang') || lang;
      location.href = './lives_browse.html?row=' + encodeURIComponent(row) + '&lang=' + encodeURIComponent(l);
    });

    return box;
  }
  function showAlert(msg){
    var el=document.getElementById('result-alert');
    el.textContent=msg; el.classList.remove('hidden');
  }

  async function doSearch(){
    document.getElementById('result-alert').classList.add('hidden');
    var box=document.getElementById('results');
    box.innerHTML='';
    showAlert(TEXTS[lang].reading);

    try{
      const url="https://script.google.com/macros/s/AKfycbznOw5AqZl9NqA1JvCgZqVI5HmmlIXTWG59CTuRO81s47lwzijy7XDAFOk7SpTQl76HZw/exec";
      var r=await fetch(url+"?fn=lives_list");
      if(!r.ok) throw new Error('bad');
      var js=await r.json();
      var items=js.items||[];

      // 条件フィルタ
      var filtered=items.filter(function(it){
        if(state.genre && it.genre!==state.genre) return false;
        if(state.region && it.region!==state.region) return false;
        if(state.prefectures.length && !state.prefectures.includes(it.prefecture)) return false;
        if(state.months.length){
          var m=(it.date||'').match(/-(\d{2})-/);
          if(!m || !state.months.includes(parseInt(m[1],10))) return false;
        }
        if(state.initial){
          var nm=(it.artist||'').replace(/^The\s+/i,'').trim();
          var ini=nm.charAt(0).toUpperCase();
          if(state.initial==='#'){ if(/[A-Z]/.test(ini)) return false; }
          else if(ini!==state.initial) return false;
        }
        return true;
      });

      box.innerHTML='';
      if(!filtered.length){ showAlert(TEXTS[lang].nohit); return; }
      document.getElementById('result-alert').classList.add('hidden');
      for(const it of filtered){
        box.appendChild(await card(it));
      }
    }catch(e){
      console.error(e);
      showAlert(TEXTS[lang].fail);
    }
  }

  function updateSels(){
    var foot=document.getElementById('foot-sel');
    var parts=[];
    if(state.genre) parts.push(TEXTS[lang].genre+':'+state.genre);
    if(state.region) parts.push(TEXTS[lang].region+':'+state.region);
    if(state.prefectures.length) parts.push(TEXTS[lang].pref+':'+state.prefectures.join('/'));
    if(state.months.length) parts.push(TEXTS[lang].month+':'+state.months.join('/'));
    if(state.initial) parts.push(TEXTS[lang].initial+':'+state.initial);
    foot.textContent=parts.join(' , ');
  }

  function updateSearchEnabled(){
    var en=(state.genre||state.region||state.prefectures.length||state.months.length||state.initial);
    document.getElementById('btn-search').disabled=!en;
  }

  function switchLang(to){
    lang=to;
    localStorage.setItem('cz_lang',lang);
    document.getElementById('title-sub').textContent=TEXTS[lang].titleSub;
    document.getElementById('subtitle').textContent=TEXTS[lang].subtitle;
    document.getElementById('btn-reset').textContent=TEXTS[lang].reset;
    document.getElementById('btn-search').textContent=TEXTS[lang].search;

    var btnJa=document.getElementById('lang-ja');
    var btnEn=document.getElementById('lang-en');
    btnJa.classList.remove('active');
    btnEn.classList.remove('active');
    if(lang==='ja') btnJa.classList.add('active'); else btnEn.classList.add('active');

    drawGenre(); drawRegion(); drawPref(); drawMonth(); drawInitial(); updateSels();
    var back=document.querySelector('.actions a.btn-link');
    if(back) back.textContent=TEXTS[lang].backTop;
    var toForm=document.querySelectorAll('.actions a.btn-link')[1];
    if(toForm) toForm.textContent=TEXTS[lang].toForm;
  }

  // 初期化
  document.getElementById('btn-reset').onclick=function(){
    state={genre:'',region:'',prefectures:[],months:[],initial:''};
    drawGenre(); drawRegion(); drawPref(); drawMonth(); drawInitial(); updateSels(); updateSearchEnabled();
  };
  document.getElementById('btn-search').onclick=doSearch;
  document.getElementById('lang-ja').onclick=function(){switchLang('ja');};
  document.getElementById('lang-en').onclick=function(){switchLang('en');};

  // 初期言語は必ず日本語
  var saved=localStorage.getItem('cz_lang');
  if(saved){ switchLang(saved); } else { switchLang('ja'); }

})();
</script>
</body>
</html>
