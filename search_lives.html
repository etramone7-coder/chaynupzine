<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CHAYNUPZINE ｜ ライブ情報検索</title>
<style>
  :root{
    --bg:#0b0f14; --ink:#e7e9ee; --muted:#9aa3af; --panel:#141824; --line:#2b3240;
    --accent:#1e90ff; --good:#58c1a8; --chip:#0e121a; --btn:#111827;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font:16px/1.6 -apple-system,BlinkMacSystemFont,"Hiragino Kaku Gothic ProN",Meiryo,system-ui,sans-serif}
  a{color:inherit;text-decoration:none}

  .wrap{max-width:1200px;margin:0 auto;padding:10px 14px}
  .toolbar{display:flex;gap:8px;justify-content:flex-end;margin:8px 0}
  .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--btn);color:#fff;font-weight:800}
  .btn.alt{background:transparent}

  /* レイアウト：モバイル＝上下分割（上が検索 50vh）, PC＝左右 380px/残り */
  .layout{display:grid;grid-template-rows:50vh auto;gap:14px}
  @media (min-width:960px){
    .layout{grid-template-rows:auto;grid-template-columns:380px 1fr;min-height:calc(100vh - 20px)}
  }

  /* 検索パネル（大きめUI・sticky） */
  .search{
    background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:14px;
    position:sticky;top:8px;overflow:auto
  }
  .h1{font-size:22px;font-weight:900;margin:0 0 6px}
  .lead{color:#d7dbe6;font-size:15px;margin:0 0 10px}

  .sec{margin-top:12px}
  .sec-title{font-weight:900;margin:0 0 6px}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{
    display:inline-grid;place-items:center;height:36px;padding:0 12px;border-radius:999px;
    background:var(--chip);border:1px solid #334155;color:#dbe3f0;font-weight:800;font-size:13px;
    cursor:pointer;user-select:none
  }
  .chip.active{outline:2px solid var(--good)}
  .bar{display:flex;gap:10px;margin-top:12px}
  .bar input{flex:1 1 0;padding:12px 14px;border-radius:10px;border:1px solid var(--line);
             background:#0b1220;color:#e7e9ee;font-size:16px}
  .bar button{padding:12px 16px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:900}

  /* 結果 */
  .results{min-height:40vh}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:14px}
  @media (min-width:960px){ .grid{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .card{background:#0f172a;border:1px solid #243046;border-radius:12px;overflow:hidden}
  .poster{width:100%;aspect-ratio:16/9;object-fit:cover;background:#111}
  .pad{padding:12px}
  .title{font-weight:900}
  .meta{color:#cbd5e1;font-size:13px}
  .tiny{color:#9fb0c6;font-size:12px}

  .pager{display:flex;justify-content:flex-end;gap:8px;margin:10px 0}
  .pager button{padding:9px 12px;border-radius:8px;border:1px solid var(--line);background:var(--btn);color:#e5e7eb;font-weight:800}
  .status{color:var(--muted);font-size:13px;margin:8px 0}
  .status.err{color:#ff6b6b}
</style>
</head>
<body>
<div class="wrap">

  <div class="toolbar">
    <a class="btn alt" href="<?= EXEC_URL ?>">トップへ戻る</a>
    <a class="btn" href="<?= EXEC_URL ?>?page=submit_live">ライブを投稿する</a>
  </div>

  <div class="layout">

    <!-- 上（モバイル）/ 左（PC）：検索 -->
    <section class="search" aria-label="絞り込み">
      <div class="h1">ライブ情報検索</div>
      <p class="lead">フライヤー画像や YouTube リンクで <b>イベントの雰囲気</b> も共有可能。<br>都道府県・地域・ジャンル・月で、クリックしながら絞り込みます。</p>

      <div class="sec">
        <div class="sec-title">ジャンル</div>
        <div class="chips" id="chips-genre">
          <span class="chip" data-genre="">すべて</span>
          <span class="chip" data-genre="punk">Punk</span>
          <span class="chip" data-genre="hardcore">Hardcore</span>
          <span class="chip" data-genre="indie">Indie</span>
          <span class="chip" data-genre="other">Other</span>
        </div>
      </div>

      <div class="sec">
        <div class="sec-title">月</div>
        <div class="chips" id="chips-month">
          <span class="chip" data-month="">全月</span>
          <span class="chip" data-month="1">1</span><span class="chip" data-month="2">2</span>
          <span class="chip" data-month="3">3</span><span class="chip" data-month="4">4</span>
          <span class="chip" data-month="5">5</span><span class="chip" data-month="6">6</span>
          <span class="chip" data-month="7">7</span><span class="chip" data-month="8">8</span>
          <span class="chip" data-month="9">9</span><span class="chip" data-month="10">10</span>
          <span class="chip" data-month="11">11</span><span class="chip" data-month="12">12</span>
        </div>
      </div>

      <div class="sec">
        <div class="sec-title">地域</div>
        <div class="chips" id="chips-region">
          <span class="chip" data-region="">全国</span>
          <span class="chip" data-region="北海道・東北">北海道・東北</span>
          <span class="chip" data-region="関東">関東</span>
          <span class="chip" data-region="中部">中部</span>
          <span class="chip" data-region="近畿">近畿</span>
          <span class="chip" data-region="中国">中国</span>
          <span class="chip" data-region="四国">四国</span>
          <span class="chip" data-region="九州・沖縄">九州・沖縄</span>
        </div>
      </div>

      <div class="sec">
        <div class="sec-title">都道府県</div>
        <div class="chips" id="chips-pref"></div>
      </div>

      <div class="bar">
        <input id="kw" placeholder="アーティスト / 会場 / 補足（例: Gauze / 九龍）" />
        <button id="doSearch">検索</button>
      </div>

      <div class="status" id="status">　</div>
    </section>

    <!-- 下（モバイル）/ 右（PC）：結果 -->
    <section class="results">
      <div id="list" class="grid" aria-live="polite"></div>
      <div class="pager">
        <button id="prev">前へ</button>
        <button id="next">次へ</button>
      </div>
    </section>

  </div>

  <div class="toolbar">
    <a class="btn alt" href="<?= EXEC_URL ?>">トップへ戻る</a>
    <a class="btn" href="<?= EXEC_URL ?>?page=submit_live">ライブを投稿する</a>
  </div>
</div>

<script>
(function(){
  // 都道府県
  const PREFS = ['北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県','茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県','新潟県','富山県','石川県','福井県','山梨県','長野県','岐阜県','静岡県','愛知県','三重県','滋賀県','京都府','大阪府','兵庫県','奈良県','和歌山県','鳥取県','島根県','岡山県','広島県','山口県','徳島県','香川県','愛媛県','高知県','福岡県','佐賀県','長崎県','熊本県','大分県','宮崎県','鹿児島県','沖縄県'];

  // 地域→都道府県
  const REGION_PREFS = {
    '': PREFS, // 全国
    '北海道・東北': ['北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県'],
    '関東': ['茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県'],
    '中部': ['新潟県','富山県','石川県','福井県','山梨県','長野県','岐阜県','静岡県','愛知県'],
    '近畿': ['三重県','滋賀県','京都府','大阪府','兵庫県','奈良県','和歌山県'],
    '中国': ['鳥取県','島根県','岡山県','広島県','山口県'],
    '四国': ['徳島県','香川県','愛媛県','高知県'],
    '九州・沖縄': ['福岡県','佐賀県','長崎県','熊本県','大分県','宮崎県','鹿児島県','沖縄県']
  };

  const el = {
    list:   document.getElementById('list'),
    prev:   document.getElementById('prev'),
    next:   document.getElementById('next'),
    kw:     document.getElementById('kw'),
    go:     document.getElementById('doSearch'),
    status: document.getElementById('status'),
    g: document.getElementById('chips-genre'),
    m: document.getElementById('chips-month'),
    r: document.getElementById('chips-region'),
    p: document.getElementById('chips-pref')
  };

  // 都道府県チップ生成
  function buildPrefChips(prefList){
    const html = ['<span class="chip" data-pref="">全国</span>']
      .concat(prefList.map(p=>`<span class="chip" data-pref="${p}">${p.replace('都','').replace('道','').replace('府','').replace('県','')}</span>`))
      .join('');
    el.p.innerHTML = html;
    singleSelect(el.p, 'pref'); // 初期選択を再設定
  }

  // 単一選択チップ
  function singleSelect(container, dataAttr){
    const first = container.querySelector('.chip');
    if(first){ [...container.querySelectorAll('.chip')].forEach(c=>c.classList.remove('active')); first.classList.add('active'); }
    container.onclick = (e)=>{
      const t = e.target.closest('.chip'); if(!t) return;
      [...container.querySelectorAll('.chip')].forEach(c=>c.classList.remove('active'));
      t.classList.add('active');
      if(container === el.r){
        const region = t.dataset.region || '';
        buildPrefChips(REGION_PREFS[region] || PREFS);
      }
      trigger();
    };
  }

  // 初期化
  singleSelect(el.g, 'genre');
  singleSelect(el.m, 'month');
  singleSelect(el.r, 'region');
  buildPrefChips(PREFS); // 地域=全国で初期化

  let offset=0, limit=24, reqSeq=0, busy=false;

  function filters(){
    const pick = (box,attr)=> box.querySelector('.chip.active')?.dataset[attr] || '';
    return {
      genre: pick(el.g,'genre'),
      month: pick(el.m,'month'),
      region: pick(el.r,'region'),
      prefecture: pick(el.p,'pref'),
      q: (el.kw.value||'').trim()
    };
  }

  function render(items){
    el.list.innerHTML = items.map(it=>{
      const img = it.image_url ? `<img class="poster" src="${it.image_url}" alt="">` : `<div class="poster"></div>`;
      const yt  = it.youtube_url ? ` / <a href="${it.youtube_url}" target="_blank" rel="noopener">YouTube</a>` : '';
      const ref = it.reference_url ? ` / <a href="${it.reference_url}" target="_blank" rel="noopener">参考</a>` : '';
      return `<article class="card">
        ${img}
        <div class="pad">
          <div class="title">${it.artist||'（No Artist）'}</div>
          <div class="meta">${it.date||''} @ ${it.venue||''}（${it.prefecture||''}）</div>
          <div class="tiny">${it.title||''}${yt}${ref}</div>
        </div>
      </article>`;
    }).join('');
  }

  function setStatus(msg,isErr){
    el.status.textContent = msg || '　';
    el.status.classList.toggle('err', !!isErr);
  }

  function run(){
    const f = filters();
    const seq = ++reqSeq;
    busy = true;
    setStatus('検索中…');

    // 月 → date_from/date_to（サーバ側が未対応でも無害）
    let date_from='', date_to='';
    if(f.month){
      const mm = String(f.month).padStart(2,'0');
      date_from=`1970-${mm}-01`; date_to=`2100-${mm}-31`;
    }

    const params = { prefecture:f.prefecture, region:f.region, genre:f.genre, month:f.month, date_from, date_to, limit, offset };

    google.script.run
      .withSuccessHandler(res=>{
        if(seq!==reqSeq) return;
        busy=false;
        if(!res || !res.ok){ setStatus(''); return; }
        let items = res.items || [];
        const q = f.q.toLowerCase();
        if(q){
          items = items.filter(it =>
            (it.artist||'').toLowerCase().includes(q) ||
            (it.title||'').toLowerCase().includes(q) ||
            (it.venue||'').toLowerCase().includes(q) ||
            (it.description||'').toLowerCase().includes(q));
        }
        render(items);
        setStatus(`${res.total||items.length} 件`);
        el.prev.disabled = offset<=0;
        el.next.disabled = (offset+limit >= (res.total||items.length));
      })
      .withFailureHandler(()=>{
        if(seq!==reqSeq) return;
        busy=false;
        setStatus('一時的に取得できませんでした。もう一度お試しください。', true);
      })
      .listLives(params);
  }

  // デバウンス
  let t=null;
  function trigger(){ clearTimeout(t); t=setTimeout(()=>{ offset=0; if(!busy) run(); }, 120); }

  // 操作
  el.go.addEventListener('click', ()=>{ offset=0; run(); });
  el.prev.addEventListener('click', ()=>{ if(offset>0){ offset=Math.max(0,offset-limit); run(); }});
  el.next.addEventListener('click', ()=>{ offset+=limit; run(); });

  // 初回
  run();
})();
</script>
</body>
</html>
