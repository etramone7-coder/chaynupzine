<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CHAYNUPZINE ‚Äî Lives search</title>
<style>
  :root{ --card-bg: rgba(255,255,255,.92); --chip:#eef1f5; --txt:#222; }
  html,body{
    height:100%; margin:0; background:transparent; color:var(--txt);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; font-size:20px;
  }
  .bg{
    position:fixed; inset:0;
    background-color:#f3f5f7;
    background-image:url("https://etramone7-coder.github.io/chaynupzine/assets/bg_lives_search.webp");
    background-size:cover; background-position:center;
    filter:brightness(.88);
    z-index:0;
  }
  .wrap{max-width:980px; margin:28px auto; padding:0 16px; position:relative; z-index:1}
  .panel{
    background:rgba(255,255,255,0.6); backdrop-filter:saturate(120%) blur(10px);
    border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.16);
    padding:20px 20px 12px; min-height:860px; position:relative
  }
  h1{font-size:24px; margin:0 0 10px; display:flex; align-items:center; gap:12px}
  .brand{display:inline-block; background:#111; color:#fff; border-radius:8px; padding:7px 12px; font-weight:800; letter-spacing:.4px}
  .sub{font-size:16px; color:#555}
  .lang{margin-left:auto; display:flex; flex-direction:column; align-items:flex-end; gap:8px}
  .lang button{padding:6px 12px; font-size:14px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer}
  .lang button.active{background:#111; color:#fff; border-color:#111}
  .chips{display:flex; flex-wrap:wrap; gap:12px; margin:12px 0 8px}
  .chip{padding:12px 16px; border-radius:999px; background:var(--chip); cursor:pointer; font-size:18px; font-weight:700; user-select:none; line-height:1}
  .chip.active{background:#111; color:#fff}
  .row{margin:14px 0 20px; border-top:1px dashed #ddd; padding-top:12px}
  .sel{font-size:15px; color:#666; margin-top:7px}
  .actions{display:flex; justify-content:flex-end; gap:12px; margin:12px 0; align-items:center; flex-wrap:wrap}
  .btn{border:0; border-radius:14px; padding:12px 16px; background:#111; color:#fff; font-weight:800; cursor:pointer; font-size:18px}
  .btn.ghost{background:#fff; color:#111; border:1px solid #ddd}
  .btn[disabled]{opacity:.5; cursor:not-allowed}
  .btn-link{display:inline-block; text-decoration:none}
  .list-compact{display:grid; grid-template-columns:repeat(1,1fr); gap:14px; margin-top:12px}
  .resultbox{padding:12px; background:rgba(255,255,255,0.6); border:1px solid #eee; border-radius:12px; color:#333}
  .alert{margin:12px 0; padding:12px; border-radius:14px; background:#ffe9e9; color:#a33; border:1px solid #f6bcbc; font-size:16px}
  .hidden{display:none!important}
</style>
</head>
<body>
<div id="bg" class="bg"></div>
<div class="wrap">
  <div class="panel">
    <h1>
      <span class="brand">CHAYNUPZINE</span>
      <span class="sub" id="title-sub">Lives ‚Äî search & listing</span>
      <span class="lang">
        <button id="lang-ja" type="button">JP</button>
        <button id="lang-en" type="button">EN</button>
      </span>
    </h1>
    <p class="sub" id="subtitle">„Ç∏„É£„É≥„É´ / Âú∞Êñπ„ÉªÁúå / Êúà / „Éê„É≥„ÉâÈ†≠ÊñáÂ≠ó „ÅßÁµû„ÇäËæº„Åø„Åß„Åç„Åæ„ÅôÔºàË§áÊï∞ÂèØÔºâ„ÄÇ</p>
    <!-- „Éï„Ç£„É´„Çø -->
    <div class="row"><div class="chips" id="chips-genre"></div><div class="sel" id="sel-genre"></div></div>
    <div class="row"><div class="chips" id="chips-region"></div><div class="sel" id="sel-region"></div></div>
    <div class="row" id="pref-row" style="display:none"><div class="chips" id="chips-pref"></div><div class="sel" id="sel-pref"></div></div>
    <div class="row"><div class="chips" id="chips-month"></div><div class="sel" id="sel-month"></div></div>
    <div class="row"><div class="chips" id="chips-initial"></div><div class="sel" id="sel-initial"></div></div>

    <div class="actions">
      <a class="btn ghost btn-link" id="btn-top"  href="https://etramone7-coder.github.io/chaynupzine/" target="_top" rel="noopener noreferrer">„Éà„ÉÉ„Éó„Å∏Êàª„Çã</a>
      <a class="btn ghost btn-link" id="btn-form" href="https://etramone7-coder.github.io/chaynupzine/submit_live.html" target="_top" rel="noopener noreferrer">„É©„Ç§„ÉñÊäïÁ®ø„Éï„Ç©„Éº„É†„Å∏</a>
      <button class="btn ghost" id="btn-reset" type="button">Êù°‰ª∂„É™„Çª„ÉÉ„Éà</button>
      <button class="btn" id="btn-search" type="button" disabled>Ê§úÁ¥¢</button>
    </div>

    <div id="result-alert" class="alert hidden"></div>
    <div id="results" class="list-compact"></div>
    <div class="sel" id="foot-sel"></div>
  </div>
</div>
<script>
(function(){
  var lang = localStorage.getItem('cz_lang') || 'ja';

  var TEXTS = {
    ja:{titleSub:"Lives ‚Äî search & listing",subtitle:"„Ç∏„É£„É≥„É´ / Âú∞Êñπ„ÉªÁúå / Êúà / „Éê„É≥„ÉâÈ†≠ÊñáÂ≠ó „ÅßÁµû„ÇäËæº„Åø„Åß„Åç„Åæ„ÅôÔºàË§áÊï∞ÂèØÔºâ„ÄÇ",genre:"„Ç∏„É£„É≥„É´",region:"Âú∞Êñπ",pref:"Áúå",month:"Êúà",initial:"„Éê„É≥„ÉâÈ†≠ÊñáÂ≠ó",reset:"Êù°‰ª∂„É™„Çª„ÉÉ„Éà",search:"Ê§úÁ¥¢",none:"ÊåáÂÆö„Å™„Åó",reading:"Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶",nohit:"Ë©≤ÂΩì„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊù°‰ª∂„ÇíÂ§â„Åà„Å¶Ë©¶„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",fail:"Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ",backTop:"„Éà„ÉÉ„Éó„Å∏Êàª„Çã",toForm:"„É©„Ç§„ÉñÊäïÁ®ø„Éï„Ç©„Éº„É†„Å∏",offi:"ÂÖ¨Âºè/„Ç§„Éô„É≥„Éà„Éö„Éº„Ç∏",status:{scheduled:"ÈñãÂÇ¨‰∫àÂÆö",canceled:"‰∏≠Ê≠¢",done:"ÁµÇ‰∫Ü"}},
    en:{titleSub:"Lives ‚Äî search & listing",subtitle:"Filter by Genre / Region-Prefecture / Month / Band Initial (multiple selections allowed).",genre:"Genre",region:"Region",pref:"Prefecture",month:"Month",initial:"Band Initial",reset:"Reset",search:"Search",none:"None",reading:"Loading‚Ä¶",nohit:"No results. Please try different filters.",fail:"Failed to load.",backTop:"Back to Top",toForm:"Go to Live Post Form",offi:"Official/Event page",status:{scheduled:"Scheduled",canceled:"Canceled",done:"Done"}}
  };
  var GENRES = [
    {code:"Punk",label:"Punk"},{code:"Hardcore",label:"Hardcore"},{code:"PowerPop",label:"PowerPop"},
    {code:"Indie",label:"Indie"},{code:"Garage",label:"Garage"},{code:"Mods",label:"Mods"},
    {code:"NeoMods",label:"NeoMods"},{code:"Metal",label:"Metal"},{code:"HardRock",label:"HardRock"},
    {code:"Reggae",label:"Reggae"},{code:"Rock",label:"Rock"},{code:"Pop",label:"Pop"},
    {code:"Melodicore",label:"Melodicore"},{code:"Rockabilly",label:"Rockabilly"},{code:"Other",label:"Other"}
  ];

  var REGION_MAP = {
    ja:{
      'ÂåóÊµ∑ÈÅì„ÉªÊù±Âåó':['ÂåóÊµ∑ÈÅì','ÈùíÊ£ÆÁúå','Â≤©ÊâãÁúå','ÂÆÆÂüéÁúå','ÁßãÁî∞Áúå','Â±±ÂΩ¢Áúå','Á¶èÂ≥∂Áúå'],
      'Èñ¢Êù±':['Ëå®ÂüéÁúå','Ê†ÉÊú®Áúå','Áæ§È¶¨Áúå','ÂüºÁéâÁúå','ÂçÉËëâÁúå','Êù±‰∫¨ÈÉΩ','Á•ûÂ•àÂ∑ùÁúå'],
      '‰∏≠ÈÉ®':['Êñ∞ÊΩüÁúå','ÂØåÂ±±Áúå','Áü≥Â∑ùÁúå','Á¶è‰∫ïÁúå','Â±±Ê¢®Áúå','Èï∑ÈáéÁúå','Â≤êÈòúÁúå','ÈùôÂ≤°Áúå','ÊÑõÁü•Áúå'],
      'ËøëÁïø':['‰∏âÈáçÁúå','ÊªãË≥ÄÁúå','‰∫¨ÈÉΩÂ∫ú','Â§ßÈò™Â∫ú','ÂÖµÂ∫´Áúå','Â•àËâØÁúå','ÂíåÊ≠åÂ±±Áúå'],
      '‰∏≠ÂõΩ':['È≥•ÂèñÁúå','Â≥∂Ê†πÁúå','Â≤°Â±±Áúå','Â∫ÉÂ≥∂Áúå','Â±±Âè£Áúå'],
      'ÂõõÂõΩ':['Âæ≥Â≥∂Áúå','È¶ôÂ∑ùÁúå','ÊÑõÂ™õÁúå','È´òÁü•Áúå'],
      '‰πùÂ∑û„ÉªÊ≤ñÁ∏Ñ':['Á¶èÂ≤°Áúå','‰ΩêË≥ÄÁúå','Èï∑Â¥éÁúå','ÁÜäÊú¨Áúå','Â§ßÂàÜÁúå','ÂÆÆÂ¥éÁúå','ÈπøÂÖêÂ≥∂Áúå','Ê≤ñÁ∏ÑÁúå']
    },
    en:{
      'Hokkaido/Tohoku':['Hokkaido','Aomori','Iwate','Miyagi','Akita','Yamagata','Fukushima'],
      'Kanto':['Ibaraki','Tochigi','Gunma','Saitama','Chiba','Tokyo','Kanagawa'],
      'Chubu':['Niigata','Toyama','Ishikawa','Fukui','Yamanashi','Nagano','Gifu','Shizuoka','Aichi'],
      'Kinki':['Mie','Shiga','Kyoto','Osaka','Hyogo','Nara','Wakayama'],
      'Chugoku':['Tottori','Shimane','Okayama','Hiroshima','Yamaguchi'],
      'Shikoku':['Tokushima','Kagawa','Ehime','Kochi'],
      'Kyushu/Okinawa':['Fukuoka','Saga','Nagasaki','Kumamoto','Oita','Miyazaki','Kagoshima','Okinawa']
    }
  };

  var MONTHS = Array.from({length:12}, (_,i)=> (i+1));
  var INITIALS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ#'.split('');

  var state = {genre:'', region:'', prefectures:[], months:[], initial:''};

  /* ‚úÖ ÁøªË®≥Èñ¢Êï∞Ôºàsearch_features „Å®ÂêåÁ≠âÔºâ */
  const enCache = new Map();
  async function ja2en(text){
    const key = (text||'').trim();
    if(!key) return '';
    if(enCache.has(key)) return enCache.get(key);
    try{
      const url = 'https://translate.googleapis.com/translate_a/single?client=gtx&sl=ja&tl=en&dt=t&q='+encodeURIComponent(key);
      const r = await fetch(url,{cache:'no-store'});
      const data = await r.json();
      const out = (data && data[0]) ? data[0].map(x=>x[0]).join('') : key;
      enCache.set(key,out);
      return out;
    }catch(_){
      enCache.set(key,key);
      return key;
    }
  }
  (function resolveExecUrl(){
    try{
      var injected = (window.EXEC_URL||'').trim();
      var viaQuery = new URLSearchParams(location.search).get('exec') || '';
      if (!injected || injected.indexOf('<?=') === 0) injected = '';
      var fallback = 'https://script.google.com/macros/s/AKfycbznOw5AqZl9NqA1JvCgZqVI5HmmlIXTWG59CTuRO81s47lwzijy7XDAFOk7SpTQl76HZw/exec';
      window.EXEC_URL = injected || viaQuery || fallback;
    }catch(_){
      window.EXEC_URL = 'https://script.google.com/macros/s/AKfycbznOw5AqZl9NqA1JvCgZqVI5HmmlIXTWG59CTuRO81s47lwzijy7XDAFOk7SpTQl76HZw/exec';
    }
  })();

  async function callListLives(payload, onOK, onNG){
    try{
      if (window.google && google.script && google.script.run){
        google.script.run.withSuccessHandler(onOK).withFailureHandler(onNG).listLives(payload);
        return;
      }
    }catch(_){}
    try{
      var url1 = window.EXEC_URL
        + (window.EXEC_URL.indexOf('?')>=0?'&':'?')
        + 'fn=listLives&payload=' + encodeURIComponent(JSON.stringify(payload))
        + '&v=' + Date.now();
      var r1 = await fetch(url1, {method:'GET', mode:'cors', cache:'no-store', credentials:'omit', redirect:'follow'});
      var ct = r1.headers.get('content-type') || '';
      if (r1.ok && ct.indexOf('application/json')>=0){
        onOK(await r1.json());
        return;
      }
    }catch(_){}

    try{
      var r2 = await fetch(window.EXEC_URL + (window.EXEC_URL.indexOf('?')>=0?'&':'?') + 'v=' + Date.now(), {
        method:'POST', mode:'cors', cache:'no-store', credentials:'omit', redirect:'follow',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify({ fn:'listLives', payload, csrf:(window.__CZ_CSRF||'') })
      });
      if(r2.ok){
        onOK(await r2.json());
        return;
      }
    }catch(_){}

    try{
      var body = new URLSearchParams();
      body.set('fn','listLives');
      body.set('payload', JSON.stringify(payload));
      body.set('csrf', (window.__CZ_CSRF||''));
      var r3 = await fetch(window.EXEC_URL + (window.EXEC_URL.indexOf('?')>=0?'&':'?') + 'v=' + Date.now(), {
        method:'POST', mode:'cors', cache:'no-store', credentials:'omit', redirect:'follow',
        headers:{'Content-Type':'application/x-www-form-urlencoded;charset=utf-8'},
        body: body.toString()
      });
      if(!r3.ok){ throw new Error('HTTP '+r3.status); }
      onOK(await r3.json());
    }catch(err){ onNG(err); }
  }

  function chipEl(label, active, onClick){
    var el=document.createElement('div');
    el.className='chip'+(active?' active':'');
    el.textContent=label;
    el.onclick=onClick;
    return el;
  }

  function drawGenre(){
    var wrap=document.getElementById('chips-genre');
    wrap.innerHTML='';
    GENRES.forEach(function(g){
      wrap.appendChild(chipEl(g.label, state.genre===g.code, function(){
        state.genre=(state.genre===g.code)?'':g.code;
        drawGenre(); updateSels(); updateSearchEnabled();
      }));
    });
    document.getElementById('sel-genre').textContent = TEXTS[lang].genre+': '+(state.genre||TEXTS[lang].none);
  }

  function drawRegion(){
    var wrap=document.getElementById('chips-region');
    wrap.innerHTML='';
    Object.keys(REGION_MAP[lang]).forEach(function(r){
      wrap.appendChild(chipEl(r, state.region===r, function(){
        state.region=(state.region===r)?'':r;
        state.prefectures=[];
        drawRegion(); drawPref(); updateSels(); updateSearchEnabled();
      }));
    });
    document.getElementById('sel-region').textContent=TEXTS[lang].region+': '+(state.region||TEXTS[lang].none);
  }

  function drawPref(){
    var row=document.getElementById('pref-row');
    var wrap=document.getElementById('chips-pref');
    var sel=document.getElementById('sel-pref');
    wrap.innerHTML='';
    if(!state.region){ row.style.display='none'; sel.textContent=''; return; }
    row.style.display='';
    (REGION_MAP[lang][state.region]||[]).forEach(function(p){
      var active=state.prefectures.includes(p);
      wrap.appendChild(chipEl(p,active,function(){
        var i=state.prefectures.indexOf(p);
        if(i>=0) state.prefectures.splice(i,1); else state.prefectures.push(p);
        drawPref(); updateSels(); updateSearchEnabled();
      }));
    });
    sel.textContent=TEXTS[lang].pref+': '+(state.prefectures.length?state.prefectures.join('/'):(TEXTS[lang].none+(lang==='ja'?'ÔºàÂú∞Êñπ„ÅÆ„Åø„ÅßÊ§úÁ¥¢ÂèØÔºâ':'')));
  }

  function drawMonth(){
    var wrap=document.getElementById('chips-month');
    wrap.innerHTML='';
    MONTHS.forEach(function(m){
      var active=state.months.includes(m);
      wrap.appendChild(chipEl(m+(lang==='ja'?'Êúà':''), active, function(){
        var i=state.months.indexOf(m);
        if(i>=0) state.months.splice(i,1); else state.months.push(m);
        drawMonth(); updateSels(); updateSearchEnabled();
      }));
    });
    document.getElementById('sel-month').textContent=TEXTS[lang].month+': '+(state.months.length?state.months.join('/') : TEXTS[lang].none);
  }

  function drawInitial(){
    var wrap=document.getElementById('chips-initial');
    wrap.innerHTML='';
    INITIALS.forEach(function(ch){
      wrap.appendChild(chipEl(ch, state.initial===ch, function(){
        state.initial=(state.initial===ch)?'':ch;
        drawInitial(); updateSels(); updateSearchEnabled();
      }));
    });
    document.getElementById('sel-initial').textContent=TEXTS[lang].initial+': '+(state.initial||TEXTS[lang].none);
  }

  function updateSels(){
    var foot='Êù°‰ª∂: '
      + TEXTS[lang].genre+':' +(state.genre||TEXTS[lang].none)+'„ÄÄ'
      + TEXTS[lang].region+':' +(state.region||TEXTS[lang].none)+'„ÄÄ'
      + (state.region?(TEXTS[lang].pref+':' +(state.prefectures.length?state.prefectures.join('/') : TEXTS[lang].none)+'„ÄÄ'):'')
      + TEXTS[lang].month+':' +(state.months.length?state.months.join('/') : TEXTS[lang].none)+'„ÄÄ'
      + TEXTS[lang].initial+':' +(state.initial||TEXTS[lang].none);
    document.getElementById('foot-sel').textContent=foot;
  }

  function hasAnySelection(){ return state.genre||state.region||state.prefectures.length||state.months.length||state.initial; }
  function updateSearchEnabled(){ document.getElementById('btn-search').disabled=!hasAnySelection(); }

  function toJPStatus(v){ return v==='canceled'?(lang==='ja'?'‰∏≠Ê≠¢':'Canceled'):(v==='done'?(lang==='ja'?'ÁµÇ‰∫Ü':'Done'):(lang==='ja'?'ÈñãÂÇ¨‰∫àÂÆö':'Scheduled')); }
function formatDateTime(str){
  try{
    if(!str) return '';
    const d = new Date(str);
    if(isNaN(d)) return str; // ÁÑ°Âäπ„Å™„Çâ„Åù„ÅÆ„Åæ„ÅæËøî„Åô
    const pad = n => String(n).padStart(2,'0');
    return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate())
      + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes());
  }catch(e){
    return str;
  }
}
  function secureHttps(u){ try{ var s=String(u||'').trim(); return s.startsWith('https://') ? s : ''; }catch(_){ return ''; } }

  async function card(it){
  var box = document.createElement('div');
  box.className = 'resultbox';

  var st = document.createElement('div');
  st.textContent = '[' + toJPStatus(it.status, lang) + ']'
    + (it.region ? ' ' + it.region : '')
    + (it.prefecture ? ' / ' + it.prefecture : '');
  box.appendChild(st);

  var ttl = document.createElement('div');
  ttl.style.fontWeight='700';
  ttl.style.fontSize='18px';
  ttl.textContent = (lang==='en' && it.title) ? await ja2en(it.title) : it.title;
  box.appendChild(ttl);

  var bands = document.createElement('div');
  bands.textContent = it.bands || '';
  box.appendChild(bands);

  var meta = document.createElement('div');
  meta.style.opacity = '.85';
  var parts=[];
  if(it.date) parts.push(formatDateTime(it.date));
  if(it.open_time) parts.push('OPEN ' + formatDateTime(it.open_time));
  if(it.start_time) parts.push('START ' + formatDateTime(it.start_time));
  if(it.venue) parts.push('@ ' + ((lang==='en') ? await ja2en(it.venue) : it.venue));
  meta.textContent = parts.join('  ');
  box.appendChild(meta);

  // üîΩ Ë™¨ÊòéÊñá„ÅÆÂá¶ÁêÜ„Çí‰øÆÊ≠£
  if(it.description){
  var de = document.createElement('div');
  de.style.marginTop = '6px';
  try{
    if(lang === 'en'){
      // Ë™¨ÊòéÊñá„Å†„ÅëËã±Ë™ûÂåñ„ÄÅÂ§±ÊïóÊôÇ„ÅØÂÖÉ„ÅÆÊó•Êú¨Ë™û
      const trans = await ja2en(it.description);
      de.textContent = trans || it.description;
    }else{
      de.textContent = it.description;
    }
  }catch(e){
    de.textContent = it.description;
  }
  box.appendChild(de);
}

  var ref = secureHttps(it.reference_url||'');
  if(ref){
    var a = document.createElement('a');
    a.href = ref; a.target = '_blank'; a.rel='noopener nofollow';
    a.textContent = TEXTS[lang].offi;
    a.style.display='inline-block'; a.style.marginTop='6px';
    a.style.color='#1e90ff'; a.style.textDecoration='none';
    box.appendChild(a);
  }

  return box;
}

  function showAlert(msg, loading){
    var a=document.getElementById('result-alert');
    if(!msg){ a.classList.add('hidden'); a.textContent=''; a.classList.remove('loading'); return; }
    a.textContent=msg; a.classList.remove('hidden'); a.classList.toggle('loading',!!loading);
  }

  function runSearch(){
    var btn = document.getElementById('btn-search');
    if(btn.disabled || !hasAnySelection()){ return; }
    btn.disabled = true;
    showAlert(TEXTS[lang].reading, true);
    document.getElementById('results').innerHTML='';

    var firstPref = state.prefectures && state.prefectures.length ? state.prefectures[0] : '';

    var payload = {
      genre: state.genre || '',
      region: state.region || '',
      prefecture: firstPref || '',
      months: (state.months||[]).slice(0),
      initial: state.initial || '',
      limit: 60,
      offset: 0
    };

    callListLives(payload, async function(res){
      btn.disabled = false;
      if(!res || !res.ok){ showAlert(TEXTS[lang].fail); return; }
      var items = res.items || [];

      items.sort(function(a,b){
        var da = a && a.date ? new Date(a.date) : new Date(0);
        var db = b && b.date ? new Date(b.date) : new Date(0);
        return db - da;
      });

      showAlert('');
      var box = document.getElementById('results');
      if(!items.length){ showAlert(TEXTS[lang].nohit); return; }
      for (const it of items){ box.appendChild(await card(it)); }
    }, function(err){
      btn.disabled = false;
      showAlert(TEXTS[lang].fail + 'Ôºö' + (err && err.message ? err.message : String(err)));
    });
  }

  document.getElementById('btn-reset').onclick=function(){
    state={genre:'', region:'', prefectures:[], months:[], initial:''};
    drawGenre(); drawRegion(); drawPref(); drawMonth(); drawInitial();
    updateSels(); updateSearchEnabled(); document.getElementById('results').innerHTML='';
    document.getElementById('result-alert').classList.add('hidden');
  };
  document.getElementById('btn-search').onclick=runSearch;

  function setLangUI(){
    var T = TEXTS[lang];
    document.getElementById('title-sub').textContent = T.titleSub;
    document.getElementById('subtitle').textContent  = T.subtitle;
    document.getElementById('btn-reset').textContent = T.reset;
    document.getElementById('btn-search').textContent= T.search;
    document.getElementById('btn-top').textContent   = T.backTop;
    document.getElementById('btn-form').textContent  = T.toForm;
    document.getElementById('lang-ja').classList.toggle('active', lang==='ja');
    document.getElementById('lang-en').classList.toggle('active', lang==='en');
    drawGenre(); drawRegion(); drawPref(); drawMonth(); drawInitial(); updateSels();
  }

  document.getElementById('lang-ja').onclick=function(){ lang='ja'; localStorage.setItem('cz_lang',lang); setLangUI(); };
  document.getElementById('lang-en').onclick=function(){ lang='en'; localStorage.setItem('cz_lang',lang); setLangUI(); };

  setLangUI();
  updateSearchEnabled();
})();
</script>
</body>
</html>
