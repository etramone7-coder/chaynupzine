<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CHAYNUPZINE — Records search</title>
<script src="config.js?v=3"></script>
<style>
  :root{ --card-bg: rgba(255,255,255,.92); --chip:#eef1f5; --txt:#222; }
  html,body{ height:100%; margin:0; background:#f3f5f7; color:var(--txt);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif; font-size:20px; }
  .bg{position:fixed; inset:0; background-size:cover; background-position:center; filter:brightness(.88); z-index:-1}
  .wrap{max-width:980px; margin:0 auto; padding:0 16px}
  .panel{ background:var(--card-bg); backdrop-filter:saturate(120%) blur(10px);
    border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.16); padding:20px 20px 12px; min-height:calc(100dvh - 0px); }
  h1{font-size:24px; margin:0 0 10px; display:flex; align-items:center; gap:12px}
  .brand{display:inline-block; background:#111; color:#fff; border-radius:8px; padding:7px 12px; font-weight:800; letter-spacing:.4px}
  .sub{font-size:16px; color:#555}
  .lang{margin-left:auto; display:flex; align-items:center; gap:8px}
  .lang button{border:1px solid #ddd; background:#fff; color:#111; padding:6px 10px; border-radius:10px; font-size:15px; cursor:pointer}
  .lang button.active{background:#111; color:#fff; border-color:#111}
  .chips{display:flex; flex-wrap:wrap; gap:12px; margin:12px 0 8px}
  .chip{padding:12px 16px; border-radius:999px; background:var(--chip); cursor:pointer; font-size:18px; font-weight:700; user-select:none; line-height:1}
  .chip.active{background:#111; color:#fff}
  .row{margin:14px 0 20px; border-top:1px dashed #ddd; padding-top:12px}
  .sel{font-size:15px; color:#666; margin-top:7px}
  .actions{display:flex; justify-content:flex-end; gap:12px; margin:12px 0; align-items:center}
  .btn{border:0; border-radius:14px; padding:12px 16px; background:#111; color:#fff; font-weight:800; cursor:pointer; font-size:18px}
  .btn.ghost{background:#fff; color:#111; border:1px solid #ddd}
  .btn[disabled]{opacity:.6; cursor:progress}
  .btn-link{display:inline-block; text-decoration:none}
  .list-compact{display:grid; grid-template-columns:repeat(1,1fr); gap:14px; margin-top:12px}
  @media(min-width:560px){ .list-compact{grid-template-columns:repeat(2,1fr)} }
  @media(min-width:880px){ .list-compact{grid-template-columns:repeat(3,1fr)} }
  .card{ display:flex; gap:16px; align-items:center; background:#fff; border:1px solid #eee; border-radius:16px;
    padding:12px; cursor:pointer; min-height:180px; }
  .thumb{width:128px; height:128px; border-radius:12px; background:#f5f5f5; flex-shrink:0; display:flex; align-items:center; justify-content:center; font-size:13px; color:#888; overflow:hidden}
  .thumb img{width:100%; height:100%; object-fit:cover; display:block}
  .meta{min-width:0}
  .band{font-weight:900; font-size:19px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .track{font-size:18px; color:#444; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .minor{font-size:15px; color:#777; margin-top:4px}
  .morewrap{text-align:center; margin:12px 0 8px}
  .alert{margin:12px 0; padding:12px; border-radius:14px; background:#ffe9e9; color:#a33; border:1px solid #f6bcbc; font-size:16px}
  .hidden{display:none!important}
  .fullscreen{position:fixed; inset:0; background:#fff; overflow:auto; padding:20px}
  .loading::after{
    content:""; display:inline-block; width:1em; height:1em; margin-left:8px;
    border-radius:50%; border:2px solid #bbb; border-top-color:#111; animation:spin 0.9s linear infinite; vertical-align:-2px;
  }
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
<!-- GAS 直配信時に doGet から渡される（GitHub Pages では無視されるので下でフォールバック） -->
<script>window.EXEC_URL='<?= EXEC_URL ?>';</script>
</head>
<script>window.EXEC_URL = '<?= EXEC_URL ?>';</script>
<body>
<div id="bg" class="bg"></div>

<div class="wrap">
  <div class="panel">
    <h1>
      <span class="brand">CHAYNUPZINE</span>
      <span class="sub" id="title-sub"></span>
      <span class="lang">
        <button id="lang-ja" type="button">JP</button>
        <button id="lang-en" type="button">EN</button>
      </span>
    </h1>
    <p class="sub" id="lead"></p>

    <div class="row"><div class="chips" id="chips-genre"></div><div class="sel" id="sel-genre"></div></div>
    <div class="row"><div class="chips" id="chips-country"></div><div class="sel" id="sel-country"></div></div>
    <div class="row"><div class="chips" id="chips-era"></div><div class="sel" id="sel-era"></div></div>
    <div class="row"><div class="chips" id="chips-initial"></div><div class="sel" id="sel-initial"></div></div>

    <div class="actions">
      <button class="btn ghost" id="btn-reset" type="button"></button>
      <a class="btn ghost btn-link" id="btn-form" href="#" target="_top" rel="noopener noreferrer"></a>
      <button class="btn" id="btn-search" type="button"></button>
    </div>

    <div id="result-alert" class="alert hidden"></div>
    <div id="results" class="list-compact"></div>
    <div class="morewrap"><button id="btn-more" class="btn ghost hidden" type="button"></button></div>
    <div class="sel" id="foot-sel"></div>
  </div>
</div>

<div id="full-list" class="fullscreen hidden">
  <div class="wrap" style="max-width:1100px">
    <div class="actions" style="justify-content:space-between">
      <button class="btn ghost" id="btn-back" type="button"></button>
      <div><span id="full-stat" class="sub"></span></div>
    </div>
    <div id="full-results" class="list-compact" style="grid-template-columns:repeat(auto-fill,minmax(300px,1fr))"></div>
    <div class="morewrap"><button id="btn-full-more" class="btn ghost hidden" type="button"></button></div>
  </div>
</div>

<script>
(function(){
  document.getElementById('bg').style.backgroundImage = 'url(./assets/bg/bg_records_search.webp?v=2)';

  /* ▼変更1（唯一のロジック追加）：
     doGet注入 or ?exec= が無い場合は固定のデプロイURLを使う（毎回クエリ不要） */
  (function resolveExecUrl(){
    try{
      var injected = (window.EXEC_URL||'').trim();
      var viaQuery = new URLSearchParams(location.search).get('exec') || '';
      if (!injected || injected.indexOf('<?=') === 0) injected = '';
      var fallback = 'https://script.google.com/macros/s/AKfycbznOw5AqZl9NqA1JvCgZqVI5HmmlIXTWG59CTuRO81s47lwzijy7XDAFOk7SpTQl76HZw/exec';
      window.EXEC_URL = injected || viaQuery || fallback;
    }catch(_){ window.EXEC_URL = window.EXEC_URL || 'https://script.google.com/macros/s/AKfycbznOw5AqZl9NqA1JvCgZqVI5HmmlIXTWG59CTuRO81s47lwzijy7XDAFOk7SpTQl76HZw/exec'; }
  })();

  // 投稿フォームリンク
  document.getElementById('btn-form').setAttribute('href', window.EXEC_URL ? (window.EXEC_URL + '?page=submit') : '#');

  function isHttpsUrl(u){ try{ return /^https:\/\//i.test(String(u||'')); }catch(_){ return false; } }

  /* ▼変更2：GET → 失敗時POSTのフォールバック（既存方針のまま） */
  async function callListRecords(payload, onOK, onNG){
    try{
      if (window.google && google.script && google.script.run){
        google.script.run.withSuccessHandler(onOK).withFailureHandler(onNG).listRecords(payload);
        return;
      }
    }catch(_){}

    if (!window.EXEC_URL) { onNG(new Error('EXEC_URL is not set')); return; }

    try{
      var url1 = window.EXEC_URL
        + (window.EXEC_URL.indexOf('?')>=0?'&':'?')
        + 'fn=listRecords&payload=' + encodeURIComponent(JSON.stringify(payload))
        + '&v=' + Date.now();
      var res1 = await fetch(url1, { method:'GET', mode:'cors', cache:'no-store' });
      if (res1.ok) { onOK(await res1.json()); return; }
      var url2 = window.EXEC_URL + (window.EXEC_URL.indexOf('?')>=0?'&':'?') + 'v=' + Date.now();
      var res2 = await fetch(url2, {
        method:'POST', mode:'cors', cache:'no-store',
        headers:{'Content-Type':'text/plain;charset=utf-8'},
        body: JSON.stringify({ fn:'listRecords', payload, csrf:(window.__CZ_CSRF||'') })
      });
      if(!res2.ok){ var txt2 = await res2.text().catch(()=> ''); throw new Error('HTTP '+res2.status+' '+(txt2||'')); }
      onOK(await res2.json());
    }catch(err){ onNG(err); }
  }

  /* 以下はそのまま */
  var I18N = {
    ja:{ subTitle:"Records — search & listing",
      lead:"世界各国の曲を記録。ジャンル / 国 / 年代 / 頭文字でクリックして段階的に絞り込みます。同じ曲の重複紹介も可。気に入ったら詳細ページからじっくりどうぞ。",
      labels:{ genre:"ジャンル", country:"国", era:"年代", initial:"頭文字",
        cond:"条件", none:"指定なし", search:"検索", more:"もっと見る", fullMore:"さらに読み込む",
        back:"戻る", reset:"条件リセット", form:"投稿フォームへ",
        reading:"読み込み中…", nohit:"該当データがありません。条件を変えて試してください。",
        fail:"読み込みに失敗しました。" } },
    en:{ subTitle:"Records — search & listing",
      lead:"Browse records worldwide. Narrow down step-by-step by Genre / Country / Era / Initial. Duplicates are welcome.",
      labels:{ genre:"Genre", country:"Country", era:"Era", initial:"Initial",
        cond:"Filters", none:"Not set", search:"Search", more:"Show more", fullMore:"Load more",
        back:"Back", reset:"Reset", form:"Go to Post Form",
        reading:"Loading…", nohit:"No results. Please try different filters.",
        fail:"Failed to load." } }
  };

  var CHIPS = {
    genres:[
      {code:"Punk",label:"Punk"},{code:"Hardcore",label:"Hardcore"},{code:"PowerPop",label:"PowerPop"},
      {code:"Indie",label:"Indie"},{code:"Garage",label:"Garage"},{code:"Mods",label:"Mods"},
      {code:"NeoMods",label:"NeoMods"},{code:"Metal",label:"Metal"},{code:"HardRock",label:"HardRock"},
      {code:"Reggae",label:"Reggae"},{code:"Rock",label:"Rock"},{code:"Pop",label:"Pop"},
      {code:"Melodicore",label:"Melodicore"},{code:"Rockabilly",label:"Rockabilly"},{code:"Other",label:"Other"}
    ],
    countries:["Japan","USA","UK","Germany","France","Italy","Spain","Sweden","Norway","Finland",
      "Netherlands","Belgium","Ireland","Australia","Canada","Brazil","Argentina","Mexico",
      "Korea","China","Taiwan","New Zealand","Poland","Czech","Greece","Turkey","Israel","Other"],
    eras:["1950s","1960s","1970s","1980s","1990s","2000s","2010s","2020s"],
    initials:"ABCDEFGHIJKLMNOPQRSTUVWXYZ#".split("")
  };

  var lang = localStorage.getItem('chay_lang') || (((navigator.language||'ja').toLowerCase().startsWith('en'))?'en':'ja');
  function setLangUI(){
    var t=I18N[lang];
    document.getElementById('title-sub').textContent=t.subTitle;
    document.getElementById('lead').textContent=t.lead;
    document.getElementById('btn-search').textContent=t.labels.search;
    document.getElementById('btn-more').textContent=t.labels.more;
    document.getElementById('btn-full-more').textContent=t.labels.fullMore;
    document.getElementById('btn-back').textContent=t.labels.back;
    document.getElementById('btn-reset').textContent=t.labels.reset;
    document.getElementById('btn-form').textContent=t.labels.form;
    document.getElementById('lang-ja').classList.toggle('active',lang==='ja');
    document.getElementById('lang-en').classList.toggle('active',lang==='en');
    drawAllChips(); makeAllSels();
  }
  document.getElementById('lang-ja').onclick=function(){lang='ja';localStorage.setItem('chay_lang',lang);setLangUI();};
  document.getElementById('lang-en').onclick=function(){lang='en';localStorage.setItem('chay_lang',lang);setLangUI();};

  var state={ genre:'', country:'', era:'', initial:'' };
  var paging={ limitFirst:6, limitList:50, offset:0, total:0 };

  function makeChips(id,items,key){
    var wrap=document.getElementById(id); wrap.innerHTML='';
    items.forEach(function(item){
      var code=(typeof item==='object')?item.code:item;
      var label=(typeof item==='object')?item.label:item;
      var el=document.createElement('div');
      el.className='chip'+(state[key]===code?' active':'');
      el.textContent=label;
      el.onclick=function(){ state[key]=(state[key]===code)?'':code; makeChips(id,items,key); makeAllSels(); };
      wrap.appendChild(el);
    });
  }
  function drawAllChips(){
    makeChips('chips-genre',CHIPS.genres,'genre');
    makeChips('chips-country',CHIPS.countries.map(c=>({code:c,label:c})),'country');
    makeChips('chips-era',CHIPS.eras.map(e=>({code:e,label:e})),'era');
    makeChips('chips-initial',CHIPS.initials.map(i=>({code:i,label:i})),'initial');
  }
  function makeAllSels(){
    var L=I18N[lang].labels;
    document.getElementById('sel-genre').textContent   = L.genre+': '+(state.genre||L.none);
    document.getElementById('sel-country').textContent = L.country+': '+(state.country||L.none);
    document.getElementById('sel-era').textContent     = L.era+': '+(state.era||L.none);
    document.getElementById('sel-initial').textContent = L.initial+': '+(state.initial||L.none);
    document.getElementById('foot-sel').textContent    = L.cond+': '
      +[L.genre+': '+(state.genre||L.none), L.country+': '+(state.country||L.none), L.initial+': '+(state.initial||L.none)].join('　');
  }

  function extractDriveId(u){
    var s=String(u||'');
    var m=s.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if(m) return m[1];
    m=s.match(/[?&]id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
    m=s.match(/uc\?export=view&id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
    return '';
  }
  function buildImageSources(url){
    var arr=[]; if(!url) return arr;
    if(!isHttpsUrl(url)) return arr;
    if(url.indexOf('images.unsplash.com')>=0){ arr.push(url+(url.indexOf('?')>=0?'&':'?')+'w=600'); return arr; }
    var id=extractDriveId(url);
    if(id){ arr.push('https://drive.google.com/uc?export=view&id='+id);
            arr.push('https://drive.google.com/thumbnail?id='+id+'&sz=w600'); }
    arr.push(url); return arr;
  }
  function thumb(url){
    var box=document.createElement('div'); box.className='thumb';
    var srcs=buildImageSources(url);
    if(!srcs.length){ box.textContent='No image'; return box; }
    var img=new Image(); img.loading='lazy'; var i=0;
    function next(){ if(i>=srcs.length){ box.textContent='No image'; return; } img.src=srcs[i++]; }
    img.onerror=next; next(); img.draggable=false; img.style.pointerEvents='none';
    box.appendChild(img); return box;
  }

  function card(item){
    var href = window.EXEC_URL + '?page=records_browse&row=' + encodeURIComponent(String(item.rowIndex||''));
    var a = document.createElement('a');
    a.href   = href;
    a.target = '_top';
    a.rel    = 'noopener noreferrer';

    var el = document.createElement('div'); 
    el.className = 'card';

    var th = thumb(item.image_url || '');
    var img = th.querySelector('img');
    if (img) { img.draggable = false; img.style.pointerEvents = 'none'; }
    el.appendChild(th);

    var m  = document.createElement('div'); m.className='meta';
    var b  = document.createElement('div'); b.className='band';  b.textContent = item.band || '(No band)';
    var tr = document.createElement('div'); tr.className='track'; tr.textContent = item.track || '(No title)';
    var mi = document.createElement('div'); mi.className='minor';
    mi.textContent = (item.country||'-')+' / '+(item.genre||'-')+(item.author?(' / '+(lang==='ja'?'投稿:':'by ')+item.author):'');
    m.appendChild(b); m.appendChild(tr); m.appendChild(mi);
    el.appendChild(m);

    a.appendChild(el);
    return a;
  }

  function showAlert(msg,loading){
    var a=document.getElementById('result-alert');
    if(!msg){ a.classList.add('hidden'); a.textContent=''; a.classList.remove('loading'); return; }
    a.textContent=msg; a.classList.remove('hidden'); a.classList.toggle('loading',!!loading);
  }

  function paramsFor(limit,offset){
    return {genre:state.genre||'', country:state.country||'', era:state.era||'', initial:state.initial||'', limit:limit, offset:offset};
  }

  var searching=false;
  function runFirstSearch(){
    if(searching) return; searching=true;
    var btn=document.getElementById('btn-search'); btn.disabled=true;
    paging.offset=0;
    showAlert(I18N[lang].labels.reading,true);
    document.getElementById('results').innerHTML='';
    callListRecords(paramsFor(paging.limitFirst,0), function(res){
      var L=I18N[lang].labels;
      if(!res||!res.ok){ showAlert(L.fail); searching=false; btn.disabled=false; return; }
      showAlert('');
      paging.total=res.total||0;
      var box=document.getElementById('results');
      (res.items||[]).forEach(function(it){ box.appendChild(card(it)); });
      var more=document.getElementById('btn-more');
      if(paging.total>((res.items||[]).length||0)) more.classList.remove('hidden'); else more.classList.add('hidden');
      if(!(res.items||[]).length) showAlert(L.nohit);
      searching=false; btn.disabled=false;
    }, function(err){
      showAlert(I18N[lang].labels.fail+'：'+(err&&err.message?err.message:String(err)));
      searching=false; btn.disabled=false;
    });
  }
  document.getElementById('btn-search').onclick=runFirstSearch;

  function openFull(){ paging.offset=0; document.getElementById('full-results').innerHTML=''; document.getElementById('full-list').classList.remove('hidden'); loadMoreFull(); }
  function closeFull(){ document.getElementById('full-list').classList.add('hidden'); }
  function loadMoreFull(){
    callListRecords(paramsFor(paging.limitList,paging.offset), function(res){
      if(!res||!res.ok){ showAlert(I18N[lang].labels.fail); return; }
      paging.total=res.total||0;
      var box=document.getElementById('full-results');
      (res.items||[]).forEach(function(it){ box.appendChild(card(it)); });
      paging.offset+=(res.items||[]).length;
      document.getElementById('full-stat').textContent=paging.offset+' / '+paging.total;
      var more=document.getElementById('btn-full-more');
      if(paging.offset<paging.total) more.classList.remove('hidden'); else more.classList.add('hidden');
    }, function(){ showAlert(I18N[lang].labels.fail); });
  }
  document.getElementById('btn-more').onclick=openFull;
  document.getElementById('btn-full-more').onclick=loadMoreFull;
  document.getElementById('btn-back').onclick=closeFull;
  document.getElementById('btn-reset').onclick=function(){ state={genre:'',country:'',era:'',initial:''}; drawAllChips(); makeAllSels(); };

  setLangUI();
})();
</script>
</body>
</html>
