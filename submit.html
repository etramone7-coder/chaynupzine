<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CHAYNUPZINE — 投稿フォーム（レコード紹介）</title>
<style>
  :root{ --panel:rgba(255,255,255,.92); --ink:#222; --chip:#eef1f5; }
  html,body{
    height:100%; margin:0; background:#f3f5f7; color:var(--ink);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    font-size:20px; line-height:1.5;
  }
  /* ★ 追加：全要素のボックスを内側基準にして横はみ出しを防止 */
  *,*::before,*::after{ box-sizing:border-box; }

  .bg{position:fixed; inset:0; background-size:cover; background-position:center;
      filter:brightness(.88); z-index:0;
      background-color:#f3f5f7;
      background-image:url("https://etramone7-coder.github.io/chaynupzine/assets/bg_submit_records.webp");
  }
  .wrap{max-width:980px; margin:28px auto; padding:0 16px;}
  .panel{
    background:var(--panel); backdrop-filter:saturate(120%) blur(10px);
    border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.16);
    padding:20px; min-height:860px;
  }
  h1{margin:0 0 10px; display:flex; align-items:center; gap:12px; font-size:24px;}
  .brand{display:inline-block; background:#111; color:#fff; border-radius:8px;
         padding:7px 12px; font-weight:800; letter-spacing:.4px;}
  .sub{font-size:16px; color:#555; /* ★ 長文でも折り返す */ overflow-wrap:anywhere; }

  /* レイアウト */
  .formgrid{display:grid; gap:16px;}
  @media(min-width:980px){ .formgrid{grid-template-columns: 1fr 360px;} }

  /* 入力 */
  .field{display:flex; flex-direction:column; gap:6px;}
  .field label{font-weight:800; font-size:18px;}
  .input, select, textarea{
    font-size:18px; padding:12px 14px; border-radius:12px; border:1px solid #dcdcdc;
    background:#fff; color:#222; outline:none;
    /* ★ 追加：フォーム幅をカード内に収める */
    width:100%; max-width:100%;
  }
  textarea{min-height:160px; resize:vertical; }
  .row2{display:grid; gap:12px;}
  @media(min-width:640px){ .row2{grid-template-columns:1fr 1fr;} }
  .help{font-size:14px; color:#666; /* ★ 長いURLでも折り返す */ overflow-wrap:anywhere;}
  .counter{font-size:14px; color:#555; text-align:right; margin-top:4px;}
  .consent{margin-top:10px; font-size:14px; color:#333; /* ★ 折り返し */ overflow-wrap:anywhere;}

  /* ボタンなど */
  .actions{display:flex; gap:12px; justify-content:flex-end; margin-top:10px;}
  .btn{border:0; border-radius:14px; padding:12px 16px; font-size:18px;
       font-weight:800; cursor:pointer;}
  .btn.primary{background:#111; color:#fff;}
  .btn.ghost{background:#fff; color:#111; border:1px solid #ddd;}
  .btn[disabled]{opacity:.6; cursor:progress;}
  .alert{margin:12px 0; padding:12px; border-radius:14px; background:#ffe9e9;
         color:#a33; border:1px solid #f6bcbc; font-size:16px; display:none; overflow-wrap:anywhere;}
  .alert.ok{background:#eefcf1; color:#0a7a32; border-color:#c6ecd1; display:block;}
  .alert.err{display:block;}

  /* プレビュー */
  .preview{ background:#fff; border:1px solid #eee; border-radius:16px; padding:16px; }
  .thumb{width:100%; max-width:320px; height:320px; border-radius:14px;
         background:#f5f5f5; display:flex; align-items:center; justify-content:center;
         color:#888; overflow:hidden; margin:0 auto 10px;}
  .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
  .pvtitle{font-weight:900; font-size:19px; text-align:center;}
  .pvmeta {font-size:16px; color:#555; text-align:center; margin-top:2px;}
  .pvdesc {font-size:16px; color:#333; margin-top:10px; white-space:pre-wrap; overflow-wrap:anywhere;}
</style>
</head>
<body>
<div id="bg" class="bg"></div>

<div class="wrap">
  <div class="panel">
    <h1><span class="brand">CHAYNUPZINE</span> <span class="sub">投稿フォーム（レコード紹介）</span></h1>
    <p class="sub">NGワードは自動検知。画像は <b>1枚 10MB以下 / 長辺 3000px以下</b> を推奨。Google Drive共有URLまたは画像直リンクでもOK。</p>

    <div class="formgrid">
      <!-- 左：フォーム本体 -->
      <form id="postForm" novalidate>
        <!-- ジャンル / 国 -->
        <div class="field">
          <label for="genre">GENRE（ジャンル）</label>
          <select id="genre" name="genre" required>
            <option value="">選択してください</option>
            <option>Punk</option><option>Hardcore</option><option>PowerPop</option>
            <option>Indie</option><option>Garage</option><option>Mods</option>
            <option>NeoMods</option><option>Metal</option><option>HardRock</option>
            <option>Reggae</option><option>Rock</option><option>Pop</option>
            <option>Melodicore</option><option>Rockabilly</option><option>Other</option>
          </select>
        </div>
        <div class="field">
          <label for="country">COUNTRY（国名）</label>
          <select id="country" name="country" required>
            <option value="">選択してください</option>
            <option>Japan</option><option>USA</option><option>UK</option><option>Germany</option>
            <option>France</option><option>Italy</option><option>Spain</option><option>Sweden</option>
            <option>Norway</option><option>Finland</option><option>Netherlands</option><option>Belgium</option>
            <option>Ireland</option><option>Australia</option><option>Canada</option><option>Brazil</option>
            <option>Argentina</option><option>Mexico</option><option>Korea</option><option>China</option>
            <option>Taiwan</option><option>New Zealand</option><option>Poland</option><option>Czech</option>
            <option>Greece</option><option>Turkey</option><option>Israel</option><option>Other</option>
          </select>
        </div>

        <!-- バンド / トラック -->
        <div class="field">
          <label for="band">BAND（必須）</label>
          <input id="band" name="band" class="input" placeholder="例: THE RYDERS" required />
        </div>
        <div class="field">
          <label for="track">TRACK（必須）</label>
          <input id="track" name="track" class="input" placeholder="Song title" required />
        </div>

        <!-- 年 / 品番 -->
        <div class="row2">
          <div class="field">
            <label for="release_year">RELEASE YEAR（任意）</label>
            <input id="release_year" name="release_year" class="input" placeholder="YYYY 例: 1983" inputmode="numeric" />
          </div>
          <div class="field">
            <label for="catalog_no">CATALOG NO.（任意）</label>
            <input id="catalog_no" name="catalog_no" class="input" placeholder="例: XXX-001" />
          </div>
        </div>

        <!-- 形態 -->
        <div class="field">
          <label for="format">FORMAT（任意）</label>
          <input id="format" name="format" class="input" placeholder="例: 7&quot;EP / LP / CD / Cassette" />
        </div>

        <!-- 紹介文（500文字、カウンター） -->
        <div class="field">
          <label for="description">DESCRIPTION（紹介文）</label>
          <textarea id="description" name="description" maxlength="500" placeholder="テキストを入力"></textarea>
          <div class="help">※紹介文は500文字以内で入力してください</div>
          <div class="counter" id="descCounter">0 / 500</div>
        </div>

        <!-- 画像URL / アップロード -->
        <div class="field">
          <label for="image_url">JACKET IMAGE URL（任意）</label>
          <input id="image_url" name="image_url" class="input" placeholder="https://drive.google.com/... or https://example.com/..." />
          <div class="help">Drive共有URL/直リンクどちらでも可。下のアップロードと併用OK（URLがあればURL優先）。</div>
        </div>
        <div class="field">
          <label for="upload">UPLOAD IMAGE（jpg/png/webp 任意）</label>
          <input id="upload" name="upload" type="file" accept="image/*" class="input" />
        </div>

        <!-- YouTube / 投稿者 / 編集キー -->
        <div class="field">
          <label for="youtube_url">YOUTUBE URL（任意）</label>
          <input id="youtube_url" name="youtube_url" class="input" placeholder="https://youtu.be/... または https://www.youtube.com/watch?v=xxxxx" />
        </div>
        <div class="row2">
          <div class="field">
            <label for="author">AUTHOR（投稿者・任意）</label>
            <input id="author" name="author" class="input" placeholder="your name" />
          </div>
          <div class="field">
            <label for="edit_key">EDIT KEY（編集キー・必須）</label>
            <!-- ★ 修正: 英数のみのクライアントガードを追加 -->
            <input id="edit_key" name="edit_key" class="input"
              placeholder="半角英数のみ。後の編集・削除時に必要"
              pattern="[A-Za-z0-9]+" inputmode="latin" required />
          </div>
        </div>

        <!-- 免責 同意 -->
        <div class="consent">
          <p>※免責事項：誹謗中傷・差別的表現・個人情報の投稿は禁止です。投稿内容は公開される可能性があります。運営は一切の責任を負いません。</p>
          <label><input type="checkbox" id="consentCheck"> 上記免責事項に同意します</label>
        </div>

        <div class="actions">
          <!-- ★ 追加：トップページへ戻る -->
          <a class="btn ghost" href="index.html" target="_top">トップへ戻る</a>
          <a class="btn ghost" href="?page=records.search" target="_top">検索へ戻る</a>
          <button class="btn primary" type="button" id="submitBtn">投稿</button>
        </div>

        <div id="msg" class="alert"></div>
      </form>

      <!-- 右（PC）／下（モバイル）：プレビュー -->
      <aside class="preview" id="preview">
        <div class="thumb" id="pvThumb">no image</div>
        <div class="pvtitle" id="pvTitle">Band / Track</div>
        <div class="pvmeta"  id="pvMeta">Country / Genre</div>
        <div class="pvdesc"  id="pvDesc">（紹介文がここに反映されます）</div>
      </aside>
    </div>
  </div>
</div>

<script>
/* ▼▼ 追加：GAS実行URL（外部ホスティング用） ▼▼ */
const EXEC_URL = 'https://script.google.com/macros/s/AKfycbxZ9JsvX-BQUrFXLTBSkf9i_MgWxt-fyQygLDQfi2DQWy3qZ7dtc_IObvi3VMYoaCQAxw/exec';
/* 共通送信ラッパー：GAS内なら google.script.run、外部なら fetch(EXEC_URL) */
function callSubmitRecords(payload, onOK, onNG){
  try{
    if (window.google && google.script && google.script.run){
    google.script.run.withSuccessHandler(onOK).withFailureHandler(onNG).submitFromClient(payload);
      return;
    }
  }catch(_){}
  fetch(EXEC_URL, {
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      /* ★追加: CSRFトークンを同送（doGetで window.__CZ_CSRF を注入想定） */
      'X-CSRF-Token': (window.__CZ_CSRF || '')
    },
    body: JSON.stringify({ fn:'submitFromClient', payload })
  }).then(r=>r.json()).then(onOK).catch(onNG);
}
/* ▲▲ ここまで追加 ▲▲ */

/* 背景（他ページと同じ絶対URLに統一） */
(function(){
  var url = 'https://etramone7-coder.github.io/chaynupzine/assets/bg_submit_records.webp';
  document.getElementById('bg').style.backgroundImage = 'url(' + url + ')';
})();

/* クライアントID（レート制限用） — ★追加 */
function getClientId(){
  try{
    var k='chaynupzine_cid';
    var id=localStorage.getItem(k);
    if(!id){
      id = 'cid_'+Math.random().toString(36).slice(2)+Date.now().toString(36);
      localStorage.setItem(k,id);
    }
    return id;
  }catch(_){ return ''; }
}

/* ★★★ 追加：軽量バリデーション（URL系） ★★★ */
function isHttpsUrl(u){
  if(!u) return false;
  try{
    var x=new URL(u.trim());
    return x.protocol==='https:'; // http, javascript: など弾く
  }catch(_){ return false; }
}
function isAllowedYouTube(u){
  if(!u) return true; // 未入力は許容
  try{
    var s=u.trim();
    // youtu.be/ID, youtube.com/watch?v=ID, youtube.com/shorts/ID を許可
    if(/^https:\/\/youtu\.be\/[\w-]{6,}/i.test(s)) return true;
    if(/^https:\/\/(www\.)?youtube\.com\/watch\?/.test(s) && /[?&]v=([\w-]{6,})/.test(s)) return true;
    if(/^https:\/\/(www\.)?youtube\.com\/shorts\/[\w-]{6,}/i.test(s)) return true;
    return false;
  }catch(_){ return false; }
}
function isAllowedImageUrl(u){
  if(!u) return true; // 未入力は許容（アップロード併用あり）
  if(!isHttpsUrl(u)) return false;
  // 最低限のドメイン・拡張チェック（拡張はクエリ付与考慮で緩め）
  var host;
  try{ host=new URL(u).host.toLowerCase(); }catch(_){ return false; }
  var okHosts = [
    'drive.google.com','lh3.googleusercontent.com','images.unsplash.com',
    'i.imgur.com','imgur.com','githubusercontent.com','raw.githubusercontent.com',
    'static.wikia.nocookie.net','upload.wikimedia.org'
  ];
  if(okHosts.some(h=>host===h || host.endsWith('.'+h))) return true;
  // 一般サイトの直リンクも「https かつ画像拡張子らしきもの」を条件に緩許可
  if(/\.(jpg|jpeg|png|webp|gif)(\?.*)?$/i.test(u)) return true;
  return false;
}

/* NGワード（フロント警告用。サーバ側のフィルタは別途維持） */
var NG_TERMS = ["kill","die","rape","suicide","terror","bomb","fuck","cunt",
 "asshole","nazi","kkk","white power","retard","spic","chink","gook","fag"];

/* 画像URL→表示候補 */
function extractDriveId(u){
  try{
    var s=String(u||'');
    var m=s.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if(m) return m[1];
    m=s.match(/[?&]id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
    m=s.match(/uc\?export=view&id=([a-zA-Z0-9_-]+)/); if(m) return m[1];
  }catch(e){} return '';
}
function buildImageSources(url){
  var arr=[]; if(!url) return arr;
  if(String(url).indexOf('images.unsplash.com')>=0){
    arr.push(url + (url.indexOf('?')>=0 ? '&w=600' : '?w=600')); return arr;
  }
  var id=extractDriveId(url);
  if(id){
    arr.push('https://drive.google.com/uc?export=view&id='+id);
    arr.push('https://drive.google.com/thumbnail?id='+id+'&sz=w600');
  }
  arr.push(url); return arr;
}
function setPreviewImageByUrl(url){
  var box=document.getElementById('pvThumb'); box.innerHTML='';
  var sources=buildImageSources(url);
  if(!sources.length){ box.textContent='no image'; return; }
  var img=new Image(); img.loading='lazy';
  var i=0; function next(){ if(i>=sources.length){ box.textContent='no image'; return; } img.src=sources[i++]; }
  img.onerror=next; next(); box.appendChild(img);
}

/* プレビュー更新 */
function refreshPv(){
  var band=document.getElementById('band')?.value||'(Band)';
  var track=document.getElementById('track')?.value||'(Track)';
  var country=document.getElementById('country')?.value||'-';
  var genre=document.getElementById('genre')?.value||'-';
  var desc =document.getElementById('description')?.value||'';
  document.getElementById('pvTitle').textContent = band + ' / ' + track;
  document.getElementById('pvMeta').textContent  = country + ' / ' + genre;
  document.getElementById('pvDesc').textContent  = desc;
}
['band','track','country','genre','description'].forEach(function(id){
  var el=document.getElementById(id); if(el) el.addEventListener('input', refreshPv);
});
document.getElementById('image_url').addEventListener('input', function(){
  var v=this.value.trim(); if(v) setPreviewImageByUrl(v);
});
document.getElementById('upload').addEventListener('change', function(ev){
  var f=this.files && this.files[0]; if(!f) return;
  var reader=new FileReader();
  reader.onload=function(e){
    var box=document.getElementById('pvThumb'); box.innerHTML='';
    var img=new Image(); img.src=e.target.result; box.appendChild(img);
  };
  reader.readAsDataURL(f);
});

/* 説明文カウンター */
(function(){
  var t=document.getElementById('description');
  var c=document.getElementById('descCounter');
  function upd(){ c.textContent = (t.value.length) + ' / 500'; }
  t.addEventListener('input', upd); upd();
})();

/* 送信（.gs の submitFromClient を呼ぶ） */
document.getElementById('submitBtn').addEventListener('click', function(){
  var msg=document.getElementById('msg');
  var btn=document.getElementById('submitBtn');
  msg.className='alert'; msg.textContent='送信準備中…';

  var f=document.getElementById('postForm');
  if(!document.getElementById('consentCheck').checked){
    msg.className='alert err'; msg.textContent='免責事項に同意してください。'; return;
  }
  if(!f.genre.value || !f.country.value || !f.band.value || !f.track.value || !f.edit_key.value){
    msg.className='alert err'; msg.textContent='未入力の必須項目があります。'; return;
  }
  // NGワード検出（紹介文）
  var text=(f.description.value||"").toLowerCase();
  for(var i=0;i<NG_TERMS.length;i++){
    if(text.indexOf(NG_TERMS[i])>=0){
      msg.className='alert err'; msg.textContent='紹介文に禁止ワードが含まれています。'; return;
    }
  }

  /* URLバリデーション */
  var imgUrl = (f.image_url.value||'').trim();
  var ytUrl  = (f.youtube_url.value||'').trim();
  if(imgUrl && !isAllowedImageUrl(imgUrl)){
    msg.className='alert err'; msg.textContent='画像URLの形式が不正です（https必須／画像拡張子 or 許可ドメインのみ）。'; return;
  }
  if(ytUrl && !isAllowedYouTube(ytUrl)){
    msg.className='alert err'; msg.textContent='YouTubeのURL形式のみ許可されています（youtu.be / youtube.com/watch / /shorts）。'; return;
  }

  // 必要最低限のペイロード
  function T(v){ return (v||'').trim(); }
  var payload={
    genre:T(f.genre.value), country:T(f.country.value), band:T(f.band.value), track:T(f.track.value),
    release_year:T(f.release_year.value), catalog_no:T(f.catalog_no.value), format:T(f.format.value),
    description:T(f.description.value), image_url:T(imgUrl),
    youtube_url:T(ytUrl), author:T(f.author.value), edit_key:T(f.edit_key.value),
    client_id:getClientId()
  };

  var file=f.upload.files && f.upload.files[0];
  if(!payload.image_url && file){
    var r=new FileReader();
    r.onload=function(e){ payload.image_data = e.target.result; actuallySend(payload); };
    r.readAsDataURL(file);
  }else{
    actuallySend(payload);
  }

  function actuallySend(body){
    btn.disabled=true;
    callSubmitRecords(
      body,
      function(res){
        if(res && res.ok){
          msg.className='alert ok'; msg.textContent='投稿しました。ありがとうございます！';
          f.reset(); refreshPv();
          document.getElementById('pvThumb').innerHTML='no image';
          document.getElementById('descCounter').textContent='0 / 500';
        }else{
          msg.className='alert err';
          msg.textContent='投稿に失敗しました: ' + (res && res.error || 'unknown');
        }
        btn.disabled=false;
      },
      function(err){
        msg.className='alert err';
        msg.textContent='投稿に失敗しました: ' + (err && err.message ? err.message : String(err));
        btn.disabled=false;
      }
    );
  }
});

/* 初期プレビュー */
refreshPv();
</script>
</body>
</html>
