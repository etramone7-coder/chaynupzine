<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CHAYNUPZINE 特集コラム投稿</title>
<style>
  :root{--bg:#0f1115;--panel:#151922;--ink:#e7e9ee;--muted:#9aa3af;--accent:#1e90ff;--accent-ink:#fff;--danger:#e25555;--line:#2b3240}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue","Hiragino Kaku Gothic ProN",Meiryo,system-ui,sans-serif}
  .wrap{max-width:1200px;margin:32px auto;padding:0 14px}
  .title{font-weight:800;letter-spacing:.4px;color:var(--accent);font-size:26px;text-shadow:0 0 18px rgba(30,144,255,.15)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:16px}
  .label{font-size:12px;color:var(--muted);margin:14px 0 6px}
  .label b{color:var(--ink);font-size:13px;margin-right:6px}
  input[type=text],select,textarea{width:100%;background:#0e121a;border:1px solid var(--line);color:var(--ink);border-radius:8px;padding:10px 12px;outline:none}
  textarea{min-height:120px;resize:vertical}
  input[type=file]{width:100%}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{display:inline-block;width:100%;padding:12px 14px;border-radius:10px;border:0;background:var(--accent);color:var(--accent-ink);font-weight:700;letter-spacing:.08em;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:default}
  .msg{margin-top:10px;font-size:13px}
  .msg.ok{color:#5dd39e}.msg.err{color:var(--danger)}
  .card{background:#0e121a;border:1px dashed #3a4254;border-radius:12px;overflow:hidden}
  .pad{padding:12px}
  .ph{padding:16px;color:#30384a}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
  .chip{font-size:11px;padding:2px 8px;border:1px solid #3a4254;border-radius:999px;color:#c6d0e1}
  .para{border-top:1px solid #2b3240;padding-top:10px;margin-top:14px}
  .thumbs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .thumbs img{width:100%;height:96px;object-fit:cover;border-radius:8px;background:#0b0e14}
  .num{font-weight:700;opacity:.8;margin-right:6px}
  .ytlink{margin-top:8px;font-size:13px}
  .muted{color:var(--muted)}
  .warn{color:#f59e0b;font-size:12px;margin-top:6px}
  details{margin-top:14px}
  summary{cursor:pointer;color:#cbd5e1}
</style>
</head>
<body>
<div class="wrap">
  <h1 class="title">CHAYNUPZINE 特集コラム投稿</h1>

  <!-- 免責／注意 -->
  <div class="panel" style="margin-bottom:16px">
    <div class="muted">
      本サービスは投稿内容について一切の責任を負いません。誹謗中傷・差別・違法行為の助長は禁止です。<br>
      <b>※NGワード検知を行います（タイトル/ジャンル自由入力は対象外）。該当する場合、投稿はできません。</b><br>
      画像は<b>目安：1枚 10MB以下 / 長辺 3000px以下</b>を推奨。超える場合、プレビューは表示されません（投稿は可能）。
    </div>
  </div>

  <div class="grid">
    <!-- left: form -->
    <div class="panel">
      <div class="row2">
        <div>
          <label class="label"><b>GENRE</b></label>
          <select id="genre">
            <option value="">選択してください</option>
            <option value="band">BAND（バンド）</option>
            <option value="label">LABEL（レーベル）</option>
            <option value="region">REGION（国・地域）</option>
            <option value="designer">DESIGNER（ジャケ担当）</option>
            <option value="person">PERSON（有名人）</option>
            <option value="venue">VENUE（ライブ会場）</option>
            <option value="movie">MOVIE（映画）</option>
            <option value="fanzine">FANZINE（ファンジン）</option>
            <option value="other">OTHER（その他）</option>
          </select>
        </div>
        <div id="genreOtherWrap" style="display:none">
          <label class="label"><b>GENRE（OTHER の場合）</b></label>
          <input id="genre_other" type="text" placeholder="自由入力">
        </div>
      </div>

      <div class="row2">
        <div>
          <label class="label"><b>ERA（年代）</b></label>
          <select id="era">
            <option value="">指定なし</option>
            <option>1950s</option><option>1960s</option><option>1970s</option>
            <option>1980s</option><option>1990s</option><option>2000s</option>
            <option>2010s</option><option>2020s</option>
          </select>
        </div>
        <div>
          <label class="label"><b>REGION</b>（任意）</label>
          <div class="row2" style="grid-template-columns:2fr 1fr">
            <select id="regionSel">
              <option value="">指定なし</option>
              <option>Japan</option><option>UK</option><option>US</option>
              <option>Germany</option><option>France</option><option>Italy</option>
              <option>Spain</option><option>Australia</option><option>Canada</option>
              <option>Sweden</option><option>Norway</option><option>Finland</option>
              <option>Netherlands</option><option>Belgium</option><option>Ireland</option>
              <option>New Zealand</option><option>Korea</option><option>China</option>
              <option>Taiwan</option><option>Hong Kong</option>
              <option>Brazil</option><option>Mexico</option>
              <option value="__other">Other…</option>
            </select>
            <input id="regionOther" type="text" placeholder="地域名を入力" style="display:none">
          </div>
        </div>
      </div>

      <label class="label"><b>TITLE</b></label>
      <input id="title" type="text" placeholder="特集のタイトル（長文可。表示は必要に応じ自動省略）">

      <label class="label"><b>AUTHOR</b></label>
      <input id="author" type="text" placeholder="投稿者名">

      <label class="label"><b>EDIT KEY</b>（編集キー・必須）</label>
      <input id="edit_key" type="text" placeholder="半角英数のみ。後から編集/削除に必要" inputmode="latin" pattern="[A-Za-z0-9]+">

      <!-- paragraphs (1..3) -->
      <div id="paras"></div>

      <button id="submitBtn" class="btn">投稿</button>
      <div id="msg" class="msg"></div>

      <!-- 投稿ガイド / FAQ -->
      <details>
        <summary>投稿ガイド / FAQ</summary>
        <div class="muted" style="margin-top:8px">
          <b>■ 投稿ガイド</b><br>
          ・各段落に最大3枚の画像（URL or アップロード）とYouTubeリンクを添付できます。<br>
          ・画像は 10MB以下 / 長辺3000px以下を推奨。超えると<b>プレビューは表示されません</b>（投稿は可）。<br>
          ・編集や削除をするには<b>編集キー</b>が必要です。忘れないように。<br>
          ・NGワードに該当する表現は投稿不可（<b>タイトル/ジャンル自由入力は対象外</b>）。<br>
          ・連投制限：同一端末から概ね<b>5分に1回</b>まで。<br><br>

          <b>■ よくある質問</b><br>
          Q. 編集/削除の方法は？<br>
          A. 閲覧ページの「投稿を編集/削除」→ 行番号またはスラッグ/IDと編集キーを入力してください。<br><br>
          Q. 画像が表示されません。<br>
          A. サイズ上限・Drive共有設定（リンク可視）をご確認ください。<br><br>
          Q. YouTubeは埋め込みですか？<br>
          A. プレビューはリンク表示、保存はURL連携です。<br>
        </div>
      </details>
    </div>

    <!-- right: preview -->
    <div class="panel">
      <div class="card">
        <div class="pad">
          <div class="chips">
            <span id="chipGenre" class="chip"></span>
            <span id="chipEra" class="chip"></span>
            <span id="chipRegion" class="chip"></span>
          </div>
          <div id="pvTitle" style="font-weight:800;font-size:18px">—</div>
          <div id="pvAuthor" class="muted" style="margin-bottom:8px">—</div>

          <div id="pvBody">
            <div class="ph">段落と画像のプレビューがここに表示されます。</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // -------- util --------
  function $(q){ return document.querySelector(q); }
  function el(tag, attrs){ var e=document.createElement(tag); if(attrs) Object.assign(e, attrs); return e; }

  // -------- state --------
  var els={}, lastVals={};
  var PARA_MAX = 3, IMG_PER = 3;
  var blobURLs = []; // 一時URLを管理（リーク防止）
  var MAX_BYTES = 10*1024*1024; // 10MB
  var MAX_EDGE  = 3000;         // 長辺3000px
  // 簡易NG：タイトル/genre_otherは除外し、段落テキスト等のみ検査
  var NG_TERMS = ["kill","die","rape","suicide","terror","bomb","fuck","cunt","asshole","nazi","kkk","white power","retard","spic","chink","gook","fag"];

  function clearBlobURLs(){ try{ blobURLs.forEach(u=>URL.revokeObjectURL(u)); }catch(_){}
    blobURLs=[]; }

  // client_id を localStorage に保存（レート制限用）
  function getClientId(){
    try{
      var k='chaynupzine_cid';
      var id=localStorage.getItem(k);
      if(!id){
        id = 'cid_'+Math.random().toString(36).slice(2)+Date.now().toString(36);
        localStorage.setItem(k,id);
      }
      return id;
    }catch(_){ return ''; }
  }

  // -------- build paragraph inputs --------
  function buildParas(){
    var host = $('#paras'); host.innerHTML='';
    for(let i=1;i<=PARA_MAX;i++){
      var box = el('div', {className:'para'});
      var h = el('div'); h.innerHTML = '<span class="num">§'+i+'</span>段落テキスト';
      box.appendChild(h);

      var ta = el('textarea'); ta.id = 'para'+i+'_text'; box.appendChild(ta);

      // image url + upload x3
      for(let j=1;j<=IMG_PER;j++){
        var lab = el('label', {className:'label'}); lab.innerHTML = '<b>画像'+j+'</b>（URL or アップロード）';
        box.appendChild(lab);

        var row = el('div',{className:'row2'});
        var url = el('input',{type:'text', id:'p'+i+'_img'+j+'_url', placeholder:'https://drive.google.com/... or https://example.com/...'});
        var file= el('input',{type:'file', id:'p'+i+'_img'+j+'_file', accept:'image/*'});
        // 注意文（プレビュー制限）
        var warn = el('div',{className:'warn', id:'p'+i+'_img'+j+'_warn', style:'display:none'});
        row.appendChild(url); row.appendChild(file);
        box.appendChild(row); box.appendChild(warn);
      }

      var ylab = el('label',{className:'label'}); ylab.innerHTML = '<b>YouTube</b>（任意・URL1本）';
      var yt = el('input',{type:'text', id:'youtube'+i, placeholder:'https://youtu.be/xxxx'});
      box.appendChild(ylab); box.appendChild(yt);

      host.appendChild(box);
    }
  }

  // 画像上限チェック（OK時は dataUrl 返す/NGは警告テキスト）
  function fileToDataURL(file){
    return new Promise(function(resolve,reject){
      if(!file) return resolve('');
      var fr=new FileReader();
      fr.onload=function(e){ resolve(e.target.result); };
      fr.onerror=function(){ reject(new Error('file read error')); };
      fr.readAsDataURL(file);
    });
  }
  async function checkImageLimits(file){
    if(!file) return {ok:true};
    if(file.size > MAX_BYTES) return {ok:false, reason:'ファイルサイズが大きすぎます（10MB超）'};
    try{
      var data = await fileToDataURL(file);
      var img = new Image();
      await new Promise(function(res,rej){
        img.onload=function(){
          var w=img.naturalWidth||img.width, h=img.naturalHeight||img.height;
          if(Math.max(w,h)>MAX_EDGE) rej(new Error('長辺が大きすぎます（3000px超）'));
          else res();
        };
        img.onerror=function(){ rej(new Error('画像の読み込みに失敗しました')); };
        img.src=data;
      });
      return {ok:true, dataUrl:data};
    }catch(e){ return {ok:false, reason:String(e.message||e)}; }
  }

  // -------- gather refs --------
  function bindEls(){
    els = {
      genre:$('#genre'), genre_other:$('#genre_other'),
      era:$('#era'),
      regionSel:$('#regionSel'), regionOther:$('#regionOther'),
      title:$('#title'), author:$('#author'), edit_key:$('#edit_key'),
      chipGenre:$('#chipGenre'), chipEra:$('#chipEra'), chipRegion:$('#chipRegion'),
      pvTitle:$('#pvTitle'), pvAuthor:$('#pvAuthor'), pvBody:$('#pvBody'),
      btn:$('#submitBtn'), msg:$('#msg'), genreOtherWrap:$('#genreOtherWrap')
    };
    // paragraph refs dynamic
    for(let i=1;i<=PARA_MAX;i++){
      els['para'+i+'_text'] = $('#para'+i+'_text');
      els['youtube'+i] = $('#youtube'+i);
      for(let j=1;j<=IMG_PER;j++){
        els['p'+i+'_img'+j+'_url']  = $('#p'+i+'_img'+j+'_url');
        els['p'+i+'_img'+j+'_file'] = $('#p'+i+'_img'+j+'_file');
        els['p'+i+'_img'+j+'_warn'] = $('#p'+i+'_img'+j+'_warn');
      }
    }
  }

  // Region 値の取得（プレビュー/送信で共通利用）
  function getRegionValue(){
    var sel = els.regionSel.value;
    if(sel === '__other') return (els.regionOther.value||'').trim();
    return sel || '';
  }

  // -------- preview --------
  async function updatePreview(){
    // chips
    var g = els.genre.value;
    els.chipGenre.textContent = g ? g.replace('venue','VENUE（ライブ会場）') : '';
    els.chipEra.textContent   = els.era.value || '';
    var reg = getRegionValue();
    els.chipRegion.textContent= reg || '';

    els.pvTitle.textContent = els.title.value || '—';
    els.pvAuthor.textContent= els.author.value ? 'by '+els.author.value : '—';

    // body
    var wrap = els.pvBody; wrap.innerHTML='';
    clearBlobURLs();
    var hasAny = false;

    for(let i=1;i<=PARA_MAX;i++){
      var text = (els['para'+i+'_text'].value||'').trim();
      var srcs=[];
      for(let j=1;j<=IMG_PER;j++){
        // 初期化
        var warnEl = els['p'+i+'_img'+j+'_warn']; if(warnEl){ warnEl.style.display='none'; warnEl.textContent=''; }

        var u = (els['p'+i+'_img'+j+'_url'].value||'').trim();
        if(!u){
          var fEl = els['p'+i+'_img'+j+'_file'];
          if(fEl && fEl.files && fEl.files[0]){
            // 上限チェック。NGの場合はプレビューせず警告のみ
            var chk = await checkImageLimits(fEl.files[0]);
            if(chk.ok){
              u = URL.createObjectURL(fEl.files[0]); // ここは objectURL でOK（視覚的に軽い）
              blobURLs.push(u);
            }else{
              if(warnEl){ warnEl.textContent='プレビュー不可：'+chk.reason; warnEl.style.display=''; }
            }
          }
        }
        if(u) srcs.push(u);
      }
      var y = (els['youtube'+i].value||'').trim();

      if(!text && srcs.length===0 && !y) continue;
      hasAny = true;

      var sec = el('div', {className:'para'});
      var p = el('div'); p.textContent = text || '—';
      sec.appendChild(p);

      if(srcs.length){
        var t = el('div', {className:'thumbs'});
        srcs.forEach(function(u){ var img=el('img'); img.src=u; t.appendChild(img); });
        sec.appendChild(t);
      }

      if(y){
        var a = el('a',{href:y,target:'_blank',rel:'noopener'});
        a.textContent = 'YouTubeリンクを開く';
        var yt = el('div',{className:'ytlink'}); yt.appendChild(a);
        sec.appendChild(yt);
      }

      wrap.appendChild(sec);
    }
    if(!hasAny){
      wrap.innerHTML = '<div class="ph">段落と画像のプレビューがここに表示されます。</div>';
    }
  }

  // -------- 簡易NGチェック（タイトル/genre_otherは対象外） --------
  function clientNgCheck(){
    try{
      var text = [
        els.author.value,
        els.era.value,
        getRegionValue()
      ].join('\n');

      for(let i=1;i<=PARA_MAX;i++){
        text += '\n' + (els['para'+i+'_text'].value||'');
      }

      var low = text.toLowerCase();
      for(var i=0;i<NG_TERMS.length;i++){
        var w=NG_TERMS[i];
        if(low.indexOf(w)>=0) return 'NGワードに該当する表現が含まれています。表現を言い換えてください。';
      }
      return '';
    }catch(_){ return ''; }
  }

  // -------- bind events --------
  function bindAll(){
    // genre other 表示
    els.genre.addEventListener('change', function(){
      els.genreOtherWrap.style.display = (els.genre.value==='other') ? '' : 'none';
      updatePreview();
    });

    // region other 表示
    els.regionSel.addEventListener('change', function(){
      var show = (els.regionSel.value==='__other');
      els.regionOther.style.display = show ? '' : 'none';
      if(!show) els.regionOther.value='';
      updatePreview();
    });
    els.regionOther.addEventListener('input', updatePreview);

    // preview updates（テキスト/セレクト）
    var ids = ['genre','genre_other','era','title','author','edit_key','regionSel','regionOther'];
    for(let i=1;i<=PARA_MAX;i++){
      ids.push('para'+i+'_text','youtube'+i);
      for(let j=1;j<=IMG_PER;j++){
        ids.push('p'+i+'_img'+j+'_url');
      }
    }
    ids.forEach(function(id){
      var e = $('#'+id); if(!e) return;
      ['input','change','keyup','paste','blur'].forEach(function(ev){ e.addEventListener(ev, updatePreview, false); });
    });

    // file 変更で即プレビュー
    for(let i=1;i<=PARA_MAX;i++){
      for(let j=1;j<=IMG_PER;j++){
        var f = els['p'+i+'_img'+j+'_file'];
        if(f){ f.addEventListener('change', updatePreview, false); }
      }
    }

    // heartbeat（取りこぼし防止）
    setInterval(function(){
      try{
        var now = {};
        ids.forEach(function(id){ var e=$('#'+id); now[id]=e?e.value:''; });
        var changed = JSON.stringify(now)!==JSON.stringify(lastVals);
        if(changed){ lastVals=now; updatePreview(); }
      }catch(_){}
    }, 700);
  }

  // -------- submit --------
  function bindSubmit(){
    els.btn.addEventListener('click', async function(){
      els.msg.textContent=''; els.msg.className='msg'; els.btn.disabled=true;

      try{
        if(!(els.title.value||'').trim()){ throw new Error('TITLE は必須です'); }
        if(!(els.genre.value||'').trim()){ throw new Error('GENRE を選択してください'); }
        if(els.genre.value==='other' && !(els.genre_other.value||'').trim()){
          throw new Error('GENRE が OTHER の場合は自由入力も必須です');
        }
        var ek = (els.edit_key.value||'').trim();
        if(!/^[A-Za-z0-9]+$/.test(ek)){
          throw new Error('編集キーは半角英数のみで入力してください');
        }

        // NGチェック
        var ng = clientNgCheck();
        if(ng){ throw new Error(ng); }

        var regionVal = getRegionValue();

        // payload を構築
        var payload = {
          status:'published',
          title:(els.title.value||'').trim(),
          author:(els.author.value||'').trim(),
          genre:(els.genre.value||'').trim(),
          genre_other:(els.genre_other.value||'').trim(),
          era:(els.era.value||'').trim(),
          region: regionVal,
          edit_key: ek,
          client_id: (function(){ try{ return getClientId(); }catch(_){ return ''; } })()
        };

        for(let i=1;i<=PARA_MAX;i++){
          payload['para'+i+'_text'] = (els['para'+i+'_text'].value||'').trim();
          payload['youtube'+i]     = (els['youtube'+i].value||'').trim();
          for(let j=1;j<=IMG_PER;j++){
            var urlEl  = els['p'+i+'_img'+j+'_url'];
            var fileEl = els['p'+i+'_img'+j+'_file'];
            payload['p'+i+'_img'+j+'_url'] = (urlEl.value||'').trim();
            if(!payload['p'+i+'_img'+j+'_url'] && fileEl && fileEl.files && fileEl.files[0]){
              // 上限超でも投稿自体は許可（サーバ側で保存判定）
              payload['p'+i+'_img'+j+'_data'] = await fileToDataURL(fileEl.files[0]);
            }
          }
        }

        google.script.run
          .withSuccessHandler(function(res){
            if(res && res.ok){
              els.msg.className='msg ok';
              els.msg.textContent='Posted!';
              // 最低限だけクリア（ジャンル・年代・地域は残す / 編集キーは保持）
              var keep = { genre:els.genre.value, era:els.era.value, regionSel:els.regionSel.value, regionOther:els.regionOther.value, edit_key:els.edit_key.value };
              document.querySelectorAll('input[type=text], textarea').forEach(function(i){ i.value=''; });
              for(let i=1;i<=PARA_MAX;i++){ for(let j=1;j<=IMG_PER;j++){ els['p'+i+'_img'+j+'_file'].value=''; } }
              els.genre.value=keep.genre; els.era.value=keep.era; els.regionSel.value=keep.regionSel; els.regionOther.value=keep.regionOther; els.edit_key.value=keep.edit_key;
              els.genreOtherWrap.style.display = (els.genre.value==='other') ? '' : 'none';
              els.regionOther.style.display    = (els.regionSel.value==='__other') ? '' : 'none';
              updatePreview();
            }else{
              throw new Error(res && res.error ? res.error : 'server error');
            }
            els.btn.disabled=false;
          })
          .withFailureHandler(function(err){
            els.msg.className='msg err';
            els.msg.textContent='Error: '+(err && err.message ? err.message : String(err));
            els.btn.disabled=false;
          })
          .submitFeature(payload);

      }catch(e){
        els.msg.className='msg err';
        els.msg.textContent='Error: '+e.message;
        els.btn.disabled=false;
      }
    });
  }

  // -------- init --------
  buildParas();
  bindEls();
  bindAll();
  bindSubmit();
  updatePreview();
})();
</script>
</body>
</html>
