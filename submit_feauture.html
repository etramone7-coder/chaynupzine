<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CHAYNUPZINE 特集コラム投稿</title>
<style>
  :root{--bg:#0f1115;--panel:#151922;--ink:#e7e9ee;--muted:#9aa3af;--accent:#1e90ff;--accent-ink:#fff;--danger:#e25555;--line:#2b3240}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.5 -apple-system,BlinkMacSystemFont,"Helvetica Neue","Hiragino Kaku Gothic ProN",Meiryo,system-ui,sans-serif}

  /* ▼ 背景（透過0.6）— 新ファイルに変更。背景は固定、ページ全体がスクロール */
  .bg{position:fixed;inset:0;
      background:#0f1115 url("https://etramone7-coder.github.io/chaynupzine/assets/bg_submit_feauture.webp") center/cover no-repeat;
      opacity:.6;filter:contrast(1) brightness(.95);z-index:0}
  /* ★追加：白ベールで可読性UP */
  .bg::after{content:"";position:absolute;inset:0;background:rgba(255,255,255,.55)}

  /* 上部余白はロゴ分だけ確保 */
  .wrap{max-width:1200px;margin:12px auto 32px;padding:70px 14px 0;position:relative;z-index:1}

  /* 左上ロゴ（隅にぴったり固定） */
  .brand{position:fixed;top:10px;left:10px;z-index:5;
         background:#111;color:#fff;border-radius:8px;padding:7px 12px;
         font-weight:800;letter-spacing:.4px;line-height:1}

  /* サブタイトル（言語切替対象） */
  .sub{font-weight:800;letter-spacing:.4px;color:var(--accent);
       font-size:20px;text-shadow:0 0 18px rgba(30,144,255,.15);
       display:block;margin:6px 0 6px}

  /* 右上 JP/EN（縦並び・上に密着） */
  .lang{position:fixed;top:10px;right:10px;z-index:5;
        display:flex;flex-direction:column;gap:4px;align-items:flex-end}
  .lang button{border:1px solid #3a4254;background:#0e121a;color:#e7e9ee;
               padding:6px 10px;border-radius:10px;font-size:13px;cursor:pointer;line-height:1}
  .lang button.active{background:#e7e9ee;color:#0e121a;border-color:#e7e9ee}

  /* 単一カード（フォーム＋トップボタン＋プレビューを内包） */
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:16px}

  /* トップへ戻る（フォームとプレビューの間） */
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin:16px 0;align-items:center;justify-content:center}
  .btnA{border:0;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;font-size:16px;text-decoration:none}
  .btnA.ghost{background:#0e121a;color:#fff;border:1px solid var(--line)}

  .label{font-size:12px;color:var(--muted);margin:14px 0 6px}
  .label b{color:var(--ink);font-size:13px;margin-right:6px}
  input[type=text],select,textarea{width:100%;background:#0e121a;border:1px solid var(--line);color:var(--ink);border-radius:8px;padding:10px 12px;outline:none}
  textarea{min-height:120px;resize:vertical}
  input[type=file]{width:100%}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .btn{display:inline-block;width:100%;padding:12px 14px;border-radius:10px;border:0;background:var(--accent);color:var(--accent-ink);font-weight:700;letter-spacing:.08em;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:default}
  .msg{margin-top:10px;font-size:13px}
  .msg.ok{color:#5dd39e}.msg.err{color:#e25555}
  .card{background:#0e121a;border:1px dashed #3a4254;border-radius:12px;overflow:hidden}
  .pad{padding:12px}
  .ph{padding:16px;color:#30384a}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
  .chip{font-size:11px;padding:2px 8px;border:1px solid #3a4254;border-radius:999px;color:#c6d0e1}
  .para{border-top:1px solid #2b3240;padding-top:10px;margin-top:14px}
  .thumbs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
  .thumbs img{width:100%;height:96px;object-fit:cover;border-radius:8px;background:#0b0e14}
  .num{font-weight:700;opacity:.8;margin-right:6px}
  .ytlink{margin-top:8px;font-size:13px}
  .muted{color:var(--muted)}
  .warn{color:#f59e0b;font-size:12px;margin-top:6px}
  details{margin-top:14px}
  summary{cursor:pointer;color:#cbd5e1}

  /* ▼▼ 追加（最小変更）：ネイティブのfileボタンは隠し、カスタムボタンを使う */
  .hiddenfile{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}
  .filebtn{
    display:inline-block;padding:10px 12px;border:1px solid var(--line);
    border-radius:8px;background:#0e121a;color:#e7e9ee;font-size:14px;cursor:pointer;
    text-align:center
  }
</style>
</head>
<body>
<!-- 背景 -->
<div class="bg"></div>

<div class="wrap">
  <!-- 固定ロゴ＆サブタイトル＆言語切替 -->
  <span class="brand">CHAYNUPZINE</span>
  <span id="pageSubtitle" class="sub">特集コラム投稿</span>
  <div class="lang">
    <button id="lang-ja" type="button">JP</button>
    <button id="lang-en" type="button">EN</button>
  </div>

  <!-- 単一カード：免責 + 入力 + トップへ戻る + プレビュー -->
  <div class="panel" id="oneCard">
    <!-- 免責／注意 -->
    <div id="disclaimer" class="muted">
      本サービスは投稿内容について一切の責任を負いません。誹謗中傷・差別・違法行為の助長は禁止です。<br>
      <b>※NGワード検知を行います（タイトル/ジャンル自由入力は対象外）。該当する場合、投稿はできません。</b><br>
      画像は<b>目安：1枚 10MB以下 / 長辺 3000px以下</b>を推奨。超える場合、プレビューは表示されません（投稿は可能）。
    </div>
    <div style="margin-top:10px">
      <input id="agree" type="checkbox">
      <label id="agreeLabel" for="agree" style="font-size:13px;color:#cbd5e1">免責事項と禁止事項に同意します</label>
    </div>

    <!-- フォーム本体 -->
    <div class="row2" style="margin-top:14px">
      <div>
        <label class="label"><b id="genreLabel">GENRE</b></label>
        <select id="genre">
          <option value="">選択してください</option>
          <option value="band">BAND（バンド）</option>
          <option value="label">LABEL（レーベル）</option>
          <option value="region">REGION（国・地域）</option>
          <option value="designer">DESIGNER（デザイナー）</option>
          <option value="person">PERSON（有名人）</option>
          <option value="venue">VENUE（ライブ会場）</option>
          <option value="movie">MOVIE（映画）</option>
          <option value="fanzine">FANZINE（ファンジン）</option>
          <option value="other">OTHER（その他）</option>
        </select>
      </div>
      <div id="genreOtherWrap" style="display:none">
        <label class="label"><b id="genreOtherLabel">GENRE（OTHER の場合）</b></label>
        <input id="genre_other" type="text" placeholder="自由入力">
      </div>
    </div>

    <div class="row2">
      <div>
        <label class="label"><b id="eraLabel">ERA（年代）</b></label>
        <select id="era">
          <option value="">指定なし</option>
          <option>1950s</option><option>1960s</option><option>1970s</option>
          <option>1980s</option><option>1990s</option><option>2000s</option>
          <option>2010s</option><option>2020s</option>
        </select>
      </div>
      <div>
        <label class="label"><b id="regionLabel">REGION（任意）</b></label>
        <div class="row2" style="grid-template-columns:2fr 1fr">
          <select id="regionSel">
            <option value="">指定なし</option>
            <option>Japan</option><option>UK</option><option>US</option>
            <option>Germany</option><option>France</option><option>Italy</option>
            <option>Spain</option><option>Australia</option><option>Canada</option>
            <option>Sweden</option><option>Norway</option><option>Finland</option>
            <option>Netherlands</option><option>Belgium</option><option>Ireland</option>
            <option>New Zealand</option><option>Korea</option><option>China</option>
            <option>Taiwan</option><option>Hong Kong</option>
            <option>Brazil</option><option>Mexico</option>
            <option value="__other">Other…</option>
          </select>
          <input id="regionOther" type="text" placeholder="地域名を入力" style="display:none">
        </div>
      </div>
    </div>

    <label class="label"><b id="titleLabel">TITLE</b></label>
    <input id="title" type="text" placeholder="特集のタイトル（長文可。表示は必要に応じ自動省略）">

    <label class="label"><b id="authorLabel">AUTHOR</b></label>
    <input id="author" type="text" placeholder="投稿者名">

    <!-- EDIT KEY -->
    <label class="label"><b id="editKeyLabel">EDIT KEY（編集キー・必須）</b></label>
    <!-- ★変更：8〜32 の半角英数字に統一 -->
    <input id="edit_key" type="text" placeholder="半角英数のみ。後から編集/削除に必要"
           inputmode="latin" pattern="[A-Za-z0-9]{8,32}" minlength="8" maxlength="32" required>

    <!-- paragraphs (1..3 → ★5に拡張) -->
    <div id="paras"></div>

    <button id="submitBtn" class="btn">投稿</button>
    <div id="msg" class="msg"></div>

    <!-- ▲ フォームここまで ▲ -->

    <!-- 中央：トップへ戻る -->
    <div class="actions">
      <a class="btnA ghost" id="btn-top" href="https://etramone7-coder.github.io/chaynupzine/">トップへ戻る</a>
    </div>

    <!-- プレビュー -->
    <div class="card">
      <div class="pad">
        <div class="chips">
          <span id="chipGenre" class="chip"></span>
          <span id="chipEra" class="chip"></span>
          <span id="chipRegion" class="chip"></span>
        </div>
        <div id="pvTitle" style="font-weight:800;font-size:18px">—</div>
        <div id="pvAuthor" class="muted" style="margin-bottom:8px">—</div>
        <div id="pvBody">
          <div id="pvEmpty" class="ph">段落と画像のプレビューがここに表示されます。</div>
        </div>
      </div>
    </div>

    <!-- 投稿ガイド / FAQ（ここは日本語固定のまま） -->
    <details>
      <summary>投稿ガイド / FAQ</summary>
      <div class="muted" style="margin-top:8px">
        <b>■ 投稿ガイド</b><br>
        ・各段落に最大3枚の画像（URL or アップロード）とYouTubeリンクを添付できます。<br>
        ・画像は 10MB以下 / 長辺3000px以下を推奨。超えると<b>プレビューは表示されません</b>（投稿は可）。<br>
        ・編集や削除をするには<b>編集キー</b>が必要です。忘れないように。<br>
        ・NGワードに該当する表現は投稿不可（<b>タイトル/ジャンル自由入力は対象外</b>）。<br>
        ・連投制限：同一端末から概ね<b>5分に1回</b>まで。<br><br>

        <b>■ よくある質問</b><br>
        Q. 編集/削除の方法は？<br>
        A. 閲覧ページの「投稿を編集/削除」→ 行番号またはスラッグ/IDと編集キーを入力してください。<br><br>
        Q. 画像が表示されません。<br>
        A. サイズ上限・Drive共有設定（リンク可視）をご確認ください。<br><br>
        Q. YouTubeは埋め込みですか？<br>
        A. プレビューはリンク表示、保存はURL連携です。<br>
      </div>
    </details>
  </div>
</div>

<script>
/* GAS WebApp の実行URL（外部ホスティング時に使用） */
const EXEC_URL = 'https://script.google.com/macros/s/AKfycbxZ9JsvX-BQUrFXLTBSkf9i_MgWxt-fyQygLDQfi2DQWy3qZ7dtc_IObvi3VMYoaCQAxw/exec';
</script>

<script>
/* ===== 言語テキスト ===== */
var TEXTS={
  ja:{
    subtitle:'特集コラム投稿',
    top:'トップへ戻る',
    agree:'免責事項と禁止事項に同意します',
    disclaimer: '本サービスは投稿内容について一切の責任を負いません。誹謗中傷・差別・違法行為の助長は禁止です。<br><b>※NGワード検知を行います（タイトル/ジャンル自由入力は対象外）。該当する場合、投稿はできません。</b><br>画像は<b>目安：1枚 10MB以下 / 長辺 3000px以下</b>を推奨。超える場合、プレビューは表示されません（投稿は可能）。',
    labels:{
      genre:'GENRE', genre_other:'GENRE（OTHER の場合）',
      era:'ERA（年代）', region:'REGION（任意）',
      title:'TITLE', author:'AUTHOR', edit:'EDIT KEY（編集キー・必須）'
    },
    ph:{
      genre_other:'自由入力', region_other:'地域名を入力',
      title:'特集のタイトル（長文可。表示は必要に応じ自動省略）',
      author:'投稿者名', yt:'https://youtu.be/xxxx',
      para:'段落テキスト', img:'画像', ytOpen:'YouTubeリンクを開く',
      pvEmpty:'段落と画像のプレビューがここに表示されます。',
      /* ▼ 追加：ファイルボタンの文言 */
      choose:'ファイルを選択', selected:'選択済み: '
    },
    btnSubmit:'投稿'
  },
  en:{
    subtitle:'Feature Column Submission',
    top:'Back to Top',
    agree:'I agree to the disclaimer and prohibited items',
    disclaimer: 'We assume no responsibility for submitted content. Defamation, discrimination, and encouragement of illegal activity are prohibited.<br><b>NG-word detection is performed (free input for title/genre is excluded). If detected, the post cannot be submitted.</b><br>Images: <b>recommended up to 10MB / long edge ≤ 3000px</b>. If exceeded, preview is not shown (submission is allowed).',
    labels:{
      genre:'GENRE', genre_other:'GENRE (when OTHER)',
      era:'ERA', region:'REGION (optional)',
      title:'TITLE', author:'AUTHOR', edit:'EDIT KEY (required)'
    },
    ph:{
      genre_other:'Free input', region_other:'Enter region',
      title:'Feature title (long text allowed; display may be truncated)',
      author:'Author name', yt:'https://youtu.be/xxxx',
      para:'Paragraph text', img:'Image', ytOpen:'Open YouTube link',
      pvEmpty:'Preview of paragraphs and images will appear here.',
      /* ▼ 追加：ファイルボタンの文言 */
      choose:'Choose file', selected:'Selected: '
    },
    btnSubmit:'Submit'
  }
};

/* ===== 言語切替（ボタン動作は既存ロジックを維持しつつ強化） ===== */
(function(){
  function $(q){ return document.querySelector(q); }
  function getLang(){ var v=localStorage.getItem('chay_lang'); return (v==='en')?'en':'ja'; }

  function setLangUI(lang){
  var $ = (q)=>document.querySelector(q);
  var t = TEXTS[lang];

  // ボタン状態
  $('#lang-ja')?.classList.toggle('active', lang==='ja');
  $('#lang-en')?.classList.toggle('active', lang==='en');

  // 見出し・ボタン・免責
  $('#pageSubtitle') && ($('#pageSubtitle').textContent = t.subtitle);
  $('#btn-top') && ($('#btn-top').textContent = t.top);
  $('#disclaimer') && ($('#disclaimer').innerHTML = t.disclaimer);
  $('#agreeLabel') && ($('#agreeLabel').textContent = t.agree);

  // ラベル（太字部分）
  const L = t.labels;
  const map = {
    genreLabel:'genre', genreOtherLabel:'genre_other',
    eraLabel:'era', regionLabel:'region',
    titleLabel:'title', authorLabel:'author', editKeyLabel:'edit'
  };
  Object.keys(map).forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.textContent = L[map[id]];
  });

  // プレースホルダー
  const P = t.ph;
  const setPH = (id, v)=>{ const el=document.getElementById(id); if(el) el.placeholder=v; };
  setPH('genre_other', P.genre_other);
  setPH('regionOther', P.region_other);
  setPH('title',       P.title);
  setPH('author',      P.author);
  const sb = document.getElementById('submitBtn'); if(sb) sb.textContent = t.btnSubmit;

  // ▼▼ 追加：段落系の動的文言もしっかり切替（JP時は「段落テキスト」になる）
  document.querySelectorAll('[data-i18n="para"]').forEach(span=>{
    span.textContent = P.para;
  });
  document.querySelectorAll('[data-i18n="img"]').forEach(b=>{
    const idx = b.dataset.idx || '';
    b.textContent = P.img + idx;
  });
  document.querySelectorAll('[data-i18n="ytOpen"]').forEach(a=>{
    a.textContent = P.ytOpen;
  });
  document.querySelectorAll('input[type="text"][data-i18n-ph="yt"]').forEach(inp=>{
    inp.placeholder = P.yt;
  });

  // プレビュー空表示
  const pvEmpty = document.getElementById('pvEmpty');
  if(pvEmpty) pvEmpty.textContent = P.pvEmpty;

  // ▼▼ 追加：カスタムファイルボタンの文言更新（選択済みなら selected 文言で上書き）
  document.querySelectorAll('.filebtn').forEach(function(btn){
    var forId = btn.getAttribute('data-for');
    var input = forId ? document.getElementById(forId) : null;
    if (input && input.files && input.files[0]){
      btn.textContent = P.selected + input.files[0].name;
    }else{
      btn.textContent = P.choose;
    }
  });
  }

  function bindLangButtons(){
    var ja=document.getElementById('lang-ja');
    var en=document.getElementById('lang-en');
    if(ja && !ja.__bound){
      ja.addEventListener('click',function(e){ e.preventDefault(); localStorage.setItem('chay_lang','ja'); setLangUI('ja'); },false);
      ja.__bound=true;
    }
    if(en && !en.__bound){
      en.addEventListener('click',function(e){ e.preventDefault(); localStorage.setItem('chay_lang','en'); setLangUI('en'); },false);
      en.__bound=true;
    }
  }

  // デリゲーション保険
  document.addEventListener('click',function(ev){
    if(ev.target && ev.target.id==='lang-ja'){ ev.preventDefault(); localStorage.setItem('chay_lang','ja'); setLangUI('ja'); }
    if(ev.target && ev.target.id==='lang-en'){ ev.preventDefault(); localStorage.setItem('chay_lang','en'); setLangUI('en'); }
  },false);

  // 公開関数：他の初期化より前に言語だけ当てる
  window.__setLangUI = setLangUI;
  window.__getLang   = getLang;

  // 初期適用
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', function(){ setLangUI(getLang()); bindLangButtons(); }, {once:true});
  }else{
    setLangUI(getLang()); bindLangButtons();
  }
  window.addEventListener('load', bindLangButtons, {once:true});
})();
</script>

<script>
/* ▼ EXEC_URL をテンプレ注入優先で解決（無い場合は既存定数をフォールバック） */
(function resolveExecUrl(){
  try{
    var injected = (window.EXEC_URL||'').trim();
    if (!injected || injected.indexOf('<?=')===0) injected = '';
    var fallback='https://script.google.com/macros/s/AKfycbxZ9JsvX-BQUrFXLTBSkf9i_MgWxt-fyQygLDQfi2DQWy3qZ7dtc_IObvi3VMYoaCQAxw/exec';
    window.EXEC_URL = injected || fallback;
  }catch(_){
    window.EXEC_URL='https://script.google.com/macros/s/AKfycbxZ9JsvX-BQUrFXLTBSkf9i_MgWxt-fyQygLDQfi2DQWy3qZ7dtc_IObvi3VMYoaCQAxw/exec';
  }
})();
</script>

<script>
/* GAS/外部 両対応ラッパー（submitFeature）
   ★GET→POST(text/plain) フォールバック + body に csrf 同梱 */
async function callSubmitFeature(payload, onOK, onNG){
  // 1) Apps Script 内
  try{
    if (window.google && google.script && google.script.run){
      google.script.run.withSuccessHandler(onOK).withFailureHandler(onNG).submitFeature(payload);
      return;
    }
  }catch(_){}

  // 2) まず GET（JSONなら採用）
  try{
    const url1 = window.EXEC_URL
      + (window.EXEC_URL.indexOf('?')>=0?'&':'?')
      + 'fn=submitFeature&payload=' + encodeURIComponent(JSON.stringify(payload))
      + '&v=' + Date.now();
    const r1 = await fetch(url1, { method:'GET', mode:'cors', cache:'no-store' });
    const ct = r1.headers.get('content-type') || '';
    if (r1.ok && ct.indexOf('application/json') >= 0){
      onOK(await r1.json()); return;
    }
  }catch(_){}

  // 3) POST（text/plain でプリフライト回避）
  try{
    const url2 = window.EXEC_URL + (window.EXEC_URL.indexOf('?')>=0?'&':'?') + 'v=' + Date.now();
    const r2 = await fetch(url2, {
      method:'POST',
      mode:'cors',
      cache:'no-store',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify({ fn:'submitFeature', payload, csrf:(window.__CZ_CSRF||'') })
    });
    if(!r2.ok){ const t = await r2.text().catch(()=> ''); throw new Error('HTTP '+r2.status+' '+t); }
    onOK(await r2.json());
  }catch(err){
    onNG(err);
  }
}
</script>

<script>
(function(){
  // -------- util --------
  function $(q){ return document.querySelector(q); }
  function el(tag, attrs){ var e=document.createElement(tag); if(attrs) Object.assign(e, attrs); return e; }

  // ★追加：短縮URL拒否
  const SHORTENERS_RE = /^(https:\/\/)(bit\.ly|tinyurl\.com|goo\.gl|is\.gd|t\.co|ow\.ly|buff\.ly|rb\.gy)\//i;

  // https 検査 + 短縮拒否
  function isAllowedHttpUrl(u){
    try{ var s=String(u||'').trim(); if(!/^https:\/\//i.test(s)) return false; return !SHORTENERS_RE.test(s); }
    catch(_){ return false; }
  }

  // 画像URL許可（Drive等のホストは緩許可／一般サイトは拡張子必須）
  function isAllowedImageUrl(u){
    if(!u) return true;
    if(!isAllowedHttpUrl(u)) return false;
    try{
      var host = new URL(u).host.toLowerCase();
      var okHosts = [
        'drive.google.com','lh3.googleusercontent.com','images.unsplash.com',
        'i.imgur.com','imgur.com','githubusercontent.com','raw.githubusercontent.com',
        'upload.wikimedia.org','static.wikia.nocookie.net'
      ];
      if(okHosts.some(h=> host===h || host.endsWith('.'+h))) return true;
      return /\.(jpg|jpeg|png|webp|gif)(\?.*)?$/i.test(u);
    }catch(_){ return false; }
  }

  // Drive共有URLを表示用に正規化
  function normalizeDriveUrl(url){
    try{
      if(!url) return '';
      var m = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/); if(m) return 'https://drive.google.com/uc?export=view&id='+m[1];
      m = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);        if(m) return 'https://drive.google.com/uc?export=view&id='+m[1];
      return url;
    }catch(_){ return url; }
  }

  function isYouTubeUrl(u){
    const s = String(u||'').trim();
    if(!/^https:\/\//i.test(s)) return false;
    return /^(https:\/\/(?:www\.)?youtube\.com\/watch\?v=|https:\/\/youtu\.be\/)/i.test(s);
  }

  // -------- state --------
  var els={}, lastVals={};
  var PARA_MAX = 5, IMG_PER = 3; /* ★3→5 に拡張 */
  var blobURLs = [];
  var MAX_BYTES = 10*1024*1024; // 10MB
  var MAX_EDGE  = 3000;         // 長辺3000px
  var NG_TERMS = ["kill","die","rape","suicide","terror","bomb","fuck","cunt","asshole","nazi","kkk","white power","retard","spic","chink","gook","fag"];

  function clearBlobURLs(){ try{ blobURLs.forEach(u=>URL.revokeObjectURL(u)); }catch(_){}
    blobURLs=[]; }

  // client_id
  function getClientId(){
    try{
      var k='chaynupzine_cid';
      var id=localStorage.getItem(k);
      if(!id){
        id = 'cid_'+Math.random().toString(36).slice(2)+Date.now().toString(36);
        localStorage.setItem(k,id);
      }
      return id;
    }catch(_){ return ''; }
  }

  // build paragraph inputs（言語に合わせて文言を生成）
  function buildParas(){
    var lang = (window.__getLang && __getLang()) || 'ja';
    var T = TEXTS[lang].ph;

    var host = $('#paras'); host.innerHTML='';
    for(let i=1;i<=PARA_MAX;i++){
      var box = el('div', {className:'para'});
      var h = el('div');
      var hd = el('span',{className:'num'}); hd.textContent='§'+i+' ';
      var ttl = el('span',{'data-i18n':'para'}); ttl.textContent=T.para;
      h.appendChild(hd); h.appendChild(ttl);
      box.appendChild(h);

      var ta = el('textarea'); ta.id = 'para'+i+'_text'; box.appendChild(ta);

      // image url + upload x3
      for(let j=1;j<=IMG_PER;j++){
        var lab = el('label', {className:'label'});
        var b = el('b', {'data-i18n':'img'}); b.dataset.idx=j; b.textContent=T.img + j;
        lab.appendChild(b);
        lab.appendChild(document.createTextNode('（URL or アップロード）'));
        box.appendChild(lab);

        var row = el('div',{className:'row2'});

        // URL欄
        var url = el('input',{type:'text', id:'p'+i+'_img'+j+'_url', placeholder:'https://drive.google.com/... or https://example.com/...'});
        row.appendChild(url);

        /* ▼▼ 修正ポイント：var を const に変更してハンドラごとに固有参照にする ▼▼ */
        const fileId = 'p'+i+'_img'+j+'_file';
        const file   = el('input',{type:'file', id:fileId, accept:'image/*', className:'hiddenfile'});
        const btn    = el('button', {type:'button', className:'filebtn', 'data-for':fileId, 'aria-controls':fileId, 'aria-label':'画像を選択'});
        btn.textContent = T.choose;
        btn.addEventListener('click', ()=> file.click());
        file.addEventListener('change', (e)=>{
          const P = TEXTS[(window.__getLang&&__getLang())||'ja'].ph;
          const f = e.currentTarget;
          btn.textContent = (f.files && f.files[0]) ? (P.selected + f.files[0].name) : P.choose;
        });
        /* ▲▲ 修正ここまで ▲▲ */

        var fileWrap = el('div');
        fileWrap.appendChild(btn);
        fileWrap.appendChild(file);
        row.appendChild(fileWrap);

        var warn = el('div',{className:'warn', id:'p'+i+'_img'+j+'_warn', style:'display:none'});
        box.appendChild(row); box.appendChild(warn);
      }

      var ylab = el('label',{className:'label'});
      var yb = el('b'); yb.textContent='YouTube';
      ylab.appendChild(yb); ylab.appendChild(document.createTextNode('（任意・URL1本）'));
      var yt = el('input',{type:'text', id:'youtube'+i, 'data-i18n-ph':'yt', placeholder:T.yt});
      box.appendChild(ylab); box.appendChild(yt);

      host.appendChild(box);
    }

    // 直後に UI 文言を現在言語で微調整
    if(window.__setLangUI) __setLangUI(lang);
  }

  function fileToDataURL(file){
    return new Promise(function(resolve,reject){
      if(!file) return resolve('');
      var fr=new FileReader();
      fr.onload=function(e){ resolve(e.target.result); };
      fr.onerror=function(){ reject(new Error('file read error')); };
      fr.readAsDataURL(file);
    });
  }
  async function checkImageLimits(file){
    if(!file) return {ok:true};
    if(file.size > MAX_BYTES) return {ok:false, reason:'ファイルサイズが大きすぎます（10MB超）'};
    try{
      var data = await fileToDataURL(file);
      var img = new Image();
      await new Promise(function(res,rej){
        img.onload=function(){
          var w=img.naturalWidth||img.width, h=img.naturalHeight||img.height;
          if(Math.max(w,h)>MAX_EDGE) rej(new Error('長辺が大きすぎます（3000px超）'));
          else res();
        };
        img.onerror=function(){ rej(new Error('画像の読み込みに失敗しました')); };
        img.src=data;
      });
      return {ok:true, dataUrl:data};
    }catch(e){ return {ok:false, reason:String(e.message||e)}; }
  }

  // refs
  function bindEls(){
    els = {
      genre:$('#genre'), genre_other:$('#genre_other'),
      era:$('#era'),
      regionSel:$('#regionSel'), regionOther:$('#regionOther'),
      title:$('#title'), author:$('#author'), edit_key:$('#edit_key'),
      chipGenre:$('#chipGenre'), chipEra:$('#chipEra'), chipRegion:$('#chipRegion'),
      pvTitle:$('#pvTitle'), pvAuthor:$('#pvAuthor'), pvBody:$('#pvBody'),
      btn:$('#submitBtn'), msg:$('#msg'), genreOtherWrap:$('#genreOtherWrap')
    };
    for(let i=1;i<=PARA_MAX;i++){
      els['para'+i+'_text'] = $('#para'+i+'_text');
      els['youtube'+i] = $('#youtube'+i);
      for(let j=1;j<=IMG_PER;j++){
        els['p'+i+'_img'+j+'_url']  = $('#p'+i+'_img'+j+'_url');
        els['p'+i+'_img'+j+'_file'] = $('#p'+i+'_img'+j+'_file');
        els['p'+i+'_img'+j+'_warn'] = $('#p'+i+'_img'+j+'_warn');
      }
    }
  }

  function getRegionValue(){
    var sel = els.regionSel.value;
    if(sel === '__other') return (els.regionOther.value||'').trim();
    return sel || '';
  }

  // preview
  async function updatePreview(){
    var g = els.genre.value;
    els.chipGenre.textContent = g ? g.replace('venue','VENUE（ライブ会場）') : '';
    els.chipEra.textContent   = els.era.value || '';
    var reg = getRegionValue();
    els.chipRegion.textContent= reg || '';

    els.pvTitle.textContent = els.title.value || '—';
    els.pvAuthor.textContent= els.author.value ? 'by '+els.author.value : '—';

    var wrap = els.pvBody; wrap.innerHTML='';
    clearBlobURLs();
    var hasAny = false;

    for(let i=1;i<=PARA_MAX;i++){
      var text = (els['para'+i+'_text'].value||'').trim();
      var srcs=[];
      for(let j=1;j<=IMG_PER;j++){
        var warnEl = els['p'+i+'_img'+j+'_warn']; if(warnEl){ warnEl.style.display='none'; warnEl.textContent=''; }

        var u = (els['p'+i+'_img'+j+'_url'].value||'').trim();
        if(u){
          if(!isAllowedImageUrl(u)){ if(warnEl){ warnEl.textContent='画像URLは https 必須・短縮URL不可・画像拡張子または許可ドメインのみ'; warnEl.style.display=''; } u=''; }
          else { u = normalizeDriveUrl(u); }
        }
        if(!u){
          var fEl = els['p'+i+'_img'+j+'_file'];
          if(fEl && fEl.files && fEl.files[0]){
            var chk = await checkImageLimits(fEl.files[0]);
            if(chk.ok){
              u = URL.createObjectURL(fEl.files[0]);
              blobURLs.push(u);
            }else{
              if(warnEl){ warnEl.textContent='プレビュー不可：'+chk.reason; warnEl.style.display=''; }
            }
          }
        }
        if(u) srcs.push(u);
      }
      var y = (els['youtube'+i].value||'').trim();
      if(y && !isYouTubeUrl(y)){ y = ''; }

      if(!text && srcs.length===0 && !y) continue;
      hasAny = true;

      var sec = el('div', {className:'para'});
      var p = el('div'); p.textContent = text || '—';
      sec.appendChild(p);

      if(srcs.length){
        var t = el('div', {className:'thumbs'});
        srcs.forEach(function(u){ var img=el('img'); img.src=u; t.appendChild(img); });
        sec.appendChild(t);
      }

      if(y){
        var a = el('a',{href:y,target:'_blank',rel:'noopener','data-i18n':'ytOpen'}); a.textContent = TEXTS[(window.__getLang&&__getLang())||'ja'].ph.ytOpen;
        var yt = el('div',{className:'ytlink'}); yt.appendChild(a);
        sec.appendChild(yt);
      }

      wrap.appendChild(sec);
    }
    if(!hasAny){
      var em = el('div',{id:'pvEmpty',className:'ph'});
      em.textContent = TEXTS[(window.__getLang&&__getLang())||'ja'].ph.pvEmpty;
      wrap.appendChild(em);
    }
  }

  // NGチェック
  function clientNgCheck(){
    try{
      var text = [
        els.author.value,
        els.era.value,
        getRegionValue()
      ].join('\n');

      for(let i=1;i<=PARA_MAX;i++){
        text += '\n' + (els['para'+i+'_text'].value||'');
      }

      var low = text.toLowerCase();
      for(var i=0;i<NG_TERMS.length;i++){
        var w=NG_TERMS[i];
        if(low.indexOf(w)>=0) return 'NGワードに該当する表現が含まれています。表現を言い換えてください。';
      }
      return '';
    }catch(_){ return ''; }
  }

  // bind events
  function bindAll(){
    els.genre.addEventListener('change', function(){
      els.genreOtherWrap.style.display = (els.genre.value==='other') ? '' : 'none';
      updatePreview();
    });

    els.regionSel.addEventListener('change', function(){
      var show = (els.regionSel.value==='__other');
      els.regionOther.style.display = show ? '' : 'none';
      if(!show) els.regionOther.value='';
      updatePreview();
    });
    els.regionOther.addEventListener('input', updatePreview);

    var ids = ['genre','genre_other','era','title','author','edit_key','regionSel','regionOther'];
    for(let i=1;i<=PARA_MAX;i++){
      ids.push('para'+i+'_text','youtube'+i);
      for(let j=1;j<=IMG_PER;j++){ ids.push('p'+i+'_img'+j+'_url'); }
    }
    ids.forEach(function(id){
      var e = $('#'+id); if(!e) return;
      ['input','change','keyup','paste','blur'].forEach(function(ev){ e.addEventListener(ev, updatePreview, false); });
    });

    for(let i=1;i<=PARA_MAX;i++){
      for(let j=1;j<=IMG_PER;j++){
        var f = els['p'+i+'_img'+j+'_file'];
        if(f){ f.addEventListener('change', updatePreview, false); }
      }
    }

    setInterval(function(){
      try{
        var now = {};
        ids.forEach(function(id){ var e=$('#'+id); now[id]=e?e.value:''; });
        var changed = JSON.stringify(now)!==JSON.stringify(lastVals);
        if(changed){ lastVals=now; updatePreview(); }
      }catch(_){}
    }, 700);
  }

  // submit
  function bindSubmit(){
    els.btn.addEventListener('click', async function(){
      els.msg.textContent=''; els.msg.className='msg'; els.btn.disabled=true;

      try{
        if(!document.getElementById('agree').checked){
          throw new Error('免責事項に同意してください');
        }

        if(!(els.title.value||'').trim()){ throw new Error('TITLE は必須です'); }
        if(!(els.genre.value||'').trim()){ throw new Error('GENRE を選択してください'); }
        if(els.genre.value==='other' && !(els.genre_other.value||'').trim()){
          throw new Error('GENRE が OTHER の場合は自由入力も必須です');
        }
        var ek = (els.edit_key.value||'').trim();
        if(!/^[A-Za-z0-9]{8,32}$/.test(ek)){
          throw new Error('編集キーは半角英数字のみ・8〜32文字で入力してください');
        }

        var ng = clientNgCheck();
        if(ng){ throw new Error(ng); }

        for(let i=1;i<=PARA_MAX;i++){
          var yraw = (els['youtube'+i].value||'').trim();
          if(yraw && !isYouTubeUrl(yraw)){
            throw new Error('YouTube URL は https の youtube.com / youtu.be のみ対応です（§'+i+'）');
          }
        }

        var regionVal = getRegionValue();

        var payload = {
          status:'published',
          title:(els.title.value||'').trim(),
          author:(els.author.value||'').trim(),
          genre:(els.genre.value||'').trim(),
          genre_other:(els.genre_other.value||'').trim(),
          era:(els.era.value||'').trim(),
          region: regionVal,
          edit_key: ek,
          client_id: (function(){ try{ return getClientId(); }catch(_){ return ''; } })()
        };

        for(let i=1;i<=PARA_MAX;i++){
          payload['para'+i+'_text'] = (els['para'+i+'_text'].value||'').trim();
          payload['youtube'+i]     = (els['youtube'+i].value||'').trim();

          for(let j=1;j<=IMG_PER;j++){
            var urlEl  = els['p'+i+'_img'+j+'_url'];
            var fileEl = els['p'+i+'_img'+j+'_file'];
            var warnEl = els['p'+i+'_img'+j+'_warn'];

            var rawUrl = (urlEl.value||'').trim();
            if(rawUrl){
              if(!isAllowedImageUrl(rawUrl)){
                if(warnEl){ warnEl.textContent='画像URLは https 必須・短縮URL不可・画像拡張子または許可ドメインのみ'; warnEl.style.display=''; }
                rawUrl = '';
              }else{
                rawUrl = normalizeDriveUrl(rawUrl);
              }
            }
            payload['p'+i+'_img'+j+'_url'] = rawUrl;

            if(!payload['p'+i+'_img'+j+'_url'] && fileEl && fileEl.files && fileEl.files[0]){
              payload['p'+i+'_img'+j+'_data'] = await (function(file){
                return new Promise(function(resolve){
                  var fr=new FileReader();
                  fr.onload=function(e){ resolve(e.target.result); };
                  fr.readAsDataURL(file);
                });
              })(fileEl.files[0]);
            }
          }
        }

        callSubmitFeature(
          payload,
          function(res){
            if(res && res.ok){
              els.msg.className='msg ok';
              els.msg.textContent='Posted!';
              var keep = { genre:els.genre.value, era:els.era.value, regionSel:els.regionSel.value, regionOther:els.regionOther.value, edit_key:els.edit_key.value };
              document.querySelectorAll('input[type=text], textarea').forEach(function(i){ i.value=''; });
              for(let i=1;i<=PARA_MAX;i++){ for(let j=1;j<=IMG_PER;j++){ els['p'+i+'_img'+j+'_file'].value=''; els['p'+i+'_img'+j+'_warn'].style.display='none'; els['p'+i+'_img'+j+'_warn'].textContent=''; } }
              els.genre.value=keep.genre; els.era.value=keep.era; els.regionSel.value=keep.regionSel; els.regionOther.value=keep.regionOther; els.edit_key.value=keep.edit_key;
              els.genreOtherWrap.style.display = (els.genre.value==='other') ? '' : 'none';
              els.regionOther.style.display    = (els.regionSel.value==='__other') ? '' : 'none';
              updatePreview();
            }else{
              // ★追加：サーバーエラーの可読表示
              var msg = (res && res.error) ? String(res.error) : 'server error';
              if(/invalid image_url/i.test(msg)) msg = '画像URLが無効です（https必須／短縮URL不可／画像拡張子または許可ドメイン）';
              if(/invalid edit_key/i.test(msg)) msg = '編集キーが不正です（半角英数字 8〜32）';
              if(/ng word/i.test(msg)) msg = 'NGワードに該当する可能性があります。表現を言い換えてください。';
              throw new Error(msg);
            }
            els.btn.disabled=false;
          },
          function(err){
            els.msg.className='msg err';
            els.msg.textContent='Error: '+(err && err.message ? err.message : String(err));
            els.btn.disabled=false;
          }
        );

      }catch(e){
        els.msg.className='msg err';
        els.msg.textContent='Error: '+e.message;
        els.btn.disabled=false;
      }
    });
  }

  // init
  buildParas();              // ← 言語に応じて段落UIを生成
  bindEls();
  bindAll();
  bindSubmit();
  updatePreview();
})();
</script>
</body>
</html>
